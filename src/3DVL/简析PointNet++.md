---
icon: file
category:
  - 3D-VL
tag:
  - 3D-VL
  - point cloud
  - ç¼–è¾‘ä¸­
footer: æŠ€æœ¯å…±å»ºï¼ŒçŸ¥è¯†å…±äº«
date: 2025-05-25
cover: assets/cover/PointNet++.png
author:
  - BinaryOracle
---

`ç®€æPointNet++` 

<!-- more -->

# ç®€æPointNet++

> è®ºæ–‡: [https://arxiv.org/abs/1706.02413](https://arxiv.org/abs/1706.02413)
> TensorFlow ç‰ˆæœ¬ä»£ç : [https://github.com/charlesq34/pointnet2](https://github.com/charlesq34/pointnet2)
> Pytorch ç‰ˆæœ¬ä»£ç : [https://github.com/yanx27/Pointnet_Pointnet2_pytorch](https://github.com/yanx27/Pointnet_Pointnet2_pytorch)

## èƒŒæ™¯

åœ¨PointNetä¸­ï¼Œç½‘ç»œå¯¹æ¯ä¸€ä¸ªç‚¹åšä½ç»´åˆ°é«˜ç»´çš„æ˜ å°„ï¼Œè¿›è¡Œç‰¹å¾å­¦ä¹ ï¼Œç„¶åæŠŠæ‰€æœ‰ç‚¹æ˜ å°„åˆ°é«˜ç»´çš„ç‰¹å¾é€šè¿‡æœ€å¤§æ± åŒ–æœ€ç»ˆè¡¨ç¤ºå…¨å±€ç‰¹å¾ã€‚ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œè¦ä¹ˆå¯¹ä¸€ä¸ªç‚¹åšæ“ä½œï¼Œè¦ä¹ˆå¯¹æ‰€æœ‰ç‚¹åšæ“ä½œï¼Œå®é™…ä¸Šæ²¡æœ‰**å±€éƒ¨çš„æ¦‚å¿µ(loal context)** ã€‚åŒæ—¶ç¼ºå°‘ local context åœ¨**å¹³ç§»ä¸å˜æ€§**ä¸Šä¹Ÿæœ‰å±€é™æ€§ï¼ˆä¸–ç•Œåæ ‡ç³»å’Œå±€éƒ¨åæ ‡ç³»ï¼‰ã€‚å¯¹ç‚¹äº‘æ•°æ®åšå¹³ç§»æ“ä½œåï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å°†å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´æ‰€æœ‰çš„ç‰¹å¾ï¼Œå…¨å±€ç‰¹å¾éƒ½ä¸ä¸€æ ·äº†ã€‚å¯¹äºå•ä¸ªçš„ç‰©ä½“è¿˜å¥½ï¼Œå¯ä»¥å°†å…¶å¹³ç§»åˆ°åæ ‡ç³»çš„ä¸­å¿ƒï¼ŒæŠŠä»–çš„å¤§å°å½’ä¸€åŒ–åˆ°ä¸€ä¸ªçƒä¸­ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªåœºæ™¯ä¸­æœ‰å¤šä¸ªç‰©ä½“æ—¶åˆ™ä¸å¥½åŠï¼Œéœ€è¦å¯¹å“ªä¸ªç‰©ä½“åšå½’ä¸€åŒ–å‘¢ï¼Ÿ

PointNet++ è§£å†³äº†ä¸¤ä¸ªé—®é¢˜ï¼šå¦‚ä½•ç”Ÿæˆç‚¹é›†çš„åˆ’åˆ†ï¼ˆPartitioningï¼‰ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡å±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨ï¼ˆLocal Feature Learnerï¼‰æŠ½è±¡ç‚¹é›†æˆ–å±€éƒ¨ç‰¹å¾ã€‚

**ç”Ÿæˆç‚¹é›†çš„åˆ’åˆ†ï¼ˆPartitioningï¼‰ï¼š**

ç‚¹é›†åˆ’åˆ†æ˜¯æŒ‡å¦‚ä½•å°†ä¸€ä¸ªå¤§çš„ç‚¹äº‘åˆ†å‰²æˆæ›´å°çš„ã€æ›´æ˜“äºç®¡ç†çš„å­é›†ã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºåœ¨ä¼ ç»Ÿçš„å·ç§¯ç¥ç»ç½‘ç»œä¸­å¦‚ä½•å¤„ç†å›¾åƒçš„å°åŒºåŸŸï¼ˆæˆ–â€œpatchesâ€ï¼‰ï¼Œä»¥ä¾¿å¯ä»¥åœ¨è¿™äº›åŒºåŸŸä¸Šåº”ç”¨å±€éƒ¨æ“ä½œã€‚PointNet++éœ€è¦ä¸€ç§æ–¹æ³•æ¥æœ‰æ•ˆåœ°å°†ç‚¹äº‘åˆ†å‰²æˆå¤šä¸ªéƒ¨åˆ†ï¼Œè¿™æ ·å¯ä»¥åœ¨æ¯ä¸ªéƒ¨åˆ†ä¸Šç‹¬ç«‹åœ°å­¦ä¹ ç‰¹å¾ã€‚

**é€šè¿‡å±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨ï¼ˆLocal Feature Learnerï¼‰æŠ½è±¡ç‚¹é›†æˆ–å±€éƒ¨ç‰¹å¾ï¼š**

ä¸€æ—¦ç‚¹äº‘è¢«åˆ’åˆ†æˆå°çš„å­é›†ï¼ŒPointNet++çš„ä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¯å­¦ä¹ è¿™äº›å­é›†ï¼ˆæˆ–å±€éƒ¨åŒºåŸŸï¼‰çš„ç‰¹å¾ã€‚è¿™éœ€è¦ä¸€ä¸ªâ€œå±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨â€ï¼Œå®ƒèƒ½å¤Ÿä»æ¯ä¸ªå­é›†ä¸­æå–æœ‰ç”¨çš„ä¿¡æ¯æˆ–ç‰¹å¾ã€‚è¿™ä¸åœ¨ä¼ ç»ŸCNNä¸­å­¦ä¹ å›¾åƒå±€éƒ¨åŒºåŸŸç‰¹å¾çš„è¿‡ç¨‹ç›¸ä¼¼ã€‚

**ä¸¤ä¸ªé—®é¢˜æ˜¯ç›¸å…³è”çš„ï¼Œå› ä¸ºï¼š**

ç‚¹é›†çš„åˆ’åˆ†å¿…é¡»äº§ç”Ÿè·¨åˆ†åŒºçš„å…±åŒç»“æ„ï¼šä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„å±€éƒ¨å­é›†ä¸Šå…±äº«æƒé‡ï¼ˆç±»ä¼¼äºåœ¨CNNä¸­æƒé‡å…±äº«çš„æ¦‚å¿µï¼‰ï¼ŒPointNet++åœ¨è¿›è¡Œç‚¹é›†åˆ’åˆ†æ—¶ï¼Œéœ€è¦ç¡®ä¿è¿™äº›åˆ’åˆ†å…·æœ‰ä¸€å®šçš„ä¸€è‡´æ€§æˆ–å…±åŒç»“æ„ã€‚è¿™æ„å‘³ç€å³ä½¿æ˜¯ä¸åŒçš„å±€éƒ¨å­é›†ï¼Œä¹Ÿåº”è¯¥ä»¥ä¸€ç§æ–¹å¼è¢«å¤„ç†ï¼Œä½¿å¾—åœ¨å®ƒä»¬ä¹‹é—´å¯ä»¥å…±äº«å­¦ä¹ åˆ°çš„ç‰¹å¾è¡¨ç¤ºçš„æƒé‡ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯æé«˜æ¨¡å‹çš„æ•ˆç‡å’Œæ³›åŒ–èƒ½åŠ›ï¼Œå› ä¸ºå­¦ä¹ åˆ°çš„ç‰¹å¾å’Œæƒé‡å¯ä»¥åœ¨å¤šä¸ªå±€éƒ¨åŒºåŸŸä¸­å¤ç”¨ã€‚

ä¸Šè¿°å³ä¸ºPointNet++è®¾è®¡ä¸­çš„ä¸¤ä¸ªæ ¸å¿ƒæŒ‘æˆ˜ï¼š
- å¦‚ä½•æœ‰æ•ˆåœ°å¯¹ç‚¹äº‘è¿›è¡Œåˆ†åŒºï¼Œä»¥ä¾¿å¯ä»¥åœ¨è¿™äº›åˆ†åŒºä¸Šç‹¬ç«‹åœ°å­¦ä¹ ç‰¹å¾ã€‚
- å¦‚ä½•è®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿä»è¿™äº›å±€éƒ¨åˆ†åŒºä¸­å­¦ä¹ æœ‰ç”¨ç‰¹å¾çš„æœºåˆ¶ï¼ŒåŒæ—¶ç¡®ä¿è¿™äº›åˆ†åŒºçš„å¤„ç†æ–¹å¼å…è®¸åœ¨å®ƒä»¬ä¹‹é—´å…±äº«æ¨¡å‹æƒé‡ã€‚
  - ä¸ºäº†æ¨¡ä»¿ä¼ ç»Ÿå·ç§¯ç½‘ç»œä¸­çš„æƒé‡å…±äº«æœºåˆ¶ä»¥æé«˜å­¦ä¹ æ•ˆç‡å’Œæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚

PointNet++é€‰æ‹©PointNetä½œä¸ºå±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨ï¼ˆå®ƒæ˜¯æ— åºç‚¹äº‘æ•°æ®ç‰¹å¾æå–çš„é«˜æ•ˆç®—æ³•ï¼‰ã€‚

> å¯ä»¥ç†è§£ä¸ºï¼šPointNet++åº”ç”¨PointNeté€’å½’åœ°å¯¹è¾“å…¥é›†è¿›è¡ŒåµŒå¥—åˆ†åŒºã€‚

## æ¨¡å‹ç»“æ„

![ä»¥äºŒç»´æ¬§å‡ é‡Œå¾—ç©ºé—´ä¸ºä¾‹ï¼Œç½‘ç»œçš„åˆ†å‰²å’Œåˆ†ç±»æ¨¡å‹](ç®€æPointNet++/1.png)

ç½‘ç»œçš„æ¯ä¸€ç»„set abstraction layersä¸»è¦åŒ…æ‹¬3ä¸ªéƒ¨åˆ†ï¼š

- Sample layer : å¯¹è¾“å…¥ç‚¹è¿›è¡Œé‡‡æ ·ï¼Œåœ¨è¿™äº›ç‚¹ä¸­é€‰å‡ºè‹¥å¹²ä¸ªä¸­å¿ƒç‚¹ã€‚

- Grouping layer : åˆ©ç”¨ä¸Šä¸€æ­¥å¾—åˆ°çš„ä¸­å¿ƒç‚¹å°†ç‚¹é›†åˆ’åˆ†æˆè‹¥å¹²ä¸ªåŒºåŸŸã€‚

- PointNet layer : å¯¹ä¸Šè¿°å¾—åˆ°çš„æ¯ä¸ªåŒºåŸŸè¿›è¡Œç¼–ç ï¼Œå˜æˆç‰¹å¾å‘é‡ã€‚

### å±‚æ¬¡åŒ–ç‚¹é›†ç‰¹å¾å­¦ä¹ 

å±‚æ¬¡åŒ–ç»“æ„ç”±å¤šä¸ªset abstraction layersç»„æˆï¼Œåœ¨æ¯ä¸ªå±‚ä¸Šï¼Œä¸€ç»„ç‚¹äº‘è¢«å¤„ç†å’ŒæŠ½è±¡ï¼Œä»¥äº§ç”Ÿä¸€ä¸ªæ›´å°‘å…ƒç´ çš„æ–°é›†åˆã€‚set abstraction layers ç”± Sampling layerã€Grouping layer å’Œ PointNet layer ä¸‰éƒ¨åˆ†ç»„æˆã€‚

- Sampling layer ï¼šé‡‡æ ·å±‚ ä»è¾“å…¥ç‚¹ä¸­é€‰å–ä¸€ç»„ç‚¹ï¼Œå®šä¹‰å±€éƒ¨åŒºåŸŸçš„å½¢å¿ƒã€‚

- Grouping layer ï¼šé€šè¿‡æŸ¥æ‰¾å½¢å¿ƒç‚¹å‘¨å›´çš„â€œé‚»è¿‘ç‚¹â€æ¥æ„å»ºå±€éƒ¨åŒºåŸŸç‚¹é›†ã€‚

- PointNet layer ï¼šä½¿ç”¨mini-PointNetå°†å±€éƒ¨åŒºåŸŸç¼–ç ä¸ºç‰¹å¾å‘é‡ã€‚

#### Sampling layer

ä½¿ç”¨farthest point samplingï¼ˆFPSï¼‰é€‰æ‹©ğ‘ä¸ªç‚¹ï¼ˆç›¸æ¯”äºéšæœºé‡‡æ ·ï¼Œè¯¥æ–¹æ³•èƒ½æ›´å¥½çš„è¦†ç›–æ•´ä¸ªç‚¹é›†ï¼Œå…·ä½“é€‰æ‹©å¤šå°‘ä¸ªä¸­å¿ƒç‚¹ä»¥åŠé‚»åŸŸå†…çš„æ•°é‡ç”±è¶…å‚æ•°ç¡®å®šï¼‰

FPSæ˜¯ä¸€ç§åœ¨ç‚¹äº‘ã€å›¾åƒå¤„ç†æˆ–å…¶ä»–æ•°æ®é›†ä¸­ç”¨äºæŠ½æ ·çš„ç®—æ³•ã€‚ç›®çš„æ˜¯ä»ä¸€ä¸ªå¤§çš„æ•°æ®é›†ä¸­é€‰å‡ºä¸€ç»„ä»£è¡¨æ€§å¼ºçš„ç‚¹ï¼Œè¿™äº›ç‚¹å½¼æ­¤ä¹‹é—´çš„æœ€å°è·ç¦»å°½å¯èƒ½å¤§ã€‚

ä½œè€…é€šè¿‡FPSæ¥æŠ½æ ·ç‚¹é›†ä¸­è¾ƒä¸ºé‡è¦çš„ç‚¹ã€‚ï¼ˆå³ä»»åŠ¡æ˜¯æ‰¾åˆ°ç‚¹äº‘é›†ä¸­çš„å±€éƒ¨åŒºåŸŸçš„ä¸­å¿ƒç‚¹ï¼‰

> å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼šè®¡ç®—æˆæœ¬ã€æ ·æœ¬åˆ†å¸ƒåå·®ï¼ˆå¯èƒ½å¯¼è‡´æ ·æœ¬åœ¨é«˜å¯†åº¦åŒºåŸŸå†…è¿‡åº¦é›†ä¸­ï¼Œä½å¯†åº¦åŒºåŸŸåˆ™è¿‡äºç¨€ç¼ºï¼‰ã€å‚æ•°ä¾èµ–ï¼ˆä¾èµ–åˆå§‹ç‚¹å’Œè·ç¦»åº¦é‡æ–¹å¼çš„é€‰æ‹©ï¼‰ã€å¯èƒ½æ— æ³•æ•æ‰é‡è¦çš„å‡ ä½•ç»†èŠ‚ã€‚

#### Grouping layer

æ–‡ä¸­ä½œè€…é€šè¿‡Ball queryæ¥æŸ¥è¯¢å½¢å¿ƒçš„é‚»å±…ç‚¹ã€‚

å…·ä½“åšæ³•ï¼šç»™å®šä¸¤ä¸ªè¶…å‚æ•°ï¼ˆæ¯ä¸ªåŒºåŸŸä¸­ç‚¹çš„æ•°é‡ğ¾å’Œqueryçš„åŠå¾„ğ‘Ÿï¼‰ï¼Œå¯¹äºæŸä¸ªå½¢å¿ƒï¼ŒBall queryæ‰¾åˆ°è¯¥æŸ¥è¯¢ç‚¹åœ¨åŠå¾„ä¸ºğ‘ŸèŒƒå›´å†…ç‚¹ï¼Œè¯¥èŒƒå›´ç¡®ä¿å±€éƒ¨åŒºåŸŸçš„å°ºåº¦æ˜¯å›ºå®šçš„ã€‚

ä¸Kæœ€è¿‘é‚»ï¼ˆkNNï¼‰æŸ¥è¯¢ç›¸æ¯”ï¼ŒBall queryé€šè¿‡å›ºå®šåŒºåŸŸå°ºåº¦è€Œä¸æ˜¯å›ºå®šé‚»å±…æ•°é‡æ¥å®šä¹‰é‚»åŸŸã€‚kNNæŸ¥è¯¢å¯»æ‰¾æœ€è¿‘çš„Kä¸ªé‚»å±…ï¼Œä½†è¿™å¯èƒ½å¯¼è‡´æ‰€é€‰é‚»åŸŸçš„å®é™…å°ºå¯¸éšç‚¹çš„å¯†åº¦å˜åŒ–è€Œå˜åŒ–ï¼Œè¿™åœ¨å¤„ç†éå‡åŒ€é‡‡æ ·çš„æ•°æ®æ—¶å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„é€‰æ‹©ã€‚ç›¸åï¼ŒBall queryé€šè¿‡ç¡®ä¿æ¯ä¸ªå±€éƒ¨åŒºåŸŸéƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„å°ºåº¦ï¼Œæé«˜äº†æ¨¡å‹åœ¨ç©ºé—´ä¸Šçš„æ³›åŒ–èƒ½åŠ›ã€‚åœ¨å®ç°æ—¶ï¼Œé€šå¸¸ä¼šè®¾ç½®ä¸€ä¸ªä¸Šé™Kï¼Œä»¥é™åˆ¶æ¯ä¸ªå±€éƒ¨åŒºåŸŸä¸­è€ƒè™‘çš„ç‚¹çš„æ•°é‡ï¼Œä»¥ä¿æŒè®¡ç®—çš„å¯ç®¡ç†æ€§ã€‚

> **å¯æ”¹è¿›çš„åœ°æ–¹**ï¼šå¯¹ç‚¹äº‘å¯†åº¦å˜æ¢è¾ƒä¸ºæ•æ„Ÿã€å¯¹å‚æ•°é€‰æ‹©ä¾èµ–æ€§é«˜ï¼ˆåŠå¾„å¤ªå°å¯èƒ½æ— æ³•æœ‰æ•ˆæ•è·è¶³å¤Ÿçš„å±€éƒ¨è¯¦ç»†ï¼Œå¤ªå¤§åˆ™å¯èƒ½å¯¼è‡´ä¸ç›¸å…³çš„ç‚¹å¢å¤šï¼Œä½¿å±€éƒ¨ç‰¹å¾çš„è¡¨ç¤ºä¸å¤Ÿç²¾ç¡®ï¼‰ã€è®¡ç®—æ•ˆç‡é—®é¢˜ã€å‡åŒ€æ€§å‡è®¾ï¼ˆBall queryæ˜¯åŸºäºæ¬§æ°è·ç¦»çš„å‡åŒ€æ€§å‡è®¾ï¼‰
> - æ¬§å¼è·ç¦»çš„å‡åŒ€æ€§å‡è®¾ï¼šå³åœ¨æ¬§æ°ç©ºé—´ä¸­ï¼Œä¸¤ç‚¹çš„è·ç¦»åæ˜ äº†è¿™ä¸¤ç‚¹çš„å®é™…ç›¸ä¼¼åº¦æˆ–å…³è”åº¦ã€‚
> - åŸºäºä»¥ä¸‹å‰æï¼š
>    - ç©ºé—´å‡åŒ€æ€§ï¼šç©ºé—´æ˜¯å‡åŒ€å’Œå„å‘åŒæ€§çš„ï¼Œå³ä»»ä½•æ–¹å‘ä¸Šçš„åº¦é‡éƒ½æ˜¯ç­‰ä»·çš„ï¼Œè·ç¦»çš„åº¦é‡ä¸å—ç©ºé—´ä¸­ä½ç½®çš„å½±å“ã€‚
>    - è·ç¦»ç›´è§‚æ€§ï¼šåœ¨å±‹é‡Œç©ºé—´æˆ–æŸäº›ç‰¹å®šçš„æŠ½è±¡ç©ºé—´ä¸­ï¼Œä¸¤ä¸ªç‚¹ä¹‹é—´çš„ç›´çº¿è·ç¦»è¢«è®¤ä¸ºæ˜¯ç›¸ä¼¼åº¦æˆ–è¿æ¥å¼ºåº¦çš„ç›´è§‚è¡¨ç¤ºã€‚
>    - è§„æ¨¡ä¸€è‡´æ€§ï¼šå‡è®¾ç©ºé—´ä¸­æ‰€æœ‰åŒºåŸŸçš„å°ºåº¦æˆ–ç‰¹å¾åˆ†å¸ƒå…·æœ‰ä¸€å®šçš„ä¸€è‡´æ€§ï¼Œå³ç©ºé—´ä¸­çš„ä»»ä½•è·ç¦»å€¼å…·æœ‰ç›¸ä¼¼çš„å«ä¹‰ã€‚

æ€»ç»“: Grouping layerçš„ä»»åŠ¡æ˜¯é€šè¿‡ä¸­å¿ƒç‚¹æ‰¾åˆ°é‚»å±…ç‚¹ï¼Œå¹¶å°†å®ƒä»¬ç»„ç»‡ç§°ä¸ºå±€éƒ¨åŒºåŸŸé›†ã€‚

#### PointNet layer

å±€éƒ¨åæ ‡ç³»è½¬æ¢ï¼šå±€éƒ¨åŒºåŸŸä¸­çš„ç‚¹è½¬æ¢æˆç›¸å¯¹äºå½¢å¿ƒçš„å±€éƒ¨åæ ‡ç³»ã€‚ 

> å±€éƒ¨åŒºåŸŸä¸­çš„æ¯ä¸ªç‚¹å°†ç›¸å¯¹äºå½¢å¿ƒæ‰€åœ¨ä½ç½®è¿›è¡Œè°ƒæ•´ï¼Œä»¥åæ˜ å…¶ç›¸å¯¹ä½ç½®ã€‚

å®ç°æ–¹æ³•ï¼šé€šè¿‡å°†å±€éƒ¨åŒºåŸŸä¸­çš„æ¯ä¸ªç‚¹-å½¢å¿ƒç‚¹çš„åæ ‡æ¥å®ç°ã€‚

ç‰¹å¾ç¼–ç ï¼šå°†è½¬æ¢åçš„åæ ‡ä»¥åŠç‚¹çš„é™„åŠ ç‰¹å¾ï¼ˆæ–‡ä¸­çš„ğ¶æ‰€è¡¨ç¤ºçš„å…¶ä»–ä¿¡æ¯ï¼‰ä¸€èµ·é€å…¥mini-PointNetæ¥æå–å±€éƒ¨åŒºåŸŸä¸­çš„ç‰¹å¾ã€‚

è¾“å‡ºï¼šåˆ©ç”¨ç›¸å¯¹åæ ‡ä¸ç‚¹ç‰¹å¾ç›¸ç»“åˆçš„æ–¹å¼å¯ä»¥æ•è·å±€éƒ¨åŒºåŸŸä¸­ç‚¹ä¸ç‚¹ä¹‹é—´çš„å…³ç³»ã€‚

#### ä»£ç å®ç°

PointNetSetAbstractionï¼ˆç‚¹é›†æŠ½è±¡å±‚ï¼‰ æ˜¯ PointNet++ ä¸­çš„æ ¸å¿ƒæ¨¡å— ï¼Œ å®ƒçš„ä½œç”¨æ˜¯è´Ÿè´£ä»è¾“å…¥çš„ç‚¹äº‘æ•°æ®ä¸­é‡‡æ ·å…³é”®ç‚¹ï¼Œæ„å»ºå®ƒä»¬çš„å±€éƒ¨é‚»åŸŸåŒºåŸŸï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå°å‹ PointNet æå–è¿™äº›åŒºåŸŸçš„é«˜ç»´ç‰¹å¾ï¼Œä»è€Œå®ç°ç‚¹äº‘çš„åˆ†å±‚ç‰¹å¾å­¦ä¹ ã€‚

```python
class PointNetSetAbstraction(nn.Module):
    def __init__(self, npoint, radius, nsample, in_channel, mlp, group_all):
        super(PointNetSetAbstraction, self).__init__()
        self.npoint = npoint # é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        self.radius = radius # æ„å»ºå±€éƒ¨é‚»åŸŸçš„åŠå¾„
        self.nsample = nsample # æ¯ä¸ªé‚»åŸŸå†…é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        self.mlp_convs = nn.ModuleList()
        self.mlp_bns = nn.ModuleList()
        last_channel = in_channel # è¾“å…¥ç‚¹çš„ç‰¹å¾ç»´åº¦
        for out_channel in mlp:
            self.mlp_convs.append(nn.Conv2d(last_channel, out_channel, 1))
            self.mlp_bns.append(nn.BatchNorm2d(out_channel))
            last_channel = out_channel
        self.group_all = group_all

    def forward(self, xyz, points):
        """
        Input:
            xyz: input points position data, [B, C, N]
            points: input points data, [B, D, N]
        Return:
            new_xyz: sampled points position data, [B, C, S]
            new_points_concat: sample points feature data, [B, D', S]
        """
        xyz = xyz.permute(0, 2, 1) # [B, N, C]
        if points is not None:
            points = points.permute(0, 2, 1)

        # å¦‚æœ group_all=Trueï¼Œåˆ™å¯¹æ•´ä¸ªç‚¹äº‘åšå…¨å±€ç‰¹å¾æå–ã€‚
        if self.group_all:
            new_xyz, new_points = sample_and_group_all(xyz, points)
        else:  
        # å¦åˆ™ä½¿ç”¨ FPSï¼ˆæœ€è¿œç‚¹é‡‡æ ·ï¼‰é€‰å…³é”®ç‚¹ï¼Œå†ç”¨ Ball Query æ‰¾å‡ºæ¯ä¸ªç‚¹çš„å±€éƒ¨é‚»è¿‘ç‚¹ã€‚    
            # å‚æ•°: è´¨ç‚¹æ•°é‡ï¼Œé‡‡æ ·åŠå¾„ï¼Œé‡‡æ ·ç‚¹æ•°é‡ï¼Œç‚¹åæ ‡ï¼Œç‚¹é¢å¤–ç‰¹å¾
            new_xyz, new_points = sample_and_group(self.npoint, self.radius, self.nsample, xyz, points)
        # å±€éƒ¨ç‰¹å¾ç¼–ç ï¼ˆMini-PointNetï¼‰    
        # new_xyz: sampled points position data, [B, npoint, C]
        # new_points: sampled points data, [B, npoint, nsample, C+D]
        # æŠŠé‚»åŸŸç‚¹çš„æ•°æ®æ•´ç†æˆé€‚åˆå·ç§¯çš„æ ¼å¼ [B, C+D, nsample, npoint]
        new_points = new_points.permute(0, 3, 2, 1)
        # ä½¿ç”¨å¤šä¸ª Conv2d + BatchNorm + ReLU å±‚æå–ç‰¹å¾
        for i, conv in enumerate(self.mlp_convs):
            bn = self.mlp_bns[i]
            new_points =  F.relu(bn(conv(new_points))) # [B, out_channel , nsample, npoint]
        
        # å¯¹æ¯ä¸ªå±€éƒ¨åŒºåŸŸå†…æ‰€æœ‰ç‚¹çš„æœ€å¤§å“åº”å€¼è¿›è¡Œæ± åŒ–ï¼Œå¾—åˆ°è¯¥åŒºåŸŸçš„å›ºå®šé•¿åº¦ç‰¹å¾è¡¨ç¤ºã€‚
        # åœ¨ new_points çš„ç¬¬ 2 ä¸ªç»´åº¦ï¼ˆå³æ¯ä¸ªå±€éƒ¨é‚»åŸŸå†…çš„ç‚¹æ•°é‡ç»´åº¦ï¼‰ä¸Šåšæœ€å¤§æ± åŒ–ï¼ˆmax poolingï¼‰ã€‚
        # è¾“å‡ºå½¢çŠ¶ä¸º [B, out_channel, nsample]ï¼Œå³æ¯ä¸ªæŸ¥è¯¢ç‚¹æœ‰ä¸€ä¸ªç‰¹å¾å‘é‡ã€‚
        new_points = torch.max(new_points, 2)[0]
        new_xyz = new_xyz.permute(0, 2, 1) # [B, C, npoint]
        return new_xyz, new_points # æŸ¥è¯¢ç‚¹çš„ä½ç½®(è´¨å¿ƒ) ï¼Œ æ¯ä¸ªæŸ¥è¯¢ç‚¹ç‚¹å±€éƒ¨ç‰¹å¾ã€‚
```

sample_and_group è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä»è¾“å…¥ç‚¹äº‘ä¸­ï¼š
- é‡‡æ ·ä¸€äº›å…³é”®ç‚¹
- ä¸ºæ¯ä¸ªå…³é”®ç‚¹æ„å»ºå±€éƒ¨é‚»åŸŸï¼ˆå±€éƒ¨åŒºåŸŸï¼‰
- æå–è¿™äº›å±€éƒ¨åŒºåŸŸä¸­çš„ç‚¹åŠå…¶ç‰¹å¾

```python
def sample_and_group(npoint, radius, nsample, xyz, points, returnfps=False):
    """
    Input:
        npoint: é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        radius: æ„å»ºå±€éƒ¨é‚»åŸŸçš„åŠå¾„
        nsample: æ¯ä¸ªé‚»åŸŸå†…é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        xyz: ç‚¹äº‘åæ ‡æ•°æ® , [B, N, 3]
        points: ç‚¹çš„ç‰¹å¾æ•°æ®ï¼ˆå¯é€‰ï¼‰, [B, N, D]
    Return:
        new_xyz: é‡‡æ ·å¾—åˆ°çš„å…³é”®ç‚¹åæ ‡, [B, npoint, nsample, 3]
        new_points: æ¯ä¸ªå…³é”®ç‚¹å¯¹åº”çš„å±€éƒ¨åŒºåŸŸç‚¹å’Œç‰¹å¾, [B, npoint, nsample, 3+D]
    """
    B, N, C = xyz.shape
    S = npoint
    # ä½¿ç”¨ æœ€è¿œç‚¹é‡‡æ ·ï¼ˆFPSï¼‰ ä»åŸå§‹ç‚¹äº‘ä¸­é€‰å‡º npoint ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„ç‚¹ã€‚
    fps_idx = farthest_point_sample(xyz, npoint) # [B, npoint]
    new_xyz = index_points(xyz, fps_idx) # [B, npoint, 3]
    # å¯¹äºæ¯ä¸ªé€‰ä¸­çš„å…³é”®ç‚¹ï¼Œä½¿ç”¨ çƒæŸ¥è¯¢ï¼ˆBall Queryï¼‰ æ‰¾å‡ºå®ƒå‘¨å›´è·ç¦»å°äº radius çš„æ‰€æœ‰é‚»è¿‘ç‚¹ã€‚
    # æœ€å¤šä¿ç•™ nsample ä¸ªç‚¹ï¼Œå¦‚æœä¸å¤Ÿå°±é‡å¤æœ€è¿‘çš„ç‚¹æ¥å¡«å……ã€‚
    idx = query_ball_point(radius, nsample, xyz, new_xyz)
    # æŠŠåˆšæ‰æ‰¾åˆ°çš„é‚»è¿‘ç‚¹çš„åæ ‡æå–å‡ºæ¥ã€‚
    grouped_xyz = index_points(xyz, idx) # [B, npoint, nsample, 3]
    # æŠŠå®ƒä»¬ç›¸å¯¹äºå…³é”®ç‚¹çš„ä½ç½®è¿›è¡Œå½’ä¸€åŒ–ï¼ˆå¹³ç§»ä¸­å¿ƒåˆ°ä»¥å…³é”®ç‚¹ä¸ºåŸç‚¹çš„å±€éƒ¨åæ ‡ç³»ä¸Šï¼‰ã€‚
    grouped_xyz_norm = grouped_xyz - new_xyz.view(B, S, 1, C) # [B, npoint, nsample, 3]

    # å¦‚æœæœ‰é¢å¤–çš„ç‚¹ç‰¹å¾ï¼ˆæ¯”å¦‚é¢œè‰²ã€æ³•çº¿ç­‰ï¼‰ï¼Œä¹Ÿä¸€å¹¶æå–ã€‚ 
    if points is not None:
        grouped_points = index_points(points, idx)
        # æŠŠé‚»è¿‘ç‚¹çš„åæ ‡å’Œç‰¹å¾æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆçš„å±€éƒ¨åŒºåŸŸè¡¨ç¤ºã€‚
        new_points = torch.cat([grouped_xyz_norm, grouped_points], dim=-1) # [B, npoint, nsample, C+D]
    else:
        new_points = grouped_xyz_norm

    if returnfps:
        return new_xyz, new_points, grouped_xyz, fps_idx
    else:
        return new_xyz, new_points
```

farthest_point_sample è¿™ä¸ªå‡½æ•°å®ç°çš„æ˜¯æœ€è¿œç‚¹é‡‡æ ·ï¼ˆFarthest Point Sampling, FPSï¼‰, è¿™æ˜¯ PointNet++ ä¸­ç”¨äºä»ç‚¹äº‘ä¸­é€‰æ‹©å…·æœ‰ä»£è¡¨æ€§çš„é‡‡æ ·ç‚¹çš„ä¸€ç§ç­–ç•¥ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**åœ¨ç‚¹äº‘ä¸­é€æ­¥é€‰æ‹©ç¦»å·²é€‰ç‚¹å°½å¯èƒ½è¿œçš„ç‚¹ï¼Œä½¿å¾—é‡‡æ ·ç‚¹åœ¨æ•´ä¸ªç‚¹äº‘ç©ºé—´ä¸­åˆ†å¸ƒå°½å¯èƒ½å‡åŒ€** ã€‚

```python
def farthest_point_sample(xyz, npoint):
    """
    Input:
        xyz: pointcloud data, [B, N, 3]
        npoint: number of samples
    Return:
        centroids: sampled pointcloud index, [B, npoint]
    """
    device = xyz.device
    B, N, C = xyz.shape
    centroids = torch.zeros(B, npoint, dtype=torch.long).to(device) # å­˜å‚¨æ¯æ¬¡é€‰å‡ºçš„â€œæœ€è¿œç‚¹â€çš„ç´¢å¼•ã€‚
    distance = torch.ones(B, N).to(device) * 1e10 # æ¯ä¸ªç‚¹åˆ°å½“å‰æ‰€æœ‰å·²é€‰ä¸­å¿ƒç‚¹çš„æœ€å°è·ç¦»ï¼Œåˆå§‹è®¾ä¸ºä¸€ä¸ªæå¤§å€¼ï¼ˆ1e10ï¼‰ã€‚
    farthest = torch.randint(0, N, (B,), dtype=torch.long).to(device) # åˆå§‹æ—¶éšæœºé€‰æ‹©ä¸€ä¸ªç‚¹ä½œä¸ºç¬¬ä¸€ä¸ªä¸­å¿ƒç‚¹ã€‚
    batch_indices = torch.arange(B, dtype=torch.long).to(device) # æ‰¹æ¬¡ç´¢å¼•ï¼Œç”¨äºå¿«é€Ÿè®¿é—®æ¯ä¸ª batch çš„ç‚¹ã€‚
    # é‡å¤ npoint æ¬¡ï¼Œæœ€ç»ˆå¾—åˆ° npoint ä¸ªåˆ†å¸ƒå°½å¯èƒ½å‡åŒ€çš„é‡‡æ ·ç‚¹ç´¢å¼•ã€‚
    for i in range(npoint):
        # å°†å½“å‰é€‰ä¸­çš„â€œæœ€è¿œç‚¹â€ç´¢å¼•ä¿å­˜ä¸‹æ¥ï¼›
        centroids[:, i] = farthest # ï¼ˆbatch,npoint)
        # å–å‡ºå½“å‰æœ€è¿œç‚¹çš„åæ ‡ï¼Œç”¨äºåç»­è®¡ç®—å…¶ä»–ç‚¹åˆ°è¯¥ç‚¹çš„è·ç¦»; 
        centroid = xyz[batch_indices, farthest, :].view(B, 1, 3) # # ï¼ˆbatch, 1 , 3)
        # è®¡ç®—å½“å‰ä¸­å¿ƒç‚¹ä¸æ‰€æœ‰ç‚¹ä¹‹é—´çš„æ¬§æ°è·ç¦»å¹³æ–¹ã€‚
        dist = torch.sum((xyz - centroid) ** 2, -1) # ï¼ˆbatch,npoint)
        # å¦‚æœæŸä¸ªç‚¹åˆ°æ–°ä¸­å¿ƒç‚¹çš„è·ç¦»æ¯”ä¹‹å‰è®°å½•çš„â€œæœ€å°è·ç¦»â€è¿˜å°ï¼Œå°±æ›´æ–°å®ƒã€‚
        mask = dist < distance
        # åœ¨ distance ä¸­æ‰¾åˆ°æœ€å¤§çš„é‚£ä¸ªè·ç¦»å¯¹åº”çš„ç‚¹ï¼Œè¿™å°±æ˜¯ä¸‹ä¸€ä¸ªâ€œæœ€è¿œç‚¹â€ã€‚
        distance[mask] = dist[mask]   # ï¼ˆbatch,npoint)
        # åœ¨ distance ä¸­æ‰¾åˆ°æœ€å¤§çš„é‚£ä¸ªè·ç¦»å¯¹åº”çš„ç‚¹ï¼Œè¿™å°±æ˜¯ä¸‹ä¸€ä¸ªâ€œæœ€è¿œç‚¹â€ã€‚
        # è¿”å›ï¼šä¸€ä¸ªå…ƒç»„ï¼š(values, indices)ï¼Œåˆ†åˆ«æ˜¯æœ€å¤§å€¼å’Œå®ƒä»¬çš„ä½ç½®ç´¢å¼•ã€‚
        farthest = torch.max(distance, -1)[1] # è¿”å›ä½ç½®ç´¢å¼•
    return centroids
```

index_points è¿™ä¸ªå‡½æ•°å®ç°çš„æ˜¯æ ¹æ®ç»™å®šçš„ç´¢å¼• idxï¼Œä»è¾“å…¥ç‚¹äº‘ points ä¸­æå–å¯¹åº”çš„ç‚¹ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„å­é›†ã€‚

```python
def index_points(points, idx):
    """
    Input:
        points: input points data, [B, N, C]
        idx: sample index data, [B, S]
    Return:
        new_points:, indexed points data, [B, S, C]
    """
    device = points.device
    B = points.shape[0]
    view_shape = list(idx.shape)
    view_shape[1:] = [1] * (len(view_shape) - 1) # å°†view_shapeçš„å½¢çŠ¶ä»[B, S]å˜æˆ[B, 1]ï¼Œä¾¿äºå¹¿æ’­
    repeat_shape = list(idx.shape) 
    repeat_shape[0] = 1 # ä»[B, S]å˜æˆ[1, S]
    # ä»ç‚¹äº‘ä¸­æ ¹æ®ç´¢å¼•æå–ç‰¹å®šç‚¹ (çœ‹ä¸æ‡‚ä¸‹é¢ä¸¤è¡Œä»£ç çš„è¯ï¼Œå¯ä»¥å…ˆå»äº†è§£ä¸€ä¸‹pythonä¸­çš„é«˜çº§ç´¢å¼•æœºåˆ¶)ã€‚
    batch_indices = torch.arange(B, dtype=torch.long).to(device).view(view_shape).repeat(repeat_shape)
    new_points = points[batch_indices, idx, :] # ï¼ˆbatch,npoint,3)
    return new_points 
```
query_ball_point è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä»ç‚¹äº‘ä¸­æ‰¾å‡ºæ¯ä¸ªæŸ¥è¯¢ç‚¹å‘¨å›´ä¸€å®šåŠå¾„èŒƒå›´å†…çš„é‚»è¿‘ç‚¹ç´¢å¼•ã€‚è¿™ä¸ªæ“ä½œè¢«ç§°ä¸º çƒæŸ¥è¯¢ï¼ˆBall Queryï¼‰ã€‚

```python
def query_ball_point(radius, nsample, xyz, new_xyz):
    """
    Input:
        radius: local region radius
        nsample: max sample number in local region
        xyz: all points, [B, N, 3]
        new_xyz: query points, [B, S, 3]
    Return:
        group_idx: grouped points index, [B, S, nsample]
    """
    device = xyz.device
    B, N, C = xyz.shape
    _, S, _ = new_xyz.shape # æŸ¥è¯¢ç‚¹æ•°é‡ï¼ˆæ¯”å¦‚é€šè¿‡ FPS å¾—åˆ°çš„è´¨å¿ƒï¼‰
    # æ„é€ ä¸€ä¸ªä» 0 åˆ° N-1 çš„ç´¢å¼•æ•°ç»„ï¼Œä»£è¡¨åŸå§‹ç‚¹äº‘ä¸­æ¯ä¸ªç‚¹çš„â€œèº«ä»½è¯å·â€
    # ç„¶åå¤åˆ¶è¿™ä¸ªç´¢å¼•æ•°ç»„åˆ°æ¯ä¸ª batch å’Œæ¯ä¸ªæŸ¥è¯¢ç‚¹ä¸Šï¼Œå½¢æˆ [B, S, N] çš„ç»“æ„    
    group_idx = torch.arange(N, dtype=torch.long).to(device).view(1, 1, N).repeat([B, S, 1])
    # è®¡ç®—æ¯ä¸ªæŸ¥è¯¢ç‚¹ï¼ˆnew_xyzï¼‰ä¸åŸå§‹ç‚¹ï¼ˆxyzï¼‰ä¹‹é—´çš„å¹³æ–¹æ¬§æ°è·ç¦»
    # è¾“å‡ºå½¢çŠ¶ä¸º [B, S, N]ï¼šæ¯ä¸ªæŸ¥è¯¢ç‚¹å¯¹æ‰€æœ‰åŸå§‹ç‚¹çš„è·ç¦»
    sqrdists = square_distance(new_xyz, xyz)
    # æŠŠè·ç¦»è¶…è¿‡ radius^2 çš„ç‚¹å…¨éƒ¨æ›¿æ¢ä¸º Nï¼ˆä¸€ä¸ªéæ³•ç´¢å¼•ï¼‰ï¼Œè¡¨ç¤ºâ€œè¿™äº›äººç¦»æˆ‘å¤ªè¿œäº†ï¼Œæˆ‘ä¸æ„Ÿå…´è¶£ã€‚â€   
    group_idx[sqrdists > radius ** 2] = N
    # å¯¹æ¯ä¸ªæŸ¥è¯¢ç‚¹çš„é‚»è¿‘ç‚¹æŒ‰ç´¢å¼•æ’åºï¼ˆå› ä¸ºå‰é¢æœ‰ Nï¼Œæ‰€ä»¥å°çš„æ‰æ˜¯æœ‰æ•ˆç‚¹ï¼‰
    # ç„¶ååªä¿ç•™å‰ nsample ä¸ªç‚¹
    group_idx = group_idx.sort(dim=-1)[0][:, :, :nsample]
    # å¦‚æœæŸä¸ªæŸ¥è¯¢ç‚¹é™„è¿‘çš„ç‚¹å¤ªå°‘ï¼Œæœ‰äº›ä½ç½®è¢«æ ‡è®°ä¸º Nï¼ˆæ— æ•ˆï¼‰ã€‚
    # æˆ‘ä»¬å°±ç”¨è¯¥æŸ¥è¯¢ç‚¹æœ€è¿‘çš„é‚£ä¸ªç‚¹ï¼ˆç¬¬ä¸€ä¸ªç‚¹ï¼‰å»å¡«å……è¿™äº›ç©ºç¼ºã€‚
    group_first = group_idx[:, :, 0].view(B, S, 1).repeat([1, 1, nsample])
    mask = group_idx == N
    group_idx[mask] = group_first[mask]
    return group_idx # ï¼ˆbatch,npoint,nsample)
```

