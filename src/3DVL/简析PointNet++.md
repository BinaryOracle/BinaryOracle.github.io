---
icon: file
category:
  - 3D-VL
tag:
  - 3D-VL
  - point cloud
  - å·²å‘å¸ƒ
footer: æŠ€æœ¯å…±å»ºï¼ŒçŸ¥è¯†å…±äº«
date: 2025-05-28
cover: assets/cover/PointNet++.png
author:
  - BinaryOracle
---

`ç®€æPointNet++` 

<!-- more -->

# ç®€æPointNet++

> è®ºæ–‡: [https://arxiv.org/abs/1706.02413](https://arxiv.org/abs/1706.02413)
> TensorFlow ç‰ˆæœ¬ä»£ç : [https://github.com/charlesq34/pointnet2](https://github.com/charlesq34/pointnet2)
> Pytorch ç‰ˆæœ¬ä»£ç : [https://github.com/yanx27/Pointnet_Pointnet2_pytorch](https://github.com/yanx27/Pointnet_Pointnet2_pytorch)

## èƒŒæ™¯

åœ¨PointNetä¸­ï¼Œç½‘ç»œå¯¹æ¯ä¸€ä¸ªç‚¹åšä½ç»´åˆ°é«˜ç»´çš„æ˜ å°„ï¼Œè¿›è¡Œç‰¹å¾å­¦ä¹ ï¼Œç„¶åæŠŠæ‰€æœ‰ç‚¹æ˜ å°„åˆ°é«˜ç»´çš„ç‰¹å¾é€šè¿‡æœ€å¤§æ± åŒ–æœ€ç»ˆè¡¨ç¤ºå…¨å±€ç‰¹å¾ã€‚ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œè¦ä¹ˆå¯¹ä¸€ä¸ªç‚¹åšæ“ä½œï¼Œè¦ä¹ˆå¯¹æ‰€æœ‰ç‚¹åšæ“ä½œï¼Œå®é™…ä¸Šæ²¡æœ‰**å±€éƒ¨çš„æ¦‚å¿µ(loal context)** ã€‚åŒæ—¶ç¼ºå°‘ local context åœ¨**å¹³ç§»ä¸å˜æ€§**ä¸Šä¹Ÿæœ‰å±€é™æ€§ï¼ˆä¸–ç•Œåæ ‡ç³»å’Œå±€éƒ¨åæ ‡ç³»ï¼‰ã€‚å¯¹ç‚¹äº‘æ•°æ®åšå¹³ç§»æ“ä½œåï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å°†å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´æ‰€æœ‰çš„ç‰¹å¾ï¼Œå…¨å±€ç‰¹å¾éƒ½ä¸ä¸€æ ·äº†ã€‚å¯¹äºå•ä¸ªçš„ç‰©ä½“è¿˜å¥½ï¼Œå¯ä»¥å°†å…¶å¹³ç§»åˆ°åæ ‡ç³»çš„ä¸­å¿ƒï¼ŒæŠŠä»–çš„å¤§å°å½’ä¸€åŒ–åˆ°ä¸€ä¸ªçƒä¸­ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªåœºæ™¯ä¸­æœ‰å¤šä¸ªç‰©ä½“æ—¶åˆ™ä¸å¥½åŠï¼Œéœ€è¦å¯¹å“ªä¸ªç‰©ä½“åšå½’ä¸€åŒ–å‘¢ï¼Ÿ

PointNet++ è§£å†³äº†ä¸¤ä¸ªé—®é¢˜ï¼šå¦‚ä½•ç”Ÿæˆç‚¹é›†çš„åˆ’åˆ†ï¼ˆPartitioningï¼‰ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡å±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨ï¼ˆLocal Feature Learnerï¼‰æŠ½è±¡ç‚¹é›†æˆ–å±€éƒ¨ç‰¹å¾ã€‚

**ç”Ÿæˆç‚¹é›†çš„åˆ’åˆ†ï¼ˆPartitioningï¼‰ï¼š**

ç‚¹é›†åˆ’åˆ†æ˜¯æŒ‡å¦‚ä½•å°†ä¸€ä¸ªå¤§çš„ç‚¹äº‘åˆ†å‰²æˆæ›´å°çš„ã€æ›´æ˜“äºç®¡ç†çš„å­é›†ã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºåœ¨ä¼ ç»Ÿçš„å·ç§¯ç¥ç»ç½‘ç»œä¸­å¦‚ä½•å¤„ç†å›¾åƒçš„å°åŒºåŸŸï¼ˆæˆ–â€œpatchesâ€ï¼‰ï¼Œä»¥ä¾¿å¯ä»¥åœ¨è¿™äº›åŒºåŸŸä¸Šåº”ç”¨å±€éƒ¨æ“ä½œã€‚PointNet++éœ€è¦ä¸€ç§æ–¹æ³•æ¥æœ‰æ•ˆåœ°å°†ç‚¹äº‘åˆ†å‰²æˆå¤šä¸ªéƒ¨åˆ†ï¼Œè¿™æ ·å¯ä»¥åœ¨æ¯ä¸ªéƒ¨åˆ†ä¸Šç‹¬ç«‹åœ°å­¦ä¹ ç‰¹å¾ã€‚

**é€šè¿‡å±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨ï¼ˆLocal Feature Learnerï¼‰æŠ½è±¡ç‚¹é›†æˆ–å±€éƒ¨ç‰¹å¾ï¼š**

ä¸€æ—¦ç‚¹äº‘è¢«åˆ’åˆ†æˆå°çš„å­é›†ï¼ŒPointNet++çš„ä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¯å­¦ä¹ è¿™äº›å­é›†ï¼ˆæˆ–å±€éƒ¨åŒºåŸŸï¼‰çš„ç‰¹å¾ã€‚è¿™éœ€è¦ä¸€ä¸ªâ€œå±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨â€ï¼Œå®ƒèƒ½å¤Ÿä»æ¯ä¸ªå­é›†ä¸­æå–æœ‰ç”¨çš„ä¿¡æ¯æˆ–ç‰¹å¾ã€‚è¿™ä¸åœ¨ä¼ ç»ŸCNNä¸­å­¦ä¹ å›¾åƒå±€éƒ¨åŒºåŸŸç‰¹å¾çš„è¿‡ç¨‹ç›¸ä¼¼ã€‚

**ä¸¤ä¸ªé—®é¢˜æ˜¯ç›¸å…³è”çš„ï¼Œå› ä¸ºï¼š**

ç‚¹é›†çš„åˆ’åˆ†å¿…é¡»äº§ç”Ÿè·¨åˆ†åŒºçš„å…±åŒç»“æ„ï¼šä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„å±€éƒ¨å­é›†ä¸Šå…±äº«æƒé‡ï¼ˆç±»ä¼¼äºåœ¨CNNä¸­æƒé‡å…±äº«çš„æ¦‚å¿µï¼‰ï¼ŒPointNet++åœ¨è¿›è¡Œç‚¹é›†åˆ’åˆ†æ—¶ï¼Œéœ€è¦ç¡®ä¿è¿™äº›åˆ’åˆ†å…·æœ‰ä¸€å®šçš„ä¸€è‡´æ€§æˆ–å…±åŒç»“æ„ã€‚è¿™æ„å‘³ç€å³ä½¿æ˜¯ä¸åŒçš„å±€éƒ¨å­é›†ï¼Œä¹Ÿåº”è¯¥ä»¥ä¸€ç§æ–¹å¼è¢«å¤„ç†ï¼Œä½¿å¾—åœ¨å®ƒä»¬ä¹‹é—´å¯ä»¥å…±äº«å­¦ä¹ åˆ°çš„ç‰¹å¾è¡¨ç¤ºçš„æƒé‡ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯æé«˜æ¨¡å‹çš„æ•ˆç‡å’Œæ³›åŒ–èƒ½åŠ›ï¼Œå› ä¸ºå­¦ä¹ åˆ°çš„ç‰¹å¾å’Œæƒé‡å¯ä»¥åœ¨å¤šä¸ªå±€éƒ¨åŒºåŸŸä¸­å¤ç”¨ã€‚

ä¸Šè¿°å³ä¸ºPointNet++è®¾è®¡ä¸­çš„ä¸¤ä¸ªæ ¸å¿ƒæŒ‘æˆ˜ï¼š
- å¦‚ä½•æœ‰æ•ˆåœ°å¯¹ç‚¹äº‘è¿›è¡Œåˆ†åŒºï¼Œä»¥ä¾¿å¯ä»¥åœ¨è¿™äº›åˆ†åŒºä¸Šç‹¬ç«‹åœ°å­¦ä¹ ç‰¹å¾ã€‚
- å¦‚ä½•è®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿä»è¿™äº›å±€éƒ¨åˆ†åŒºä¸­å­¦ä¹ æœ‰ç”¨ç‰¹å¾çš„æœºåˆ¶ï¼ŒåŒæ—¶ç¡®ä¿è¿™äº›åˆ†åŒºçš„å¤„ç†æ–¹å¼å…è®¸åœ¨å®ƒä»¬ä¹‹é—´å…±äº«æ¨¡å‹æƒé‡ã€‚
  - ä¸ºäº†æ¨¡ä»¿ä¼ ç»Ÿå·ç§¯ç½‘ç»œä¸­çš„æƒé‡å…±äº«æœºåˆ¶ä»¥æé«˜å­¦ä¹ æ•ˆç‡å’Œæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚

PointNet++é€‰æ‹©PointNetä½œä¸ºå±€éƒ¨ç‰¹å¾å­¦ä¹ å™¨ï¼ˆå®ƒæ˜¯æ— åºç‚¹äº‘æ•°æ®ç‰¹å¾æå–çš„é«˜æ•ˆç®—æ³•ï¼‰ã€‚

> å¯ä»¥ç†è§£ä¸ºï¼šPointNet++åº”ç”¨PointNeté€’å½’åœ°å¯¹è¾“å…¥é›†è¿›è¡ŒåµŒå¥—åˆ†åŒºã€‚

## æ¨¡å‹ç»“æ„

![ä»¥äºŒç»´æ¬§å‡ é‡Œå¾—ç©ºé—´ä¸ºä¾‹ï¼Œç½‘ç»œçš„åˆ†å‰²å’Œåˆ†ç±»æ¨¡å‹](ç®€æPointNet++/1.png)

ç½‘ç»œçš„æ¯ä¸€ç»„set abstraction layersä¸»è¦åŒ…æ‹¬3ä¸ªéƒ¨åˆ†ï¼š

- Sample layer : å¯¹è¾“å…¥ç‚¹è¿›è¡Œé‡‡æ ·ï¼Œåœ¨è¿™äº›ç‚¹ä¸­é€‰å‡ºè‹¥å¹²ä¸ªä¸­å¿ƒç‚¹ã€‚

- Grouping layer : åˆ©ç”¨ä¸Šä¸€æ­¥å¾—åˆ°çš„ä¸­å¿ƒç‚¹å°†ç‚¹é›†åˆ’åˆ†æˆè‹¥å¹²ä¸ªåŒºåŸŸã€‚

- PointNet layer : å¯¹ä¸Šè¿°å¾—åˆ°çš„æ¯ä¸ªåŒºåŸŸè¿›è¡Œç¼–ç ï¼Œå˜æˆç‰¹å¾å‘é‡ã€‚

### å±‚æ¬¡åŒ–ç‚¹é›†ç‰¹å¾å­¦ä¹ 

å±‚æ¬¡åŒ–ç»“æ„ç”±å¤šä¸ªset abstraction layersç»„æˆï¼Œåœ¨æ¯ä¸ªå±‚ä¸Šï¼Œä¸€ç»„ç‚¹äº‘è¢«å¤„ç†å’ŒæŠ½è±¡ï¼Œä»¥äº§ç”Ÿä¸€ä¸ªæ›´å°‘å…ƒç´ çš„æ–°é›†åˆã€‚set abstraction layers ç”± Sampling layerã€Grouping layer å’Œ PointNet layer ä¸‰éƒ¨åˆ†ç»„æˆã€‚

- Sampling layer ï¼šé‡‡æ ·å±‚ ä»è¾“å…¥ç‚¹ä¸­é€‰å–ä¸€ç»„ç‚¹ï¼Œå®šä¹‰å±€éƒ¨åŒºåŸŸçš„å½¢å¿ƒã€‚

- Grouping layer ï¼šé€šè¿‡æŸ¥æ‰¾å½¢å¿ƒç‚¹å‘¨å›´çš„â€œé‚»è¿‘ç‚¹â€æ¥æ„å»ºå±€éƒ¨åŒºåŸŸç‚¹é›†ã€‚

- PointNet layer ï¼šä½¿ç”¨mini-PointNetå°†å±€éƒ¨åŒºåŸŸç¼–ç ä¸ºç‰¹å¾å‘é‡ã€‚

#### Sampling layer

ä½¿ç”¨farthest point samplingï¼ˆFPSï¼‰é€‰æ‹©ğ‘ä¸ªç‚¹ï¼ˆç›¸æ¯”äºéšæœºé‡‡æ ·ï¼Œè¯¥æ–¹æ³•èƒ½æ›´å¥½çš„è¦†ç›–æ•´ä¸ªç‚¹é›†ï¼Œå…·ä½“é€‰æ‹©å¤šå°‘ä¸ªä¸­å¿ƒç‚¹ä»¥åŠé‚»åŸŸå†…çš„æ•°é‡ç”±è¶…å‚æ•°ç¡®å®šï¼‰

FPSæ˜¯ä¸€ç§åœ¨ç‚¹äº‘ã€å›¾åƒå¤„ç†æˆ–å…¶ä»–æ•°æ®é›†ä¸­ç”¨äºæŠ½æ ·çš„ç®—æ³•ã€‚ç›®çš„æ˜¯ä»ä¸€ä¸ªå¤§çš„æ•°æ®é›†ä¸­é€‰å‡ºä¸€ç»„ä»£è¡¨æ€§å¼ºçš„ç‚¹ï¼Œè¿™äº›ç‚¹å½¼æ­¤ä¹‹é—´çš„æœ€å°è·ç¦»å°½å¯èƒ½å¤§ã€‚

ä½œè€…é€šè¿‡FPSæ¥æŠ½æ ·ç‚¹é›†ä¸­è¾ƒä¸ºé‡è¦çš„ç‚¹ã€‚ï¼ˆå³ä»»åŠ¡æ˜¯æ‰¾åˆ°ç‚¹äº‘é›†ä¸­çš„å±€éƒ¨åŒºåŸŸçš„ä¸­å¿ƒç‚¹ï¼‰

> å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼šè®¡ç®—æˆæœ¬ã€æ ·æœ¬åˆ†å¸ƒåå·®ï¼ˆå¯èƒ½å¯¼è‡´æ ·æœ¬åœ¨é«˜å¯†åº¦åŒºåŸŸå†…è¿‡åº¦é›†ä¸­ï¼Œä½å¯†åº¦åŒºåŸŸåˆ™è¿‡äºç¨€ç¼ºï¼‰ã€å‚æ•°ä¾èµ–ï¼ˆä¾èµ–åˆå§‹ç‚¹å’Œè·ç¦»åº¦é‡æ–¹å¼çš„é€‰æ‹©ï¼‰ã€å¯èƒ½æ— æ³•æ•æ‰é‡è¦çš„å‡ ä½•ç»†èŠ‚ã€‚

#### Grouping layer

æ–‡ä¸­ä½œè€…é€šè¿‡Ball queryæ¥æŸ¥è¯¢å½¢å¿ƒçš„é‚»å±…ç‚¹ã€‚

å…·ä½“åšæ³•ï¼šç»™å®šä¸¤ä¸ªè¶…å‚æ•°ï¼ˆæ¯ä¸ªåŒºåŸŸä¸­ç‚¹çš„æ•°é‡ğ¾å’Œqueryçš„åŠå¾„ğ‘Ÿï¼‰ï¼Œå¯¹äºæŸä¸ªå½¢å¿ƒï¼ŒBall queryæ‰¾åˆ°è¯¥æŸ¥è¯¢ç‚¹åœ¨åŠå¾„ä¸ºğ‘ŸèŒƒå›´å†…ç‚¹ï¼Œè¯¥èŒƒå›´ç¡®ä¿å±€éƒ¨åŒºåŸŸçš„å°ºåº¦æ˜¯å›ºå®šçš„ã€‚

ä¸Kæœ€è¿‘é‚»ï¼ˆkNNï¼‰æŸ¥è¯¢ç›¸æ¯”ï¼ŒBall queryé€šè¿‡å›ºå®šåŒºåŸŸå°ºåº¦è€Œä¸æ˜¯å›ºå®šé‚»å±…æ•°é‡æ¥å®šä¹‰é‚»åŸŸã€‚kNNæŸ¥è¯¢å¯»æ‰¾æœ€è¿‘çš„Kä¸ªé‚»å±…ï¼Œä½†è¿™å¯èƒ½å¯¼è‡´æ‰€é€‰é‚»åŸŸçš„å®é™…å°ºå¯¸éšç‚¹çš„å¯†åº¦å˜åŒ–è€Œå˜åŒ–ï¼Œè¿™åœ¨å¤„ç†éå‡åŒ€é‡‡æ ·çš„æ•°æ®æ—¶å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„é€‰æ‹©ã€‚ç›¸åï¼ŒBall queryé€šè¿‡ç¡®ä¿æ¯ä¸ªå±€éƒ¨åŒºåŸŸéƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„å°ºåº¦ï¼Œæé«˜äº†æ¨¡å‹åœ¨ç©ºé—´ä¸Šçš„æ³›åŒ–èƒ½åŠ›ã€‚åœ¨å®ç°æ—¶ï¼Œé€šå¸¸ä¼šè®¾ç½®ä¸€ä¸ªä¸Šé™Kï¼Œä»¥é™åˆ¶æ¯ä¸ªå±€éƒ¨åŒºåŸŸä¸­è€ƒè™‘çš„ç‚¹çš„æ•°é‡ï¼Œä»¥ä¿æŒè®¡ç®—çš„å¯ç®¡ç†æ€§ã€‚

> **å¯æ”¹è¿›çš„åœ°æ–¹**ï¼šå¯¹ç‚¹äº‘å¯†åº¦å˜æ¢è¾ƒä¸ºæ•æ„Ÿã€å¯¹å‚æ•°é€‰æ‹©ä¾èµ–æ€§é«˜ï¼ˆåŠå¾„å¤ªå°å¯èƒ½æ— æ³•æœ‰æ•ˆæ•è·è¶³å¤Ÿçš„å±€éƒ¨è¯¦ç»†ï¼Œå¤ªå¤§åˆ™å¯èƒ½å¯¼è‡´ä¸ç›¸å…³çš„ç‚¹å¢å¤šï¼Œä½¿å±€éƒ¨ç‰¹å¾çš„è¡¨ç¤ºä¸å¤Ÿç²¾ç¡®ï¼‰ã€è®¡ç®—æ•ˆç‡é—®é¢˜ã€å‡åŒ€æ€§å‡è®¾ï¼ˆBall queryæ˜¯åŸºäºæ¬§æ°è·ç¦»çš„å‡åŒ€æ€§å‡è®¾ï¼‰
> - æ¬§å¼è·ç¦»çš„å‡åŒ€æ€§å‡è®¾ï¼šå³åœ¨æ¬§æ°ç©ºé—´ä¸­ï¼Œä¸¤ç‚¹çš„è·ç¦»åæ˜ äº†è¿™ä¸¤ç‚¹çš„å®é™…ç›¸ä¼¼åº¦æˆ–å…³è”åº¦ã€‚
> - åŸºäºä»¥ä¸‹å‰æï¼š
>    - ç©ºé—´å‡åŒ€æ€§ï¼šç©ºé—´æ˜¯å‡åŒ€å’Œå„å‘åŒæ€§çš„ï¼Œå³ä»»ä½•æ–¹å‘ä¸Šçš„åº¦é‡éƒ½æ˜¯ç­‰ä»·çš„ï¼Œè·ç¦»çš„åº¦é‡ä¸å—ç©ºé—´ä¸­ä½ç½®çš„å½±å“ã€‚
>    - è·ç¦»ç›´è§‚æ€§ï¼šåœ¨å±‹é‡Œç©ºé—´æˆ–æŸäº›ç‰¹å®šçš„æŠ½è±¡ç©ºé—´ä¸­ï¼Œä¸¤ä¸ªç‚¹ä¹‹é—´çš„ç›´çº¿è·ç¦»è¢«è®¤ä¸ºæ˜¯ç›¸ä¼¼åº¦æˆ–è¿æ¥å¼ºåº¦çš„ç›´è§‚è¡¨ç¤ºã€‚
>    - è§„æ¨¡ä¸€è‡´æ€§ï¼šå‡è®¾ç©ºé—´ä¸­æ‰€æœ‰åŒºåŸŸçš„å°ºåº¦æˆ–ç‰¹å¾åˆ†å¸ƒå…·æœ‰ä¸€å®šçš„ä¸€è‡´æ€§ï¼Œå³ç©ºé—´ä¸­çš„ä»»ä½•è·ç¦»å€¼å…·æœ‰ç›¸ä¼¼çš„å«ä¹‰ã€‚

æ€»ç»“: Grouping layerçš„ä»»åŠ¡æ˜¯é€šè¿‡ä¸­å¿ƒç‚¹æ‰¾åˆ°é‚»å±…ç‚¹ï¼Œå¹¶å°†å®ƒä»¬ç»„ç»‡ç§°ä¸ºå±€éƒ¨åŒºåŸŸé›†ã€‚

#### PointNet layer

å±€éƒ¨åæ ‡ç³»è½¬æ¢ï¼šå±€éƒ¨åŒºåŸŸä¸­çš„ç‚¹è½¬æ¢æˆç›¸å¯¹äºå½¢å¿ƒçš„å±€éƒ¨åæ ‡ç³»ã€‚ 

> å±€éƒ¨åŒºåŸŸä¸­çš„æ¯ä¸ªç‚¹å°†ç›¸å¯¹äºå½¢å¿ƒæ‰€åœ¨ä½ç½®è¿›è¡Œè°ƒæ•´ï¼Œä»¥åæ˜ å…¶ç›¸å¯¹ä½ç½®ã€‚

å®ç°æ–¹æ³•ï¼šé€šè¿‡å°†å±€éƒ¨åŒºåŸŸä¸­çš„æ¯ä¸ªç‚¹-å½¢å¿ƒç‚¹çš„åæ ‡æ¥å®ç°ã€‚

ç‰¹å¾ç¼–ç ï¼šå°†è½¬æ¢åçš„åæ ‡ä»¥åŠç‚¹çš„é™„åŠ ç‰¹å¾ï¼ˆæ–‡ä¸­çš„ğ¶æ‰€è¡¨ç¤ºçš„å…¶ä»–ä¿¡æ¯ï¼‰ä¸€èµ·é€å…¥mini-PointNetæ¥æå–å±€éƒ¨åŒºåŸŸä¸­çš„ç‰¹å¾ã€‚

è¾“å‡ºï¼šåˆ©ç”¨ç›¸å¯¹åæ ‡ä¸ç‚¹ç‰¹å¾ç›¸ç»“åˆçš„æ–¹å¼å¯ä»¥æ•è·å±€éƒ¨åŒºåŸŸä¸­ç‚¹ä¸ç‚¹ä¹‹é—´çš„å…³ç³»ã€‚

#### ä»£ç å®ç°

sample_and_group è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä»è¾“å…¥ç‚¹äº‘ä¸­ï¼š
- é‡‡æ ·ä¸€äº›å…³é”®ç‚¹
- ä¸ºæ¯ä¸ªå…³é”®ç‚¹æ„å»ºå±€éƒ¨é‚»åŸŸï¼ˆå±€éƒ¨åŒºåŸŸï¼‰
- æå–è¿™äº›å±€éƒ¨åŒºåŸŸä¸­çš„ç‚¹åŠå…¶ç‰¹å¾

```python
def sample_and_group(npoint, radius, nsample, xyz, points, returnfps=False):
    """
    Input:
        npoint: é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        radius: æ„å»ºå±€éƒ¨é‚»åŸŸçš„åŠå¾„
        nsample: æ¯ä¸ªé‚»åŸŸå†…é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        xyz: ç‚¹äº‘åæ ‡æ•°æ® , [B, N, 3]
        points: ç‚¹çš„ç‰¹å¾æ•°æ®ï¼ˆå¯é€‰ï¼‰, [B, N, D]
    Return:
        new_xyz: é‡‡æ ·å¾—åˆ°çš„å…³é”®ç‚¹åæ ‡, [B, npoint, nsample, 3]
        new_points: æ¯ä¸ªå…³é”®ç‚¹å¯¹åº”çš„å±€éƒ¨åŒºåŸŸç‚¹å’Œç‰¹å¾, [B, npoint, nsample, 3+D]
    """
    B, N, C = xyz.shape
    S = npoint
    # ä½¿ç”¨ æœ€è¿œç‚¹é‡‡æ ·ï¼ˆFPSï¼‰ ä»åŸå§‹ç‚¹äº‘ä¸­é€‰å‡º npoint ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„ç‚¹ã€‚
    fps_idx = farthest_point_sample(xyz, npoint) # [B, npoint]
    new_xyz = index_points(xyz, fps_idx) # [B, npoint, 3]
    # å¯¹äºæ¯ä¸ªé€‰ä¸­çš„å…³é”®ç‚¹ï¼Œä½¿ç”¨ çƒæŸ¥è¯¢ï¼ˆBall Queryï¼‰ æ‰¾å‡ºå®ƒå‘¨å›´è·ç¦»å°äº radius çš„æ‰€æœ‰é‚»è¿‘ç‚¹ã€‚
    # æœ€å¤šä¿ç•™ nsample ä¸ªç‚¹ï¼Œå¦‚æœä¸å¤Ÿå°±é‡å¤æœ€è¿‘çš„ç‚¹æ¥å¡«å……ã€‚
    idx = query_ball_point(radius, nsample, xyz, new_xyz)
    # æŠŠåˆšæ‰æ‰¾åˆ°çš„é‚»è¿‘ç‚¹çš„åæ ‡æå–å‡ºæ¥ã€‚
    grouped_xyz = index_points(xyz, idx) # [B, npoint, nsample, 3]
    # æŠŠå®ƒä»¬ç›¸å¯¹äºå…³é”®ç‚¹çš„ä½ç½®è¿›è¡Œå½’ä¸€åŒ–ï¼ˆå¹³ç§»ä¸­å¿ƒåˆ°ä»¥å…³é”®ç‚¹ä¸ºåŸç‚¹çš„å±€éƒ¨åæ ‡ç³»ä¸Šï¼‰ã€‚
    grouped_xyz_norm = grouped_xyz - new_xyz.view(B, S, 1, C) # [B, npoint, nsample, 3]

    # å¦‚æœæœ‰é¢å¤–çš„ç‚¹ç‰¹å¾ï¼ˆæ¯”å¦‚é¢œè‰²ã€æ³•çº¿ç­‰ï¼‰ï¼Œä¹Ÿä¸€å¹¶æå–ã€‚ 
    if points is not None:
        grouped_points = index_points(points, idx)
        # æŠŠé‚»è¿‘ç‚¹çš„åæ ‡å’Œç‰¹å¾æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆçš„å±€éƒ¨åŒºåŸŸè¡¨ç¤ºã€‚
        new_points = torch.cat([grouped_xyz_norm, grouped_points], dim=-1) # [B, npoint, nsample, C+D]
    else:
        new_points = grouped_xyz_norm

    if returnfps:
        return new_xyz, new_points, grouped_xyz, fps_idx
    else:
        return new_xyz, new_points
```

farthest_point_sample è¿™ä¸ªå‡½æ•°å®ç°çš„æ˜¯æœ€è¿œç‚¹é‡‡æ ·ï¼ˆFarthest Point Sampling, FPSï¼‰, è¿™æ˜¯ PointNet++ ä¸­ç”¨äºä»ç‚¹äº‘ä¸­é€‰æ‹©å…·æœ‰ä»£è¡¨æ€§çš„é‡‡æ ·ç‚¹çš„ä¸€ç§ç­–ç•¥ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**åœ¨ç‚¹äº‘ä¸­é€æ­¥é€‰æ‹©ç¦»å·²é€‰ç‚¹å°½å¯èƒ½è¿œçš„ç‚¹ï¼Œä½¿å¾—é‡‡æ ·ç‚¹åœ¨æ•´ä¸ªç‚¹äº‘ç©ºé—´ä¸­åˆ†å¸ƒå°½å¯èƒ½å‡åŒ€** ã€‚

```python
def farthest_point_sample(xyz, npoint):
    """
    Input:
        xyz: pointcloud data, [B, N, 3]
        npoint: number of samples
    Return:
        centroids: sampled pointcloud index, [B, npoint]
    """
    device = xyz.device
    B, N, C = xyz.shape
    centroids = torch.zeros(B, npoint, dtype=torch.long).to(device) # å­˜å‚¨æ¯æ¬¡é€‰å‡ºçš„â€œæœ€è¿œç‚¹â€çš„ç´¢å¼•ã€‚
    distance = torch.ones(B, N).to(device) * 1e10 # æ¯ä¸ªç‚¹åˆ°å½“å‰æ‰€æœ‰å·²é€‰ä¸­å¿ƒç‚¹çš„æœ€å°è·ç¦»ï¼Œåˆå§‹è®¾ä¸ºä¸€ä¸ªæå¤§å€¼ï¼ˆ1e10ï¼‰ã€‚
    farthest = torch.randint(0, N, (B,), dtype=torch.long).to(device) # åˆå§‹æ—¶éšæœºé€‰æ‹©ä¸€ä¸ªç‚¹ä½œä¸ºç¬¬ä¸€ä¸ªä¸­å¿ƒç‚¹ã€‚
    batch_indices = torch.arange(B, dtype=torch.long).to(device) # æ‰¹æ¬¡ç´¢å¼•ï¼Œç”¨äºå¿«é€Ÿè®¿é—®æ¯ä¸ª batch çš„ç‚¹ã€‚
    # é‡å¤ npoint æ¬¡ï¼Œæœ€ç»ˆå¾—åˆ° npoint ä¸ªåˆ†å¸ƒå°½å¯èƒ½å‡åŒ€çš„é‡‡æ ·ç‚¹ç´¢å¼•ã€‚
    for i in range(npoint):
        # å°†å½“å‰é€‰ä¸­çš„â€œæœ€è¿œç‚¹â€ç´¢å¼•ä¿å­˜ä¸‹æ¥ï¼›
        centroids[:, i] = farthest # ï¼ˆbatch,npoint)
        # å–å‡ºå½“å‰æœ€è¿œç‚¹çš„åæ ‡ï¼Œç”¨äºåç»­è®¡ç®—å…¶ä»–ç‚¹åˆ°è¯¥ç‚¹çš„è·ç¦»; 
        centroid = xyz[batch_indices, farthest, :].view(B, 1, 3) # # ï¼ˆbatch, 1 , 3)
        # è®¡ç®—å½“å‰ä¸­å¿ƒç‚¹ä¸æ‰€æœ‰ç‚¹ä¹‹é—´çš„æ¬§æ°è·ç¦»å¹³æ–¹ã€‚
        dist = torch.sum((xyz - centroid) ** 2, -1) # ï¼ˆbatch,npoint)
        # å¦‚æœæŸä¸ªç‚¹åˆ°æ–°ä¸­å¿ƒç‚¹çš„è·ç¦»æ¯”ä¹‹å‰è®°å½•çš„â€œæœ€å°è·ç¦»â€è¿˜å°ï¼Œå°±æ›´æ–°å®ƒã€‚
        mask = dist < distance
        # åœ¨ distance ä¸­æ‰¾åˆ°æœ€å¤§çš„é‚£ä¸ªè·ç¦»å¯¹åº”çš„ç‚¹ï¼Œè¿™å°±æ˜¯ä¸‹ä¸€ä¸ªâ€œæœ€è¿œç‚¹â€ã€‚
        distance[mask] = dist[mask]   # ï¼ˆbatch,npoint)
        # åœ¨ distance ä¸­æ‰¾åˆ°æœ€å¤§çš„é‚£ä¸ªè·ç¦»å¯¹åº”çš„ç‚¹ï¼Œè¿™å°±æ˜¯ä¸‹ä¸€ä¸ªâ€œæœ€è¿œç‚¹â€ã€‚
        # è¿”å›ï¼šä¸€ä¸ªå…ƒç»„ï¼š(values, indices)ï¼Œåˆ†åˆ«æ˜¯æœ€å¤§å€¼å’Œå®ƒä»¬çš„ä½ç½®ç´¢å¼•ã€‚
        farthest = torch.max(distance, -1)[1] # è¿”å›ä½ç½®ç´¢å¼•
    return centroids
```

index_points è¿™ä¸ªå‡½æ•°å®ç°çš„æ˜¯æ ¹æ®ç»™å®šçš„ç´¢å¼• idxï¼Œä»è¾“å…¥ç‚¹äº‘ points ä¸­æå–å¯¹åº”çš„ç‚¹ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„å­é›†ã€‚

```python
def index_points(points, idx):
    """
    Input:
        points: input points data, [B, N, C]
        idx: sample index data, [B, S]
    Return:
        new_points:, indexed points data, [B, S, C]
    """
    device = points.device
    B = points.shape[0]
    view_shape = list(idx.shape)
    view_shape[1:] = [1] * (len(view_shape) - 1) # å°†view_shapeçš„å½¢çŠ¶ä»[B, S]å˜æˆ[B, 1]ï¼Œä¾¿äºå¹¿æ’­
    repeat_shape = list(idx.shape) 
    repeat_shape[0] = 1 # ä»[B, S]å˜æˆ[1, S]
    # ä»ç‚¹äº‘ä¸­æ ¹æ®ç´¢å¼•æå–ç‰¹å®šç‚¹ (çœ‹ä¸æ‡‚ä¸‹é¢ä¸¤è¡Œä»£ç çš„è¯ï¼Œå¯ä»¥å…ˆå»äº†è§£ä¸€ä¸‹pythonä¸­çš„é«˜çº§ç´¢å¼•æœºåˆ¶)ã€‚
    batch_indices = torch.arange(B, dtype=torch.long).to(device).view(view_shape).repeat(repeat_shape)
    new_points = points[batch_indices, idx, :] # ï¼ˆbatch,npoint,3)
    return new_points 
```
query_ball_point è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä»ç‚¹äº‘ä¸­æ‰¾å‡ºæ¯ä¸ªæŸ¥è¯¢ç‚¹å‘¨å›´ä¸€å®šåŠå¾„èŒƒå›´å†…çš„é‚»è¿‘ç‚¹ç´¢å¼•ã€‚è¿™ä¸ªæ“ä½œè¢«ç§°ä¸º çƒæŸ¥è¯¢ï¼ˆBall Queryï¼‰ã€‚

```python
def query_ball_point(radius, nsample, xyz, new_xyz):
    """
    Input:
        radius: local region radius
        nsample: max sample number in local region
        xyz: all points, [B, N, 3]
        new_xyz: query points, [B, S, 3]
    Return:
        group_idx: grouped points index, [B, S, nsample]
    """
    device = xyz.device
    B, N, C = xyz.shape
    _, S, _ = new_xyz.shape # æŸ¥è¯¢ç‚¹æ•°é‡ï¼ˆæ¯”å¦‚é€šè¿‡ FPS å¾—åˆ°çš„è´¨å¿ƒï¼‰
    # æ„é€ ä¸€ä¸ªä» 0 åˆ° N-1 çš„ç´¢å¼•æ•°ç»„ï¼Œä»£è¡¨åŸå§‹ç‚¹äº‘ä¸­æ¯ä¸ªç‚¹çš„â€œèº«ä»½è¯å·â€
    # ç„¶åå¤åˆ¶è¿™ä¸ªç´¢å¼•æ•°ç»„åˆ°æ¯ä¸ª batch å’Œæ¯ä¸ªæŸ¥è¯¢ç‚¹ä¸Šï¼Œå½¢æˆ [B, S, N] çš„ç»“æ„    
    group_idx = torch.arange(N, dtype=torch.long).to(device).view(1, 1, N).repeat([B, S, 1])
    # è®¡ç®—æ¯ä¸ªæŸ¥è¯¢ç‚¹ï¼ˆnew_xyzï¼‰ä¸åŸå§‹ç‚¹ï¼ˆxyzï¼‰ä¹‹é—´çš„å¹³æ–¹æ¬§æ°è·ç¦»
    # è¾“å‡ºå½¢çŠ¶ä¸º [B, S, N]ï¼šæ¯ä¸ªæŸ¥è¯¢ç‚¹å¯¹æ‰€æœ‰åŸå§‹ç‚¹çš„è·ç¦»
    sqrdists = square_distance(new_xyz, xyz)
    # æŠŠè·ç¦»è¶…è¿‡ radius^2 çš„ç‚¹å…¨éƒ¨æ›¿æ¢ä¸º Nï¼ˆä¸€ä¸ªéæ³•ç´¢å¼•ï¼‰ï¼Œè¡¨ç¤ºâ€œè¿™äº›äººç¦»æˆ‘å¤ªè¿œäº†ï¼Œæˆ‘ä¸æ„Ÿå…´è¶£ã€‚â€   
    group_idx[sqrdists > radius ** 2] = N
    # å¯¹æ¯ä¸ªæŸ¥è¯¢ç‚¹çš„é‚»è¿‘ç‚¹æŒ‰ç´¢å¼•æ’åºï¼ˆå› ä¸ºå‰é¢æœ‰ Nï¼Œæ‰€ä»¥å°çš„æ‰æ˜¯æœ‰æ•ˆç‚¹ï¼‰
    # ç„¶ååªä¿ç•™å‰ nsample ä¸ªç‚¹
    group_idx = group_idx.sort(dim=-1)[0][:, :, :nsample]
    # å¦‚æœæŸä¸ªæŸ¥è¯¢ç‚¹é™„è¿‘çš„ç‚¹å¤ªå°‘ï¼Œæœ‰äº›ä½ç½®è¢«æ ‡è®°ä¸º Nï¼ˆæ— æ•ˆï¼‰ã€‚
    # æˆ‘ä»¬å°±ç”¨è¯¥æŸ¥è¯¢ç‚¹æœ€è¿‘çš„é‚£ä¸ªç‚¹ï¼ˆç¬¬ä¸€ä¸ªç‚¹ï¼‰å»å¡«å……è¿™äº›ç©ºç¼ºã€‚
    group_first = group_idx[:, :, 0].view(B, S, 1).repeat([1, 1, nsample])
    mask = group_idx == N
    group_idx[mask] = group_first[mask]
    return group_idx # ï¼ˆbatch,npoint,nsample)
```

![sample_and_groupæµç¨‹å›¾](ç®€æPointNet++/2.png)

sample_and_group_all å‡½æ•°çš„ä½œç”¨æ˜¯å°†æ•´ä¸ªç‚¹äº‘è§†ä¸ºä¸€ä¸ªâ€œå¤§å±€éƒ¨åŒºåŸŸâ€ï¼Œä¸è¿›è¡Œé‡‡æ ·ï¼Œç›´æ¥å¯¹æ‰€æœ‰ç‚¹è¿›è¡Œç‰¹å¾æå–ï¼Œç”¨äº PointNet++ ä¸­çš„å…¨å±€ç‰¹å¾å­¦ä¹ ã€‚ 

```python
def sample_and_group_all(xyz, points):
    """
    Input:
        xyz: input points position data, [B, N, 3], ç‚¹äº‘åæ ‡æ•°æ®
        points: input points data, [B, N, D], ç‚¹äº‘çš„é¢å¤–ç‰¹å¾ï¼ˆå¦‚æ³•çº¿ã€é¢œè‰²ç­‰ï¼‰
    Return:
        new_xyz: sampled points position data, [B, 1, 3]
        new_points: sampled points data, [B, 1, N, 3+D]
    """
    device = xyz.device
    B, N, C = xyz.shape
    # åˆ›å»ºä¸€ä¸ªå…¨é›¶ç‚¹ä½œä¸ºâ€œè´¨å¿ƒâ€
    # è™½ç„¶è¿™ä¸ªç‚¹æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä½†å®ƒæ˜¯ä¸ºäº†ç»Ÿä¸€æ¥å£è®¾è®¡çš„ä¸€ä¸ªå ä½ç¬¦
    new_xyz = torch.zeros(B, 1, C).to(device)
    # æŠŠåŸå§‹ç‚¹äº‘ reshape æˆä¸€ä¸ªå¤§çš„å±€éƒ¨åŒºåŸŸ
    grouped_xyz = xyz.view(B, 1, N, C)
    # å¦‚æœæœ‰é¢å¤–ç‰¹å¾ï¼ˆæ¯”å¦‚æ³•çº¿ã€é¢œè‰²ï¼‰ï¼Œä¹Ÿä¸€å¹¶åŠ å…¥
    if points is not None:
        # ç»ˆè¾“å‡ºçš„ new_points æ˜¯ [B, 1, N, 3+D]ï¼Œä»£è¡¨æ¯ä¸ª batch ä¸­åªæœ‰ä¸€ç»„â€œå¤§åŒºåŸŸâ€çš„ç‚¹åŠå…¶ç‰¹å¾
        new_points = torch.cat([grouped_xyz, points.view(B, 1, N, -1)], dim=-1)
    else:    
        new_points = grouped_xyz
    return new_xyz, new_points # å…¨å±€è´¨å¿ƒç‚¹ï¼ˆ0 ä½ç½®ï¼‰, æ‰€æœ‰ç‚¹ç»„æˆçš„å±€éƒ¨åŒºåŸŸ
```
![sample_and_group_allæµç¨‹å›¾](ç®€æPointNet++/3.png)

PointNetSetAbstractionï¼ˆç‚¹é›†æŠ½è±¡å±‚ï¼‰ æ˜¯ PointNet++ ä¸­çš„æ ¸å¿ƒæ¨¡å— ï¼Œ å®ƒçš„ä½œç”¨æ˜¯è´Ÿè´£ä»è¾“å…¥çš„ç‚¹äº‘æ•°æ®ä¸­é‡‡æ ·å…³é”®ç‚¹ï¼Œæ„å»ºå®ƒä»¬çš„å±€éƒ¨é‚»åŸŸåŒºåŸŸï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå°å‹ PointNet æå–è¿™äº›åŒºåŸŸçš„é«˜ç»´ç‰¹å¾ï¼Œä»è€Œå®ç°ç‚¹äº‘çš„åˆ†å±‚ç‰¹å¾å­¦ä¹ ã€‚

```python
class PointNetSetAbstraction(nn.Module):
    def __init__(self, npoint, radius, nsample, in_channel, mlp, group_all):
        super(PointNetSetAbstraction, self).__init__()
        self.npoint = npoint # é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        self.radius = radius # æ„å»ºå±€éƒ¨é‚»åŸŸçš„åŠå¾„
        self.nsample = nsample # æ¯ä¸ªé‚»åŸŸå†…é‡‡æ ·çš„å…³é”®ç‚¹æ•°é‡
        self.mlp_convs = nn.ModuleList()
        self.mlp_bns = nn.ModuleList()
        last_channel = in_channel # è¾“å…¥ç‚¹çš„ç‰¹å¾ç»´åº¦
        for out_channel in mlp:
            self.mlp_convs.append(nn.Conv2d(last_channel, out_channel, 1))
            self.mlp_bns.append(nn.BatchNorm2d(out_channel))
            last_channel = out_channel
        self.group_all = group_all

    def forward(self, xyz, points):
        """
        Input:
            xyz: input points position data, [B, C, N]
            points: input points data, [B, D, N]
        Return:
            new_xyz: sampled points position data, [B, C, S]
            new_points_concat: sample points feature data, [B, D', S]
        """
        xyz = xyz.permute(0, 2, 1) # [B, N, C]
        if points is not None:
            points = points.permute(0, 2, 1)

        # å¦‚æœ group_all=Trueï¼Œåˆ™å¯¹æ•´ä¸ªç‚¹äº‘åšå…¨å±€ç‰¹å¾æå–ã€‚
        if self.group_all:
            new_xyz, new_points = sample_and_group_all(xyz, points)
        else:  
        # å¦åˆ™ä½¿ç”¨ FPSï¼ˆæœ€è¿œç‚¹é‡‡æ ·ï¼‰é€‰å…³é”®ç‚¹ï¼Œå†ç”¨ Ball Query æ‰¾å‡ºæ¯ä¸ªç‚¹çš„å±€éƒ¨é‚»è¿‘ç‚¹ã€‚    
            # å‚æ•°: è´¨ç‚¹æ•°é‡ï¼Œé‡‡æ ·åŠå¾„ï¼Œé‡‡æ ·ç‚¹æ•°é‡ï¼Œç‚¹åæ ‡ï¼Œç‚¹é¢å¤–ç‰¹å¾
            new_xyz, new_points = sample_and_group(self.npoint, self.radius, self.nsample, xyz, points)
        # å±€éƒ¨ç‰¹å¾ç¼–ç ï¼ˆMini-PointNetï¼‰    
        # new_xyz: sampled points position data, [B, npoint, C]
        # new_points: sampled points data, [B, npoint, nsample, C+D]
        # æŠŠé‚»åŸŸç‚¹çš„æ•°æ®æ•´ç†æˆé€‚åˆå·ç§¯çš„æ ¼å¼ [B, C+D, nsample, npoint]
        new_points = new_points.permute(0, 3, 2, 1)
        # ä½¿ç”¨å¤šä¸ª Conv2d + BatchNorm + ReLU å±‚æå–ç‰¹å¾
        for i, conv in enumerate(self.mlp_convs):
            bn = self.mlp_bns[i]
            new_points =  F.relu(bn(conv(new_points))) # [B, out_channel , nsample, npoint]
        
        # å¯¹æ¯ä¸ªå±€éƒ¨åŒºåŸŸå†…æ‰€æœ‰ç‚¹çš„æœ€å¤§å“åº”å€¼è¿›è¡Œæ± åŒ–ï¼Œå¾—åˆ°è¯¥åŒºåŸŸçš„å›ºå®šé•¿åº¦ç‰¹å¾è¡¨ç¤ºã€‚
        # åœ¨ new_points çš„ç¬¬ 2 ä¸ªç»´åº¦ï¼ˆå³æ¯ä¸ªå±€éƒ¨é‚»åŸŸå†…çš„ç‚¹æ•°é‡ç»´åº¦ï¼‰ä¸Šåšæœ€å¤§æ± åŒ–ï¼ˆmax poolingï¼‰ã€‚
        # è¾“å‡ºå½¢çŠ¶ä¸º [B, out_channel, npoint]ï¼Œå³æ¯ä¸ªæŸ¥è¯¢ç‚¹æœ‰ä¸€ä¸ªç‰¹å¾å‘é‡ã€‚
        new_points = torch.max(new_points, 2)[0] # [B, out_channel, npoint]
        new_xyz = new_xyz.permute(0, 2, 1) # [B, C, npoint]
        return new_xyz, new_points # æŸ¥è¯¢ç‚¹çš„ä½ç½®(è´¨å¿ƒ) ï¼Œ æ¯ä¸ªæŸ¥è¯¢ç‚¹ç‚¹å±€éƒ¨ç‰¹å¾ã€‚
```
æœ€ç»ˆæ¯ä¸ªé‡‡æ ·å¾—åˆ°çš„å…³é”®ç‚¹æ‰€åœ¨çš„å±€éƒ¨é¢†åŸŸï¼Œéƒ½ä¼šè¢«å‹ç¼©ä¸ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„ç‰¹å¾å‘é‡ã€‚è¿™ä¸ªç‰¹å¾å‘é‡ä»£è¡¨äº†è¿™ä¸ªå±€éƒ¨åŒºåŸŸçš„é«˜ç»´ç‰¹å¾ï¼Œå®ƒåŒ…å«äº†è¿™ä¸ªåŒºåŸŸå†…æ‰€æœ‰ç‚¹çš„ä¿¡æ¯ã€‚


### å•å°ºåº¦åˆ†ç»„åˆ†ç±»æ¨¡å‹

 PointNet++ çš„ å•å°ºåº¦åˆ†ç»„ï¼ˆSSGï¼‰æ¶æ„ ï¼Œé€šè¿‡å¤šå±‚ Set Abstraction æå–ç‚¹äº‘çš„å±‚æ¬¡åŒ–ç‰¹å¾ï¼Œå¹¶æœ€ç»ˆè¾“å‡ºåˆ†ç±»ç»“æœã€‚

 > Single-Scale Grouping (SSG)

ä»£ç å®ç°å¦‚ä¸‹:

 ```python
# pointnet2_cls_ssg.py 
class get_model(nn.Module):
    # num_class: è¾“å‡ºç±»åˆ«æ•°
    # normal_channel: æ˜¯å¦åŒ…å«æ³•çº¿ä¿¡æ¯ï¼ˆé»˜è®¤æœ‰ (x,y,z,nx,ny,nz)ï¼Œå¦åˆ™åªæœ‰ (x,y,z)ï¼‰
    def __init__(self,num_class,normal_channel=True):
        super(get_model, self).__init__()
        in_channel = 6 if normal_channel else 3
        self.normal_channel = normal_channel
        # PointNet++ çš„æ ¸å¿ƒå°±æ˜¯é€å±‚æå–å±€éƒ¨ç‰¹å¾ã€‚è¿™é‡Œçš„ä¸‰ä¸ª SA å±‚æ„æˆäº†ä¸€ä¸ª ä¸‰å±‚åˆ†å±‚ç‰¹å¾å­¦ä¹ ç»“æ„ ï¼š
        self.sa1 = PointNetSetAbstraction(npoint=512, radius=0.2, nsample=32, in_channel=in_channel, mlp=[64, 64, 128], group_all=False)
        self.sa2 = PointNetSetAbstraction(npoint=128, radius=0.4, nsample=64, in_channel=128 + 3, mlp=[128, 128, 256], group_all=False)
        self.sa3 = PointNetSetAbstraction(npoint=None, radius=None, nsample=None, in_channel=256 + 3, mlp=[256, 512, 1024], group_all=True)
        self.fc1 = nn.Linear(1024, 512)
        self.bn1 = nn.BatchNorm1d(512)
        self.drop1 = nn.Dropout(0.4)
        self.fc2 = nn.Linear(512, 256)
        self.bn2 = nn.BatchNorm1d(256)
        self.drop2 = nn.Dropout(0.4)
        self.fc3 = nn.Linear(256, num_class)

    def forward(self, xyz):
        B, _, _ = xyz.shape
        if self.normal_channel:
            norm = xyz[:, 3:, :]
            xyz = xyz[:, :3, :]
        else:
            norm = None
        l1_xyz, l1_points = self.sa1(xyz, norm)
        l2_xyz, l2_points = self.sa2(l1_xyz, l1_points)
        l3_xyz, l3_points = self.sa3(l2_xyz, l2_points)
        x = l3_points.view(B, 1024)
        x = self.drop1(F.relu(self.bn1(self.fc1(x))))
        x = self.drop2(F.relu(self.bn2(self.fc2(x))))
        x = self.fc3(x)
        x = F.log_softmax(x, -1)

        return x, l3_points
 ```
å®Œæ•´çš„å•å°ºåº¦åˆ†ç»„åˆ†ç±»æµç¨‹ä¸º:
- åŸå§‹ç‚¹äº‘æ•°æ®ï¼Œé¦–æ¬¡sampleï¼Œgroupingï¼Œmini-PointNetåï¼Œå¾—åˆ°:
     -  512 ä¸ªå…³é”®ç‚¹çš„åæ ‡
     -  512 ä¸ªå…³é”®ç‚¹å¯¹åº”çš„å±€éƒ¨åŒºåŸŸç‰¹å¾å‘é‡

- äºŒæ¬¡sampleï¼Œgroupingï¼Œmini-PointNetåï¼Œå¾—åˆ°:
     -  128 ä¸ªå…³é”®ç‚¹çš„åæ ‡
     -  128 ä¸ªå…³é”®ç‚¹å¯¹åº”çš„å±€éƒ¨åŒºåŸŸç‰¹å¾å‘é‡

- ä¸‰æ¬¡sampleï¼Œgroupingï¼Œmini-PointNetåï¼Œå¾—åˆ°:
     -  1 ä¸ªå…³é”®ç‚¹çš„åæ ‡
     -  1 ä¸ªå…³é”®ç‚¹å¯¹åº”çš„å…¨å±€åŒºåŸŸç‰¹å¾å‘é‡ 

- è·å–å…¨å±€åŒºåŸŸç‰¹å¾å‘é‡åï¼Œé€šè¿‡å…¨è¿æ¥å±‚è¿›è¡Œåˆ†ç±»ã€‚

## éå‡åŒ€å¯†åº¦ä¸‹ç¨³å®šçš„ç‰¹å¾å­¦ä¹ 

ç”±äºç‚¹é›†åœ¨ä¸åŒåŒºåŸŸå¯èƒ½ä¼šæœ‰ä¸åŒçš„é‡‡æ ·å¯†åº¦ï¼Œè¿™ç§éå‡åŒ€æ€§ä¸ºç‚¹é›†ç‰¹å¾å­¦ä¹ å¸¦æ¥äº†æ˜¾è‘—æŒ‘æˆ˜ã€‚åœ¨å¯†é›†é‡‡æ ·çš„åŒºåŸŸä¸­å­¦åˆ°çš„ç‰¹å¾å¯èƒ½æ— æ³•å¾ˆå¥½åœ°æ³›åŒ–åˆ°ç¨€ç–é‡‡æ ·çš„åŒºåŸŸï¼Œåä¹‹äº¦ç„¶ã€‚å› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒPointNet++æå‡ºäº†å¯†åº¦è‡ªé€‚åº”PointNetå±‚ï¼ŒåŒ…å«ä¸¤ç§é€‚åº”æ€§ç‰¹å¾å­¦ä¹ å±‚ï¼šå¤šå°ºåº¦åˆ†ç»„ï¼ˆMulti-Scale Grouping, MSGï¼‰å’Œå¤šåˆ†è¾¨ç‡åˆ†ç»„ï¼ˆMulti-Resolution Grouping, MRGï¼‰ã€‚

### å¤šå°ºåº¦åˆ†ç»„ ï¼ˆMulti-Scale Groupingï¼‰

MSGé€šè¿‡åº”ç”¨ä¸åŒå°ºåº¦çš„åˆ†ç»„å±‚ï¼ˆ**æŒ‰ç…§ä¸åŒçš„æœç´¢åŠå¾„æˆ–é¢†åŸŸå¤§å°å¯¹ç‚¹é›†è¿›è¡Œåˆ†ç»„**ï¼‰ï¼Œç„¶åé€šè¿‡å¯¹åº”çš„PointNetsæå–æ¯ä¸ªå°ºåº¦ä¸Šçš„ç‰¹å¾æ¥æ•è·å¤šå°ºåº¦æ¨¡å¼ã€‚ä¸åŒå°ºåº¦çš„ç‰¹å¾è¢«ä¸²è”å½¢æˆå¤šå°ºåº¦ç‰¹å¾å‘é‡ã€‚è¿™ç§æ–¹æ³•ä½¿ç½‘ç»œèƒ½å¤Ÿé€šè¿‡åœ¨è®­ç»ƒæœŸé—´éšæœºä¸¢å¼ƒè¾“å…¥ç‚¹ï¼ˆç§°ä¸ºéšæœºè¾“å…¥ä¸¢å¼ƒ - random input dropoutï¼‰æ¥å­¦ä¹ ä¼˜åŒ–çš„ç­–ç•¥ï¼Œä»¥ç»“åˆæ¥è‡ªä¸åŒå°ºåº¦çš„ç‰¹å¾ã€‚è¿™æ ·ï¼Œç½‘ç»œåœ¨è®­ç»ƒæ—¶è¢«å‘ˆç°äº†ä¸åŒç¨€ç–åº¦çš„ç‚¹é›†ï¼Œä»è€Œå­¦ä¼šæ ¹æ®è¾“å…¥æ•°æ®çš„å˜åŒ–è‡ªé€‚åº”åœ°åŠ æƒä¸åŒå°ºåº¦ä¸Šæ£€æµ‹åˆ°çš„æ¨¡å¼ã€‚

![å¤šå°ºåº¦åˆ†ç»„](ç®€æPointNet++/4.png)

å…·ä½“æ¥è¯´ï¼Œåœ¨MSGä¸­ï¼Œç½‘ç»œå¯¹äºæ¯ä¸ªé€‰å®šçš„å½¢å¿ƒç‚¹ï¼ŒæŒ‰ç…§å‡ ä¸ªé¢„å®šä¹‰çš„åŠå¾„å€¼æ¥æœç´¢å‘¨å›´çš„é‚»è¿‘ç‚¹ã€‚æ¯ä¸ªåŠå¾„å®šä¹‰äº†ä¸€ä¸ªå±€éƒ¨é‚»åŸŸçš„å¤§å°ï¼Œå› æ­¤æ¯ä¸ªè´¨å¿ƒå°†æ ¹æ®è¿™äº›ä¸åŒçš„åŠå¾„å€¼ä¸å…¶å‘¨å›´ç‚¹å½¢æˆå¤šä¸ªç‚¹é›†ç¾¤ã€‚è¿™æ ·ï¼Œå¯¹äºæ¯ä¸ªè´¨å¿ƒç‚¹ï¼Œç½‘ç»œä¸æ˜¯åªæ•è·ä¸€ä¸ªå°ºåº¦ä¸Šçš„å±€éƒ¨ç‰¹å¾ï¼Œè€Œæ˜¯èƒ½å¤Ÿæ•è·å¤šä¸ªå°ºåº¦ä¸Šçš„å±€éƒ¨ç‰¹å¾ã€‚

æ¯ä¸ªå°ºåº¦ï¼ˆæˆ–æ¯ç»„é‚»åŸŸå¤§å°ï¼‰çš„ç‚¹é›†ç¾¤éƒ½å°†ç‹¬ç«‹åœ°é€å…¥å¯¹åº”çš„PointNetç½‘ç»œè¿›è¡Œç‰¹å¾æå–ï¼Œä¹‹åè¿™äº›ä¸åŒå°ºåº¦ä¸Šæå–çš„ç‰¹å¾è¢«ä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªç»¼åˆçš„å¤šå°ºåº¦ç‰¹å¾è¡¨ç¤ºã€‚è¿™ç§æ–¹æ³•ä½¿å¾—ç½‘ç»œèƒ½å¤Ÿåœ¨ç»†èŠ‚ä¸°å¯Œçš„åŒºåŸŸï¼ˆé€šè¿‡è¾ƒå°çš„é‚»åŸŸå°ºåº¦æ•è·ç»†èŠ‚ï¼‰å’Œç¨€ç–é‡‡æ ·çš„åŒºåŸŸï¼ˆé€šè¿‡è¾ƒå¤§çš„é‚»åŸŸå°ºåº¦é¿å…è¿‡åº¦ç¨€ç–çš„é—®é¢˜ï¼‰ä¸­å‡èƒ½æœ‰æ•ˆæå–ç‰¹å¾ã€‚

##### å¤šå°ºåº¦åˆ†ç»„åˆ†ç±»æ¨¡å‹

PointNetSetAbstractionMsg è¿™ä¸ªæ¨¡å—å®ç°äº† PointNet++ ä¸­çš„ å¤šå°ºåº¦ç‰¹å¾æå–æœºåˆ¶ ï¼šå¯¹äºæ¯ä¸ªå±€éƒ¨åŒºåŸŸï¼Œä½¿ç”¨å¤šä¸ªä¸åŒå¤§å°çš„é‚»åŸŸçƒï¼ˆmulti-scale ball queryï¼‰ï¼Œåˆ†åˆ«æå–ç‰¹å¾ï¼Œç„¶åå°†è¿™äº›ä¸åŒå°ºåº¦çš„ç‰¹å¾æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œä»¥è·å¾—æ›´å¼ºçš„å±€éƒ¨å‡ ä½•æ„ŸçŸ¥èƒ½åŠ›ã€‚ 

```python
class PointNetSetAbstractionMsg(nn.Module):
    def __init__(self, npoint, radius_list, nsample_list, in_channel, mlp_list):
        super(PointNetSetAbstractionMsg, self).__init__()
        self.npoint = npoint # è¦é‡‡æ ·çš„è´¨å¿ƒç‚¹æ•°é‡
        self.radius_list = radius_list # ä¸åŒå°ºåº¦çš„æŸ¥è¯¢åŠå¾„åˆ—è¡¨
        self.nsample_list = nsample_list # å¯¹åº”åŠå¾„ä¸‹æœ€å¤šå–å¤šå°‘é‚»è¿‘ç‚¹
        self.conv_blocks = nn.ModuleList() 
        self.bn_blocks = nn.ModuleList()
        # ä¸ºæ¯ä¸ªå°ºåº¦æ„å»ºä¸€ä¸ªç‹¬ç«‹çš„å°å‹ PointNetï¼ˆConv2d + BN + ReLUï¼‰
        # æ¯ä¸ªå°ºåº¦å¯ä»¥æœ‰ä¸åŒçš„ç½‘ç»œæ·±åº¦å’Œå®½åº¦
        # æ‰€æœ‰å°ºåº¦çš„ç½‘ç»œå¹¶è¡Œè¿è¡Œï¼Œæœ€åæ‹¼æ¥ç»“æœ
        for i in range(len(mlp_list)):
            convs = nn.ModuleList()
            bns = nn.ModuleList()
            last_channel = in_channel + 3
            for out_channel in mlp_list[i]:
                convs.append(nn.Conv2d(last_channel, out_channel, 1))
                bns.append(nn.BatchNorm2d(out_channel))
                last_channel = out_channel
            self.conv_blocks.append(convs)
            self.bn_blocks.append(bns)

    def forward(self, xyz, points):
        """
        Input:
            xyz: input points position data, [B, C, N]
            points: input points data, [B, D, N]
        Return:
            new_xyz: sampled points position data, [B, C, S]
            new_points_concat: sample points feature data, [B, D', S]
        """
        xyz = xyz.permute(0, 2, 1) # [B, N, C]
        if points is not None:
            points = points.permute(0, 2, 1)

        B, N, C = xyz.shape
        S = self.npoint
        # ä½¿ç”¨ FPSï¼ˆæœ€è¿œç‚¹é‡‡æ ·ï¼‰é€‰å‡º S ä¸ªå…³é”®ç‚¹ä½œä¸ºå±€éƒ¨åŒºåŸŸä¸­å¿ƒ
        new_xyz = index_points(xyz, farthest_point_sample(xyz, S))
        new_points_list = []
        for i, radius in enumerate(self.radius_list):
            K = self.nsample_list[i]
            # å¯¹æ¯ä¸ªåŠå¾„ radiusï¼Œæ‰¾å‡ºè¯¥å°ºåº¦ä¸‹æ¯ä¸ªè´¨å¿ƒç‚¹å‘¨å›´çš„é‚»è¿‘ç‚¹
            group_idx = query_ball_point(radius, K, xyz, new_xyz)
            grouped_xyz = index_points(xyz, group_idx)
            # æŠŠè¿™äº›ç‚¹çš„åæ ‡å½’ä¸€åŒ–åˆ°ä»¥è´¨å¿ƒä¸ºä¸­å¿ƒçš„å±€éƒ¨åæ ‡ç³»ä¸‹
            grouped_xyz -= new_xyz.view(B, S, 1, C)
            # å¦‚æœæœ‰é¢å¤–ç‰¹å¾ï¼Œä¹Ÿä¸€å¹¶åŠ å…¥
            if points is not None:
                grouped_points = index_points(points, group_idx)
                grouped_points = torch.cat([grouped_points, grouped_xyz], dim=-1)
            else:
                grouped_points = grouped_xyz
            
            # å¯¹æ¯ä¸ªå°ºåº¦çš„å±€éƒ¨ç‚¹é›†åº”ç”¨å¯¹åº”çš„ Conv2d + BN + ReLU
            grouped_points = grouped_points.permute(0, 3, 2, 1)  # [B, D, K, S]
            for j in range(len(self.conv_blocks[i])):
                conv = self.conv_blocks[i][j]
                bn = self.bn_blocks[i][j]
                grouped_points =  F.relu(bn(conv(grouped_points)))
            # ä½¿ç”¨æœ€å¤§æ± åŒ–èšåˆå±€éƒ¨ä¿¡æ¯ï¼Œç”Ÿæˆå›ºå®šé•¿åº¦çš„ç‰¹å¾å‘é‡    
            new_points = torch.max(grouped_points, 2)[0]  # [B, D', S]
            # æ‰€æœ‰å°ºåº¦çš„ç‰¹å¾ä¿å­˜åˆ° new_points_list
            new_points_list.append(new_points)
        
        new_xyz = new_xyz.permute(0, 2, 1)
        # æŠŠä¸åŒå°ºåº¦å­¦åˆ°çš„ç‰¹å¾æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆçš„å±€éƒ¨ç‰¹å¾è¡¨ç¤º
        new_points_concat = torch.cat(new_points_list, dim=1) 
        # æœ€ç»ˆè¾“å‡ºå°±æ˜¯ï¼š ä¸€ç»„æ–°çš„å…³é”®ç‚¹ä½ç½®ï¼› æ¯ä¸ªå…³é”®ç‚¹çš„å¤šå°ºåº¦ç‰¹å¾è¡¨ç¤º
        return new_xyz, new_points_concat
```

pointnet2_cls_msg è¿™ä¸ªæ¨¡å‹ä½¿ç”¨äº† PointNet++ çš„ å¤šå°ºåº¦åˆ†ç»„ï¼ˆMSGï¼‰ç­–ç•¥ ï¼Œé€šè¿‡å¤šä¸ªå±€éƒ¨åŒºåŸŸçƒæŸ¥è¯¢æå–ä¸åŒå°ºåº¦çš„å±€éƒ¨ç‰¹å¾ï¼Œé€å±‚æŠ½è±¡åèåˆæˆå…¨å±€ç‰¹å¾ï¼Œæœ€åé€šè¿‡å…¨è¿æ¥å±‚å®Œæˆåˆ†ç±»ä»»åŠ¡ã€‚

```python
# pointnet2_cls_msg.py
class get_model(nn.Module):
    def __init__(self,num_class,normal_channel=True):
        super(get_model, self).__init__()
        in_channel = 3 if normal_channel else 0
        self.normal_channel = normal_channel
        self.sa1 = PointNetSetAbstractionMsg(512, [0.1, 0.2, 0.4], [16, 32, 128], in_channel,[[32, 32, 64], [64, 64, 128], [64, 96, 128]])
        self.sa2 = PointNetSetAbstractionMsg(128, [0.2, 0.4, 0.8], [32, 64, 128], 320,[[64, 64, 128], [128, 128, 256], [128, 128, 256]])
        self.sa3 = PointNetSetAbstraction(None, None, None, 640 + 3, [256, 512, 1024], True)
        self.fc1 = nn.Linear(1024, 512)
        self.bn1 = nn.BatchNorm1d(512)
        self.drop1 = nn.Dropout(0.4)
        self.fc2 = nn.Linear(512, 256)
        self.bn2 = nn.BatchNorm1d(256)
        self.drop2 = nn.Dropout(0.5)
        self.fc3 = nn.Linear(256, num_class)

    def forward(self, xyz):
        B, _, _ = xyz.shape
        if self.normal_channel:
            norm = xyz[:, 3:, :]
            xyz = xyz[:, :3, :]
        else:
            norm = None
        l1_xyz, l1_points = self.sa1(xyz, norm)
        l2_xyz, l2_points = self.sa2(l1_xyz, l1_points)
        l3_xyz, l3_points = self.sa3(l2_xyz, l2_points)
        x = l3_points.view(B, 1024)
        x = self.drop1(F.relu(self.bn1(self.fc1(x))))
        x = self.drop2(F.relu(self.bn2(self.fc2(x))))
        x = self.fc3(x)
        x = F.log_softmax(x, -1)


        return x,l3_points
```

MSGçš„å…³é”®ä¼˜ç‚¹åœ¨äºå®ƒé€šè¿‡åœ¨è®­ç»ƒæœŸé—´çš„éšæœºè¾“å…¥ä¸¢å¼ƒï¼ˆå³éšæœºç§»é™¤ä¸€éƒ¨åˆ†è¾“å…¥ç‚¹ï¼‰æ¥æ¨¡æ‹Ÿä¸åŒçš„é‡‡æ ·å¯†åº¦ï¼Œä»è€Œè®­ç»ƒç½‘ç»œåœ¨é¢å¯¹å®é™…åº”ç”¨ä¸­å¯èƒ½é‡åˆ°çš„å„ç§é‡‡æ ·å¯†åº¦æ—¶ï¼Œèƒ½å¤Ÿè‡ªé€‚åº”åœ°é€‰æ‹©æœ€é€‚åˆçš„ç‰¹å¾å°ºåº¦è¿›è¡Œç»„åˆï¼Œä»¥å®ç°æœ€ä½³çš„æ€§èƒ½ã€‚è¿™ç§æ–¹æ³•å¤§å¤§å¢å¼ºäº†ç½‘ç»œå¤„ç†éå‡åŒ€é‡‡æ ·æ•°æ®çš„èƒ½åŠ›ï¼Œæé«˜äº†æ¨¡å‹çš„æ³›åŒ–æ€§å’Œç¨³å¥æ€§ã€‚

> åœ¨è®­ç»ƒæ—¶å¼•å…¥ä¸åŒå¯†åº¦çš„ç‚¹é›†æƒ…å†µï¼Œä½¿ç½‘ç»œèƒ½å­¦ä¹ ä¸åŒé‡‡æ ·å¯†åº¦ä¸‹å±€éƒ¨ç‚¹äº‘ç‰¹å¾çš„æå–ï¼Œæ•è·å¯†é›†åˆ°ç¨€ç–é‡‡æ ·åŒºåŸŸå†…çš„å¤šå°ºåº¦ä¿¡æ¯ -- é€šè¿‡éšæœºä¸¢å¼ƒæ¥æ¨¡æ‹Ÿä¸åŒå¯†åº¦çš„é‡‡æ ·ï¼Œä½¿ç½‘ç»œèƒ½å¤Ÿåº”å¯¹å®é™…ä¸­å„ç§å¯†åº¦å˜æ¢çš„æƒ…å†µ-æé«˜æ¨¡å‹çš„æ³›åŒ–æ€§èƒ½ã€‚

MSGç›¸å½“äºå¹¶è”äº†å¤šä¸ªhierarchical structureï¼Œæ¯ä¸ªç»“æ„ä¸­å¿ƒç‚¹ä¸å˜ï¼Œä½†æ˜¯å°ºåº¦ä¸åŒã€‚é€šè¿‡PointNetè·å–æ¯ä¸ªå½¢å¿ƒå¤šå°ºåº¦ä¿¡æ¯ï¼Œä¹‹åconcatå½¢æˆè¯¥åŒºåŸŸæå–çš„æ€»ç‰¹å¾ã€‚åœ¨è®­ç»ƒæ—¶å¼•å…¥éšæœºä¸¢å¼ƒå½¢å¿ƒæ¥æ¨¡æ‹Ÿä¸åŒå¯†åº¦æƒ…å†µï¼Œæé«˜ç®—æ³•é²æ£’æ€§ã€‚

 #### å¤šåˆ†è¾¨ç‡åˆ†ç»„ï¼ˆMulti-Resolution Groupingï¼‰

MSGæ–¹æ³•è™½ç„¶æœ‰æ•ˆï¼Œä½†åœ¨è®¡ç®—ä¸Šå¯èƒ½éå¸¸æ˜‚è´µï¼Œå°¤å…¶æ˜¯åœ¨ä½å±‚æ¬¡ä¸Šå¯¹æ¯ä¸ªè´¨å¿ƒç‚¹è¿è¡Œå±€éƒ¨PointNetæ—¶ã€‚ä¸ºæ­¤ï¼ŒMRGä¸ºä¸€ç§ä½æˆæœ¬çš„æ›¿ä»£æ–¹æ¡ˆã€‚

MRGé€šè¿‡ç»“åˆæ¥è‡ªä¸åŒåˆ†è¾¨ç‡çš„ç‰¹å¾æ¥å®ç°æ•ˆç‡å’Œé€‚åº”æ€§çš„å¹³è¡¡ã€‚å…·ä½“è€Œè¨€ï¼ŒMRGç­–ç•¥åœ¨å¤„ç†æ¯ä¸ªå±€éƒ¨åŒºåŸŸæ—¶ï¼Œä¸ä»…è€ƒè™‘ä»å½“å‰åˆ†è¾¨ç‡ä¸‹æŠ½è±¡å¾—åˆ°çš„ç‰¹å¾ï¼Œè¿˜è€ƒè™‘äº†ä»æ›´ä½åˆ†è¾¨ç‡ï¼ˆå³ä¸Šä¸€å±‚çº§ï¼‰ç›´æ¥æå–çš„ç‰¹å¾ã€‚è¿™ä¸¤ç§ç‰¹å¾è¢«concatä¸ºä¸€ä¸ªå¤åˆç‰¹å¾å‘é‡ï¼Œä¸ºåç»­çš„å¤„ç†æ­¥éª¤æä¾›ä¿¡æ¯ã€‚

![å¤šåˆ†è¾¨ç‡åˆ†ç»„](ç®€æPointNet++/5.png)

åœ¨MRGä¸­ï¼ŒæŸä¸€å±‚æ¬¡ğ¿ğ‘–çš„åŒºåŸŸç‰¹å¾æ˜¯é€šè¿‡å°†æ¥è‡ªä¸‹ä¸€çº§ğ¿ğ‘–âˆ’1çš„å­åŒºåŸŸç‰¹å¾æ€»ç»“åçš„å‘é‡ä¸ç›´æ¥å¤„ç†è¯¥å±€éƒ¨åŒºåŸŸæ‰€æœ‰åŸå§‹ç‚¹çš„å•ä¸ªPointNetå¾—åˆ°çš„ç‰¹å¾å‘é‡è¿›è¡Œconcatå¾—åˆ°çš„ã€‚å½“å±€éƒ¨åŒºåŸŸçš„å¯†åº¦è¾ƒä½æ—¶ï¼Œç”±äºå­åŒºåŸŸåœ¨è®¡ç®—ç¬¬ä¸€ä¸ªå‘é‡æ—¶åŒ…å«çš„ç‚¹æ›´ç¨€ç–ï¼Œå› æ­¤å¯èƒ½æ¯”ç¬¬äºŒä¸ªå‘é‡æ›´ä¸å¯é ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥æ›´é«˜åœ°åŠ æƒç¬¬äºŒä¸ªå‘é‡ã€‚ç›¸åï¼Œå½“å±€éƒ¨åŒºåŸŸçš„å¯†åº¦è¾ƒé«˜æ—¶ï¼Œç¬¬ä¸€ä¸ªå‘é‡æä¾›äº†æ›´ç»†è‡´çš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿåœ¨æ›´ä½å±‚æ¬¡ä¸Šé€’å½’åœ°æ£€è§†æ›´é«˜åˆ†è¾¨ç‡ã€‚

> æ¥è‡ªä¸‹ä¸€çº§çš„ç‰¹å¾ï¼šé¦–å…ˆï¼Œå°†æ¥è‡ªä¸‹ä¸€çº§ï¼ˆæ›´é«˜åˆ†è¾¨ç‡ï¼‰çš„ç‰¹å¾è¿›è¡Œæ±‡æ€»ï¼Œå½¢æˆä¸€ä¸ªç‰¹å¾å‘é‡ã€‚è¿™ä¸€è¿‡ç¨‹é€šè¿‡å¯¹æ¯ä¸ªå­åŒºåŸŸåº”ç”¨é›†åˆæŠ½è±¡å±‚ï¼ˆset abstraction levelï¼‰å®Œæˆã€‚

> ç›´æ¥å¤„ç†çš„åŸå§‹ç‚¹ç‰¹å¾ï¼šå¦ä¸€éƒ¨åˆ†ç‰¹å¾æ˜¯é€šè¿‡åœ¨å½“å‰åˆ†è¾¨ç‡ç›´æ¥å¯¹æ‰€æœ‰åŸå§‹ç‚¹åº”ç”¨å•ä¸ªPointNetå¾—åˆ°çš„ã€‚

## ç‚¹äº‘è¯­ä¹‰åˆ†å‰²

**PointNet++ å®Œæˆç‚¹äº‘åˆ†å‰²ä»»åŠ¡çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œç¼–ç -è§£ç â€ç»“æ„**ï¼Œç»“åˆäº†å±‚çº§ç‰¹å¾æå–å’Œå¤šå°ºåº¦èåˆæœºåˆ¶ã€‚

**ç›®æ ‡:** ç»™å®šä¸€ä¸ªç‚¹äº‘ï¼Œæ¨¡å‹éœ€è¦ä¸ºæ¯ä¸ªç‚¹é¢„æµ‹ä¸€ä¸ªç±»åˆ«æ ‡ç­¾ï¼ˆå¦‚æ¡Œå­ã€æ¤…å­ã€å¢™å£ç­‰ï¼‰ã€‚

- è¾“å…¥ï¼š`xyz: [B, N, 3]`  

- è¾“å‡ºï¼š`labels: [B, N, C]`ï¼Œå…¶ä¸­ `C` æ˜¯ç±»åˆ«æ•°


PointNet++ åˆ†å‰²çš„æ•´ä½“ç»“æ„ :

```python
Input Points (xyz): [ B, N, 3 ]
        â†“
Set Abstraction Layersï¼ˆç¼–ç å™¨ï¼‰
        â†“
Feature Vectors at Multiple Scales
        â†“
Feature Propagation Layersï¼ˆè§£ç å™¨ï¼‰
        â†“
Recovered Features at Original Resolution
        â†“
MLP + Softmax â†’ Per-point Semantic Labels
```
---

**ç¬¬ä¸€æ­¥ï¼šSet Abstractionï¼ˆé›†åˆæŠ½è±¡ï¼‰â€”â€” ç¼–ç å™¨:** å¯¹ç‚¹äº‘è¿›è¡Œä¸‹é‡‡æ ·ï¼Œå¹¶åœ¨æ¯ä¸ªå±€éƒ¨åŒºåŸŸæå–ç‰¹å¾ã€‚

æ ¸å¿ƒæ“ä½œåŒ…æ‹¬ï¼š

1. **FPSï¼ˆFarthest Point Samplingï¼‰**ï¼šä»ç‚¹äº‘ä¸­é€‰å‡ºæœ‰ä»£è¡¨æ€§çš„ç‚¹ä½œä¸ºä¸­å¿ƒç‚¹ã€‚

2. **Ball Query**ï¼šä¸ºæ¯ä¸ªä¸­å¿ƒç‚¹æ‰¾åˆ°å…¶é‚»åŸŸå†…çš„ç‚¹ã€‚

3. **Grouping**ï¼šå°†é‚»åŸŸç‚¹ç»„åˆæˆå±€éƒ¨ç‚¹äº‘ç»„ã€‚

4. **PointNet æ“ä½œ**ï¼šä½¿ç”¨ T-Net å¯¹å±€éƒ¨ç‚¹äº‘è¿›è¡Œå˜æ¢ï¼Œç„¶åé€šè¿‡ MLP æå–ç‰¹å¾ã€‚

5. **Pooling**ï¼šå¯¹å±€éƒ¨ç‚¹äº‘ç»„åšæœ€å¤§æ± åŒ–æˆ–å¹³å‡æ± åŒ–ï¼Œå¾—åˆ°è¯¥åŒºåŸŸçš„ç‰¹å¾ã€‚

> å¤šä¸ª Set Abstraction å±‚å †å ï¼Œé€æ­¥å‡å°‘ç‚¹çš„æ•°é‡ï¼Œå¢åŠ ç‰¹å¾ç»´åº¦ï¼Œå½¢æˆå¤šå°ºåº¦ç‰¹å¾è¡¨ç¤ºã€‚

---

**ç¬¬äºŒæ­¥ï¼šFeature Propagationï¼ˆç‰¹å¾ä¼ æ’­ï¼‰â€”â€” è§£ç å™¨:** ä»æœ€ç¨€ç–çš„ç‚¹å¼€å§‹ï¼Œé€å±‚å°†ç‰¹å¾æ’å€¼å›åŸå§‹ç‚¹æ•°é‡ã€‚

ç‰¹å¾æ’å€¼æ–¹å¼ï¼š

- ä½¿ç”¨ **åè·ç¦»åŠ æƒæ’å€¼ï¼ˆIDWï¼‰**ï¼Œå³æ ¹æ®æœ€è¿‘çš„å‡ ä¸ªé‚»è¿‘ç‚¹çš„è·ç¦»è¿›è¡ŒåŠ æƒå¹³å‡ã€‚

- å¯é€‰åœ°æ‹¼æ¥ skip connection ä¸­çš„åŸå§‹ç‰¹å¾ï¼ˆæ¥è‡ª Set Abstraction å‰çš„æŸä¸€å±‚ï¼‰ã€‚

è¾“å…¥è¾“å‡ºç¤ºä¾‹ï¼š

```python
def forward(xyz1, xyz2, points1, points2):
    # xyz1: åŸå§‹ç‚¹åæ ‡ï¼ˆå¤šï¼‰
    # xyz2: ä¸‹é‡‡æ ·ç‚¹åæ ‡ï¼ˆå°‘ï¼‰
    # points1: åŸå§‹ç‚¹ç‰¹å¾ï¼ˆå¯ä¸ºç©ºï¼‰
    # points2: ä¸‹é‡‡æ ·ç‚¹ç‰¹å¾
    return interpolated_points  # æ’å€¼å¾—åˆ°çš„å¯†é›†ç‰¹å¾ï¼Œå½¢çŠ¶ä¸ xyz1 ä¸€è‡´
```

> å¤šä¸ª Feature Propagation å±‚å †å ï¼Œé€æ¸æ¢å¤ç‚¹æ•°ï¼Œæœ€ç»ˆå›åˆ°åŸå§‹ç‚¹æ•°é‡ã€‚

---

**ç¬¬ä¸‰æ­¥ï¼šHead é¢„æµ‹å¤´ â€”â€” åˆ†ç±»æ¯ä¸ªç‚¹:** å¯¹æ¯ä¸ªç‚¹çš„ç‰¹å¾åšä¸€ä¸ªç®€å•çš„åˆ†ç±»å™¨ï¼Œè¾“å‡ºç±»åˆ«æ¦‚ç‡ã€‚

å®ç°æ–¹å¼ï¼š

- å°†æœ€åä¸€å±‚ Feature Propagation è¾“å‡ºçš„ç‰¹å¾é€å…¥ä¸€ä¸ªå°å‹ MLPã€‚

- æœ€åä¸€å±‚ä½¿ç”¨ `Softmax`ï¼ˆå¯¹äºå¤šåˆ†ç±»ï¼‰æˆ– `Sigmoid`ï¼ˆå¯¹äºå¤šæ ‡ç­¾ï¼‰æ¿€æ´»å‡½æ•°ã€‚

ä¾‹å¦‚ï¼š

```python
mlp = nn.Sequential(
    nn.Conv1d(128, 128, 1),
    nn.BatchNorm1d(128),
    nn.ReLU(),
    nn.Dropout(0.5),
    nn.Conv1d(128, num_classes, 1)
)
logits = mlp(final_features)  # shape: [B, C, N]
```

### ä»£ç å®ç°

PointNet++ çš„æ•´ä½“ç»“æ„æ˜¯ä¸€ä¸ªå…¸å‹çš„ ç¼–ç å™¨-è§£ç å™¨ï¼ˆEncoder-Decoderï¼‰æ¶æ„ ï¼š

- Set Abstraction å±‚ ï¼šä¸æ–­å¯¹ç‚¹äº‘è¿›è¡Œä¸‹é‡‡æ · + æå–å±€éƒ¨ç‰¹å¾ï¼ˆç¼–ç è¿‡ç¨‹ï¼‰

- Feature Propagation å±‚ ï¼šä»æœ€ç¨€ç–çš„ç‚¹å¼€å§‹ï¼Œé€å±‚æ¢å¤åˆ°åŸå§‹ç‚¹æ•°ï¼ˆè§£ç è¿‡ç¨‹ï¼‰

```
[Input Points] 
      â†“
SA Layer 1 â†’ [Points: 1024 â†’ 512]
      â†“
SA Layer 2 â†’ [Points: 512 â†’ 128]
      â†“
SA Layer 3 â†’ [Points: 128 â†’ 32]
      â†“
FP Layer 3 â† [Points: 32 â†’ 128]
      â†“
FP Layer 2 â† [Points: 128 â†’ 512]
      â†“
FP Layer 1 â† [Points: 512 â†’ 1024]
      â†“
[Per-point Classification Head]
      â†“
[Output: per-point labels]
```

#### ç‰¹å¾ä¼ æ’­å±‚

PointNetFeaturePropagation æ˜¯ PointNet++ ä¸­ç”¨äºç‚¹äº‘â€œç‰¹å¾ä¼ æ’­â€ï¼ˆFeature Propagationï¼‰çš„æ ¸å¿ƒæ¨¡å—ï¼Œä¸»è¦ä½œç”¨æ˜¯ï¼š

- å°†ç¨€ç–ç‚¹é›†çš„ç‰¹å¾æ’å€¼å›åŸå§‹ç‚¹é›†çš„ä½ç½®ä¸Šã€‚

æ¢å¥è¯è¯´ï¼š

- è¾“å…¥ï¼šå°‘é‡ç‚¹çš„åæ ‡ + ç‰¹å¾ï¼ˆå¦‚ç»è¿‡ä¸‹é‡‡æ ·åçš„ç‚¹ï¼‰

- è¾“å‡ºï¼šåœ¨åŸå§‹ç‚¹æ•°é‡ä¸‹çš„æ¯ä¸ªç‚¹éƒ½æ‹¥æœ‰ä¸€ä¸ªåˆç†çš„ç‰¹å¾å‘é‡

è¿™ä¸€æ­¥ç›¸å½“äºå›¾åƒä»»åŠ¡ä¸­çš„ ä¸Šé‡‡æ ·ï¼ˆupsampleï¼‰æˆ–è½¬ç½®å·ç§¯ï¼ˆtranspose convolutionï¼‰ ï¼Œä½†åœ¨ç‚¹äº‘è¿™ç§éç»“æ„åŒ–æ•°æ®ä¸­ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨è¿™äº›æ“ä½œã€‚

```python
class PointNetFeaturePropagation(nn.Module):
    def __init__(self, in_channel, mlp):
        """
        åˆå§‹åŒ–å‡½æ•°ï¼Œæ„å»ºç”¨äºç‰¹å¾ä¼ æ’­ï¼ˆä¸Šé‡‡æ ·ï¼‰çš„MLPå±‚
        
        å‚æ•°ï¼š
            in_channel: è¾“å…¥ç‰¹å¾çš„é€šé“æ•°ï¼ˆç»´åº¦ï¼‰
            mlp: ä¸€ä¸ªåˆ—è¡¨ï¼Œè¡¨ç¤ºæ¯ä¸€å±‚MLPçš„è¾“å‡ºé€šé“æ•°ï¼Œä¾‹å¦‚ [64, 128]
        """
        super(PointNetFeaturePropagation, self).__init__()
        
        # ç”¨äºä¿å­˜å·ç§¯å±‚å’Œæ‰¹å½’ä¸€åŒ–å±‚
        self.mlp_convs = nn.ModuleList()
        self.mlp_bns = nn.ModuleList()
        
        last_channel = in_channel  # å½“å‰è¾“å…¥é€šé“æ•°åˆå§‹åŒ–ä¸ºin_channel

        # æ„å»ºMLPå±‚ï¼šæ¯ä¸ªå±‚æ˜¯ä¸€ä¸ªConv1d + BatchNorm1d + ReLU
        for out_channel in mlp:
            self.mlp_convs.append(nn.Conv1d(last_channel, out_channel, 1))
            self.mlp_bns.append(nn.BatchNorm1d(out_channel))
            last_channel = out_channel  # æ›´æ–°ä¸‹ä¸€å±‚çš„è¾“å…¥é€šé“æ•°

    def forward(self, xyz1, xyz2, points1, points2):
        """
        å‰å‘ä¼ æ’­å‡½æ•°ï¼šå°†ç¨€ç–ç‚¹é›†points2æ’å€¼åˆ°å¯†é›†ç‚¹é›†xyz1çš„ä½ç½®ä¸Š

        å‚æ•°ï¼š
            xyz1: åŸå§‹ç‚¹åæ ‡æ•°æ®ï¼Œå½¢çŠ¶ [B, C, N] ï¼ˆå¦‚ 1024 ä¸ªç‚¹ï¼‰
            xyz2: ä¸‹é‡‡æ ·åçš„ç‚¹åæ ‡æ•°æ®ï¼Œå½¢çŠ¶ [B, C, S] ï¼ˆå¦‚ 256 ä¸ªç‚¹ï¼‰
            points1: åŸå§‹ç‚¹å¯¹åº”çš„ç‰¹å¾æ•°æ®ï¼Œå½¢çŠ¶ [B, D, N] ï¼ˆå¯ä¸º Noneï¼‰
            points2: ä¸‹é‡‡æ ·ç‚¹å¯¹åº”çš„ç‰¹å¾æ•°æ®ï¼Œå½¢çŠ¶ [B, D, S]

        è¿”å›ï¼š
            new_points: æ’å€¼å¹¶èåˆåçš„ç‰¹å¾ï¼Œå½¢çŠ¶ [B, D', N]
        """
        # å°†åæ ‡å’Œç‰¹å¾ä» [B, C, N] è½¬æ¢ä¸º [B, N, C] æ ¼å¼ï¼Œä¾¿äºåç»­è®¡ç®—
        xyz1 = xyz1.permute(0, 2, 1)     # [B, N, C]
        xyz2 = xyz2.permute(0, 2, 1)     # [B, S, C]
        points2 = points2.permute(0, 2, 1)  # [B, S, D]

        B, N, C = xyz1.shape             # åŸå§‹ç‚¹æ•°é‡ N
        _, S, _ = xyz2.shape             # ä¸‹é‡‡æ ·ç‚¹æ•°é‡ S

        # å¦‚æœåªæœ‰1ä¸ªä¸‹é‡‡æ ·ç‚¹ï¼Œç›´æ¥å¤åˆ¶å…¶ç‰¹å¾åˆ°æ‰€æœ‰åŸå§‹ç‚¹
        if S == 1:
            interpolated_points = points2.repeat(1, N, 1)  # [B, N, D]

        else:
            # è®¡ç®—åŸå§‹ç‚¹ä¸ä¸‹é‡‡æ ·ç‚¹ä¹‹é—´çš„è·ç¦»çŸ©é˜µï¼ˆæ¬§æ°è·ç¦»å¹³æ–¹ï¼‰
            dists = square_distance(xyz1, xyz2)  # [B, N, S]

            # å¯¹æ¯ä¸ªåŸå§‹ç‚¹ï¼Œæ‰¾åˆ°æœ€è¿‘çš„3ä¸ªé‚»è¿‘ç‚¹
            dists, idx = dists.sort(dim=-1)
            dists = dists[:, :, :3]   # å–æœ€å°çš„ä¸‰ä¸ªè·ç¦» [B, N, 3]
            idx = idx[:, :, :3]       # å–å¯¹åº”çš„ç´¢å¼• [B, N, 3]

            # ä½¿ç”¨åè·ç¦»åŠ æƒï¼ˆIDWï¼‰è®¡ç®—æƒé‡:
            # 1.å°†è·ç¦»è½¬æ¢ä¸ºâ€œæƒé‡â€ï¼Œè·ç¦»è¶Šè¿‘ï¼Œæƒé‡è¶Šå¤§
            dist_recip = 1.0 / (dists + 1e-8)  # é¿å…é™¤ä»¥é›¶
            # 2.å¯¹æ¯ä¸ªç‚¹çš„3ä¸ªæƒé‡æ±‚å’Œï¼Œå¾—åˆ°å½’ä¸€åŒ–å› å­
            norm = torch.sum(dist_recip, dim=2, keepdim=True)  # å½’ä¸€åŒ–å› å­
            # 3.å½’ä¸€åŒ–æƒé‡ï¼Œä½¿å¾—æ¯ä¸ªç‚¹çš„æƒé‡ä¹‹å’Œä¸º1
            weight = dist_recip / norm  # åŠ æƒå¹³å‡ç³»æ•° [B, N, 3]

            # ä¸ºæ¯ä¸ªåŸå§‹ç‚¹ï¼Œæ‰¾åˆ°å®ƒæœ€è¿‘çš„ 3 ä¸ªé‚»è¿‘ç‚¹ï¼Œæ ¹æ®è·ç¦»åˆ†é…æƒé‡ï¼Œç„¶åå¯¹å®ƒä»¬çš„ç‰¹å¾åšåŠ æƒå¹³å‡ï¼Œä»è€Œæ’å€¼å¾—åˆ°è¯¥ç‚¹çš„ç‰¹å¾ã€‚ 
            # index_points: [B, S, D] -> [B, N, 3, D]
            # weight.view(B, N, 3, 1): æ‰©å±•ç»´åº¦åç›¸ä¹˜
            interpolated_points = torch.sum(
                # 1. ä»ä¸‹é‡‡æ ·ç‚¹ä¸­å–å‡ºæ¯ä¸ªåŸå§‹ç‚¹å¯¹åº”çš„æœ€è¿‘é‚»ç‚¹çš„ç‰¹å¾ã€‚
                #    points2: [B, S, D] â€”â€” ä¸‹é‡‡æ ·ç‚¹çš„ç‰¹å¾ï¼ˆS ä¸ªç‚¹ï¼Œæ¯ä¸ªç‚¹æœ‰ D ç»´ç‰¹å¾ï¼‰
                #    idx: [B, N, 3] â€”â€” æ¯ä¸ªåŸå§‹ç‚¹å¯¹åº”çš„ 3 ä¸ªæœ€è¿‘é‚»ç‚¹ç´¢å¼•
                #    [B, N, 3, D] â€”â€” æ¯ä¸ªåŸå§‹ç‚¹éƒ½æœ‰äº†å®ƒæœ€è¿‘çš„ 3 ä¸ªé‚»è¿‘ç‚¹çš„ç‰¹å¾
                index_points(points2, idx) 
                # å°†ä¹‹å‰è®¡ç®—å¥½çš„æƒé‡æ‰©å±•ç»´åº¦ï¼Œä»¥ä¾¿å’Œç‰¹å¾ç›¸ä¹˜ã€‚
                # weight: [B, N, 3] â€”â€” æ¯ä¸ªç‚¹çš„ä¸‰ä¸ªé‚»è¿‘ç‚¹çš„æƒé‡
                # [B, N, 3, 1] â€”â€” æ‰©å±•åä¾¿äºå¹¿æ’­ä¹˜æ³•
                * weight.view(B, N, 3, 1),
                dim=2
            )  # [B, N, D]

        # å¦‚æœåŸå§‹ç‚¹æœ‰ç‰¹å¾ï¼Œåˆ™æ‹¼æ¥èµ·æ¥ï¼ˆskip connectionï¼‰
        if points1 is not None:
            points1 = points1.permute(0, 2, 1)  # [B, N, D]
            new_points = torch.cat([points1, interpolated_points], dim=-1)  # [B, N, D1+D2]
        else:
            new_points = interpolated_points  # [B, N, D]

        # æ¢å¤å¼ é‡æ ¼å¼ä¸º [B, D, N]ï¼Œä»¥é€‚é…åé¢çš„å·ç§¯æ“ä½œ
        new_points = new_points.permute(0, 2, 1)  # [B, D', N]

        # ç»è¿‡MLPè¿›ä¸€æ­¥æå–å’Œèåˆç‰¹å¾
        for i, conv in enumerate(self.mlp_convs):
            bn = self.mlp_bns[i]
            new_points = F.relu(bn(conv(new_points)))  # Conv1d + BN + ReLU

        return new_points  # æœ€ç»ˆè¾“å‡ºç‰¹å¾ [B, D', N]
```
æµç¨‹å››æ­¥èµ°ï¼š

1ï¸âƒ£ æ‰¾åˆ°é‚»å±…  â€œæˆ‘è¿™ä¸ªç‚¹æœ€è¿‘çš„3ä¸ªç†Ÿäººæ˜¯è°ï¼Ÿâ€ 

- è®¡ç®—æ¯ä¸ªåŸå§‹ç‚¹å’Œä¸‹é‡‡æ ·ç‚¹ä¹‹é—´çš„è·ç¦»ï¼›

- æ‰¾å‡ºæœ€è¿‘çš„3ä¸ªé‚»è¿‘ç‚¹ã€‚

2ï¸âƒ£ åˆ†é…æƒé‡  â€œè°ç¦»æˆ‘è¶Šè¿‘ï¼Œè¯´è¯è¶Šæœ‰åˆ†é‡ã€‚â€ 

- æ ¹æ®è·ç¦»åæ¯”åŠ æƒï¼ˆIDWï¼‰ï¼Œç»™è¿™3ä¸ªé‚»è¿‘ç‚¹åˆ†é…æƒé‡ï¼›

- æƒé‡å½’ä¸€åŒ–ï¼Œç¡®ä¿å®ƒä»¬åŠ èµ·æ¥æ˜¯1ã€‚


3ï¸âƒ£ åŠ æƒå¹³å‡æ’å€¼   â€œç»¼åˆæœ€è¿‘å‡ ä¸ªç†Ÿäººçš„æ„è§ï¼ŒçŒœå‡ºæˆ‘çš„ç‰¹å¾ã€‚â€ 

- æå–é‚»è¿‘ç‚¹çš„ç‰¹å¾ï¼›

- æŒ‰ç…§æƒé‡åšåŠ æƒå¹³å‡ï¼›

- å¾—åˆ°æ¯ä¸ªåŸå§‹ç‚¹çš„æ’å€¼ç‰¹å¾ã€‚

4ï¸âƒ£ èåˆ+å¢å¼º  â€œå¦‚æœæˆ‘æœ¬æ¥å°±æœ‰ç‰¹å¾ï¼Œé‚£å°±ä¸€èµ·ç”¨ï¼›å†ç”¨MLPææç¥ã€‚â€ 

- å¦‚æœåŸå§‹ç‚¹æœ‰è‡ªå·±çš„ç‰¹å¾ï¼ˆpoints1ï¼‰ï¼Œå°±æ‹¼æ¥èµ·æ¥ï¼›

- ç»è¿‡å‡ å±‚ Conv1d + BN + ReLUï¼Œè¿›ä¸€æ­¥æå–å’Œèåˆç‰¹å¾ï¼›

- è¾“å‡ºæœ€ç»ˆçš„æ’å€¼åç‰¹å¾ã€‚

ğŸ“¦ è¾“å‡ºç»“æœ

- new_points: æ¯ä¸ªåŸå§‹ç‚¹éƒ½æœ‰äº†ä¸€ä¸ªæ–°çš„ç‰¹å¾å‘é‡ [B, D', N]

#### ç‚¹äº‘è¯­ä¹‰åˆ†å‰²æ¨¡å‹

ä¸‹é¢ç»™å‡ºçš„æ˜¯ä¸€ä¸ªåŸºäºPointNet++çš„ç‚¹äº‘è¯­ä¹‰åˆ†å‰²æ¨¡å‹å®šä¹‰ ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯ï¼š

- å¯¹è¾“å…¥ç‚¹äº‘ä¸­çš„æ¯ä¸ªç‚¹è¿›è¡Œåˆ†ç±»ï¼ˆå¦‚æ¡Œå­ã€æ¤…å­ã€åœ°æ¿ç­‰ï¼‰ï¼Œè¾“å‡ºæ¯ä¸ªç‚¹çš„ç±»åˆ«æ¦‚ç‡ã€‚ 

ç½‘ç»œç»“æ„ç‰¹ç‚¹ï¼š

- ä½¿ç”¨ Set Abstractionï¼ˆSAï¼‰å±‚ è¿›è¡Œå¤šå°ºåº¦ç‰¹å¾æå–å’Œä¸‹é‡‡æ ·ï¼›

- ä½¿ç”¨ Feature Propagationï¼ˆFPï¼‰å±‚ è¿›è¡Œç‰¹å¾æ’å€¼å’Œä¸Šé‡‡æ ·ï¼›

- æœ€åé€šè¿‡ä¸¤ä¸ªå·ç§¯å±‚è¾“å‡ºæ¯ä¸ªç‚¹çš„åˆ†ç±»ç»“æœï¼›

- è¾“å‡ºä¸º [B, N, num_classes]ï¼Œå³æ¯ä¸ªç‚¹éƒ½æœ‰ä¸€ä¸ªç±»åˆ«é¢„æµ‹ã€‚

```python
class get_model(nn.Module):
    def __init__(self, num_classes):
        """
        åˆå§‹åŒ– PointNet++ åˆ†å‰²ç½‘ç»œ

        å‚æ•°ï¼š
            num_classes: åˆ†ç±»ç±»åˆ«æ•°
        """
        super(get_model, self).__init__()

        # Set Abstraction å±‚ï¼ˆç¼–ç å™¨éƒ¨åˆ†ï¼‰
        # æ¯å±‚é€æ­¥ä¸‹é‡‡æ ·ï¼Œå¹¶æå–æ›´é«˜çº§åˆ«çš„å±€éƒ¨ç‰¹å¾
        self.sa1 = PointNetSetAbstraction(npoint=1024, radius=0.1, nsample=32, in_channel=9+3, mlp=[32, 32, 64], group_all=False)
        self.sa2 = PointNetSetAbstraction(npoint=256, radius=0.2, nsample=32, in_channel=64+3, mlp=[64, 64, 128], group_all=False)
        self.sa3 = PointNetSetAbstraction(npoint=64, radius=0.4, nsample=32, in_channel=128+3, mlp=[128, 128, 256], group_all=False)
        self.sa4 = PointNetSetAbstraction(npoint=16, radius=0.8, nsample=32, in_channel=256+3, mlp=[256, 256, 512], group_all=False)

        # Feature Propagation å±‚ï¼ˆè§£ç å™¨éƒ¨åˆ†ï¼‰
        # ä»ç¨€ç–ç‚¹æ¢å¤åˆ°åŸå§‹ç‚¹å¯†åº¦ï¼Œé€å±‚èåˆä¸Šä¸‹æ–‡ä¿¡æ¯
        self.fp4 = PointNetFeaturePropagation(in_channel=768, mlp=[256, 256])
        self.fp3 = PointNetFeaturePropagation(in_channel=384, mlp=[256, 256])
        self.fp2 = PointNetFeaturePropagation(in_channel=320, mlp=[256, 128])
        self.fp1 = PointNetFeaturePropagation(in_channel=128, mlp=[128, 128, 128])

        # æœ€ç»ˆåˆ†ç±»å¤´
        self.conv1 = nn.Conv1d(128, 128, 1)
        self.bn1 = nn.BatchNorm1d(128)
        self.drop1 = nn.Dropout(0.5)
        self.conv2 = nn.Conv1d(128, num_classes, 1)

    def forward(self, xyz):
        """
        å‰å‘ä¼ æ’­å‡½æ•°

        è¾“å…¥ï¼š
            xyz: ç‚¹äº‘æ•°æ®ï¼Œå½¢çŠ¶ [B, C, N]

        è¿”å›ï¼š
            x: æ¯ä¸ªç‚¹çš„åˆ†ç±»ç»“æœï¼Œå½¢çŠ¶ [B, N, num_classes]
            l4_points: æœ€åä¸€å±‚æŠ½è±¡ç‰¹å¾ï¼Œç”¨äºå…¶ä»–ä»»åŠ¡
        """
        # l0 è¡¨ç¤ºæœ€åŸå§‹çš„ç‚¹äº‘
        l0_points = xyz
        l0_xyz = xyz[:, :3, :]  # åªå– xyz åæ ‡ï¼Œä¸å¸¦æ³•å‘é‡æˆ–å…¶ä»–å±æ€§

        # ç¼–ç å™¨ï¼šå±‚å±‚ä¸‹é‡‡æ ·å¹¶æå–ç‰¹å¾
        l1_xyz, l1_points = self.sa1(l0_xyz, l0_points)  # 1024 points
        l2_xyz, l2_points = self.sa2(l1_xyz, l1_points)  # 256 points
        l3_xyz, l3_points = self.sa3(l2_xyz, l2_points)  # 64 points
        l4_xyz, l4_points = self.sa4(l3_xyz, l3_points)  # 16 points

        # è§£ç å™¨ï¼šå±‚å±‚æ’å€¼å¹¶èåˆç‰¹å¾
        l3_points = self.fp4(l3_xyz, l4_xyz, l3_points, l4_points)  # 64 â†’ 64
        l2_points = self.fp3(l2_xyz, l3_xyz, l2_points, l3_points)  # 256 â†’ 256
        l1_points = self.fp2(l1_xyz, l2_xyz, l1_points, l2_points)  # 1024 â†’ 1024
        l0_points = self.fp1(l0_xyz, l1_xyz, None, l1_points)       # 4096 â†’ 4096

        # MLP å¤´éƒ¨å¤„ç†ï¼šè¿›ä¸€æ­¥å¢å¼ºç‰¹å¾
        x = self.drop1(F.relu(self.bn1(self.conv1(l0_points)), inplace=True))  # [B, 128, N]
        x = self.conv2(x)  # [B, num_classes, N]

        # Softmax åˆ†ç±»
        x = F.log_softmax(x, dim=1)  # [B, num_classes, N]

        # è°ƒæ•´ç»´åº¦ï¼Œè¿”å› [B, N, num_classes]
        x = x.permute(0, 2, 1)

        return x, l4_points  # è¿”å›æ¯ä¸ªç‚¹çš„åˆ†ç±»ç»“æœå’ŒæŠ½è±¡ç‰¹å¾
```    
