---
title: ğŸš€ ä»é›¶æ„å»ºæ·±åº¦å­¦ä¹ æ¡†æ¶ï¼ˆä¸€ï¼‰ï¼šè®¡ç®—å›¾ä¸è‡ªåŠ¨å¾®åˆ†çš„èµ·ç‚¹
icon: file
category:
  - å¼€æºé¡¹ç›®
  - TinyPytorch
tag:
  - å¼€æºé¡¹ç›®
  - TinyPytorch
  - å·²å‘å¸ƒ
footer: æŠ€æœ¯å…±å»ºï¼ŒçŸ¥è¯†å…±äº«
date: 2025-06-29
order: 1
author:
  - BinaryOracle
---

`1.TinyPytorch ç¬¬ä¸€é˜¶æ®µ: è‡ªåŠ¨å¾®åˆ†`
 
<!-- more -->

## å¼•è¨€ï¼šæ­å¼€æ·±åº¦å­¦ä¹ æ¡†æ¶çš„ç¥ç§˜é¢çº±

æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­è•´è—ç€æƒŠäººçš„æŠ€æœ¯å’Œæœ‰è¶£çš„æœºåˆ¶ï¼Œè€Œæœ¬ç³»åˆ—æ—¨åœ¨æ­å¼€è¿™äº›æŠ€æœ¯å’Œæœºåˆ¶çš„ç¥ç§˜é¢çº±ï¼Œå¸®åŠ©è¯»è€…æ­£ç¡®ç†è§£æŠ€æœ¯ï¼Œä½“ä¼šå®ƒä»¬çš„æœ‰è¶£ä¹‹å¤„ã€‚ä¸ºæ­¤ï¼Œæœ¬ç³»åˆ—å°†å¸¦é¢†è¯»è€…ä»é›¶å¼€å§‹åˆ›å»ºä¸€ä¸ªæ·±åº¦å­¦ä¹ æ¡†æ¶â€”â€”TinyPytorchã€‚TinyPytorchå°½é‡ç”¨æœ€å°‘çš„ä»£ç å®ç°äº†ç°ä»£æ·±åº¦å­¦ä¹ æ¡†æ¶çš„åŠŸèƒ½ã€‚ç¬¬ä¸€é˜¶æ®µå…±åŒ…å«10ä¸ªæ­¥éª¤ï¼Œè®©æˆ‘ä»¬é€æ­¥æ„å»ºèµ·TinyPytorchçš„åŸºç¡€åŠŸèƒ½ã€‚

## æ­¥éª¤1ï¼šä½œä¸º"ç®±å­"çš„å˜é‡

### å˜é‡çš„åŸºæœ¬æ¦‚å¿µ
å˜é‡æ˜¯TinyPytorchæœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œå¯å°†å…¶æ¯”ä½œå­˜æ”¾æ•°æ®çš„"ç®±å­"ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œå˜é‡çš„ä½œç”¨æ˜¯å­˜å‚¨æ•°æ®ï¼Œè€ŒTinyPytorchçš„å˜é‡å®ç°ä¸º`Variable`ç±»ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯ä¿å­˜å’Œç®¡ç†æ•°æ®ã€‚

### ä»£ç å®ç°
```python
class Variable:
    def __init__(self, data):
        self.data = data
```

### ä½¿ç”¨ç¤ºä¾‹

```python
import numpy as np

data = np.array(1.0)
x = Variable(data)
print(x.data)  # è¾“å‡º 1.0

x.data = np.array(2.0)
print(x.data)  # è¾“å‡º: 2.0
```

### å…³é”®è¦ç‚¹

- `Variable`ç±»å°è£…äº†NumPyçš„å¤šç»´æ•°ç»„ï¼ˆndarrayï¼‰

- æ•°æ®å­˜å‚¨åœ¨`data`å±æ€§ä¸­

- æ”¯æŒæ•°æ®çš„ä¿®æ”¹å’Œè¯»å–

## æ­¥éª¤2ï¼šåˆ›å»ºå˜é‡çš„å‡½æ•°

### å‡½æ•°ä¸è®¡ç®—å›¾

å‡½æ•°å®šä¹‰äº†å˜é‡ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œé€šè¿‡è®¡ç®—å›¾å¯ä»¥ç›´è§‚åœ°è¡¨ç¤ºå˜é‡ä¸å‡½æ•°çš„å…³ç³»ã€‚è®¡ç®—å›¾ç”¨åœ†æ¡†è¡¨ç¤ºå˜é‡ï¼Œç”¨æ–¹æ¡†è¡¨ç¤ºå‡½æ•°ï¼ŒèŠ‚ç‚¹å’Œç®­å¤´å±•ç¤ºè®¡ç®—æµç¨‹ã€‚

![](1/1.png)

### å‡½æ•°ç±»çš„è®¾è®¡

è®¾è®¡`Function`ç±»ä½œä¸ºåŸºç±»ï¼Œå…·ä½“å‡½æ•°ç»§æ‰¿è¯¥ç±»å¹¶å®ç°`forward`æ–¹æ³•ã€‚`__call__`æ–¹æ³•å¤„ç†è¾“å…¥è¾“å‡ºçš„å˜é‡å°è£…ã€‚

### ä»£ç å®ç°
```python
class Function:
    def __call__(self, input):
        x = input.data
        y = self.forward(x)
        output = Variable(y)
        return output
    
    def forward(self, x):
        raise NotImplementedError()

class Square(Function):
    def forward(self, x):
        return x ** 2
```

### è¾…åŠ©å‡½æ•°

ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå°†å‡½æ•°ç±»å°è£…ä¸ºPythonå‡½æ•°ï¼š

```python
def square(x):
    return Square()(x)
```

## æ­¥éª¤3ï¼šå‡½æ•°çš„è¿ç»­è°ƒç”¨

### å¤åˆå‡½æ•°çš„è®¡ç®—

å¤šä¸ªå‡½æ•°å¯ä»¥è¿ç»­è°ƒç”¨ï¼Œå½¢æˆå¤åˆå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œè®¡ç®—$y=(e^{x^2})^2$ï¼Œå¯ä»¥é€šè¿‡è¿ç»­ä½¿ç”¨å¹³æ–¹å‡½æ•°å’ŒæŒ‡æ•°å‡½æ•°å®ç°ã€‚

### ä»£ç ç¤ºä¾‹

```python
class Exp(Function):
    def forward(self, x):
        return np.exp(x)

def exp(x):
    return Exp()(x)

A = Square()
B = Exp()
C = Square()
x = Variable(np.array(0.5))
a = A(x)
b = B(a)
y = C(b)
print(y.data)  # è¾“å‡º: 1.648721270700128
```

### è®¡ç®—å›¾çš„æ„ä¹‰

å¤åˆå‡½æ•°çš„è®¡ç®—å›¾å±•ç¤ºäº†å‡½æ•°çš„ç»„åˆè¿‡ç¨‹ï¼Œè€Œåå‘ä¼ æ’­ç®—æ³•å¯ä»¥é«˜æ•ˆåœ°æ±‚å‡ºæ¯ä¸ªå˜é‡çš„å¯¼æ•°ï¼Œè¿™ä¸ºè‡ªåŠ¨å¾®åˆ†å¥ å®šäº†åŸºç¡€ã€‚

![](1/2.png)

## æ­¥éª¤4ï¼šæ•°å€¼å¾®åˆ†

### å¯¼æ•°çš„å®šä¹‰

å¯¼æ•°æ˜¯å˜åŒ–ç‡çš„è¡¨ç¤ºï¼Œå‡½æ•°$f(x)$åœ¨$x$å¤„çš„å¯¼æ•°å®šä¹‰ä¸ºï¼š

$$f'(x)=\lim_{h \to 0} \frac{f(x+h)-f(x)}{h}$$


### æ•°å€¼å¾®åˆ†çš„å®ç°

ä½¿ç”¨ä¸­å¿ƒå·®åˆ†è¿‘ä¼¼è®¡ç®—æ•°å€¼å¾®åˆ†ï¼Œå…¬å¼ä¸ºï¼š

$$\frac{f(x+h)-f(x-h)}{2h}$$

### ä»£ç å®ç°

```python
def numerical_diff(f, x, eps=1e-4):
    x0 = Variable(x.data - eps)
    x1 = Variable(x.data + eps)
    y0 = f(x0)
    y1 = f(x1)
    return (y1.data - y0.data) / (2 * eps)
```

### æ•°å€¼å¾®åˆ†çš„é—®é¢˜

- ç»“æœåŒ…å«è¯¯å·®ï¼ˆç²¾åº¦ä¸¢å¤±ï¼‰

- è®¡ç®—æˆæœ¬é«˜ï¼ˆå°¤å…¶å¯¹äºå¤šå˜é‡å‡½æ•°ï¼‰

- å¯ç”¨äºæ¢¯åº¦æ£€éªŒï¼ŒéªŒè¯åå‘ä¼ æ’­çš„æ­£ç¡®æ€§

## æ­¥éª¤5ï¼šåå‘ä¼ æ’­çš„ç†è®ºçŸ¥è¯†

### é“¾å¼æ³•åˆ™

åå‘ä¼ æ’­çš„ç†è®ºåŸºç¡€æ˜¯é“¾å¼æ³•åˆ™ï¼Œå¯¹äºå¤åˆå‡½æ•°$y=F(x)$ï¼Œè‹¥$F$ç”±$a=A(x)$ã€$b=B(a)$ã€$y=C(b)$ç»„æˆï¼Œåˆ™ï¼š

$$\frac{dy}{dx}=\frac{dy}{db}\frac{db}{da}\frac{da}{dx}$$

### åå‘ä¼ æ’­çš„æ–¹å‘

åå‘ä¼ æ’­æŒ‰ä»è¾“å‡ºåˆ°è¾“å…¥çš„é¡ºåºè®¡ç®—å¯¼æ•°ï¼Œä¸æ­£å‘ä¼ æ’­æ–¹å‘ç›¸åã€‚è¿™ç§æ–¹å¼åœ¨è¾“å‡ºä¸ºæ ‡é‡çš„æƒ…å†µä¸‹è®¡ç®—æ•ˆç‡æ›´é«˜ï¼Œé€‚åˆæœºå™¨å­¦ä¹ ä¸­æŸå¤±å‡½æ•°çš„ä¼˜åŒ–ã€‚

### è®¡ç®—å›¾çš„åå‘ä¼ æ’­

åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œå¯¼æ•°ä»è¾“å‡ºç«¯å‘è¾“å…¥ç«¯ä¼ æ’­ï¼Œæ¯ä¸ªå‡½æ•°èŠ‚ç‚¹éœ€è¦è®¡ç®—å…¶å¯¼æ•°ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™å‰ä¸€å±‚å˜é‡ã€‚

## æ­¥éª¤6ï¼šæ‰‹åŠ¨è¿›è¡Œåå‘ä¼ æ’­

### æ‰©å±•Variableç±»

ä¸º`Variable`ç±»æ·»åŠ `grad`å±æ€§ï¼Œç”¨äºå­˜å‚¨å¯¼æ•°ï¼š

```python
class Variable:
    def __init__(self, data):
        self.data = data
        self.grad = None
```

### æ‰©å±•Functionç±»

ä¸º`Function`ç±»æ·»åŠ åå‘ä¼ æ’­æ–¹æ³•`backward`ï¼Œå¹¶åœ¨`__call__`æ–¹æ³•ä¸­ä¿å­˜è¾“å…¥è¾“å‡ºå˜é‡ï¼š

```python
class Function:
    def __call__(self, input):
        x = input.data
        y = self.forward(x)
        output = Variable(y)
        self.input = input
        self.output = output
        return output
    
    def backward(self, gy):
        raise NotImplementedError()
```

### å…·ä½“å‡½æ•°çš„åå‘ä¼ æ’­

ä»¥å¹³æ–¹å‡½æ•°ä¸ºä¾‹ï¼š

```python
class Square(Function):
    def backward(self, gy):
        x = self.input.data
        gx = 2 * x * gy
        return gx
```

### åå‘ä¼ æ’­çš„æ‰§è¡Œ

æŒ‰åå‘é¡ºåºè°ƒç”¨å„å‡½æ•°çš„`backward`æ–¹æ³•ï¼Œæ‰‹åŠ¨ä¼ é€’å¯¼æ•°ï¼š

```python
y.grad = np.array(1.0)
b.grad = C.backward(y.grad)
a.grad = B.backward(b.grad)
x.grad = A.backward(a.grad)
```

## æ­¥éª¤7ï¼šåå‘ä¼ æ’­çš„è‡ªåŠ¨åŒ–

### å»ºç«‹å˜é‡ä¸å‡½æ•°çš„è¿æ¥

åœ¨`Variable`ç±»ä¸­æ·»åŠ `creator`å±æ€§ï¼Œè®°å½•åˆ›å»ºè¯¥å˜é‡çš„å‡½æ•°ï¼›åœ¨`Function`ç±»çš„`__call__`æ–¹æ³•ä¸­ï¼Œè®¾ç½®å˜é‡çš„`creator`ï¼š

```python
class Variable:
    def set_creator(self, func):
        self.creator = func

class Function:
    def __call__(self, input):
        # å…¶ä»–ä»£ç ...
        output.set_creator(self)
```

### è‡ªåŠ¨åå‘ä¼ æ’­çš„å®ç°


åœ¨`Variable`ç±»ä¸­æ·»åŠ `backward`æ–¹æ³•ï¼Œé€šè¿‡é€’å½’æˆ–å¾ªç¯éå†è®¡ç®—å›¾ï¼Œè‡ªåŠ¨æ‰§è¡Œåå‘ä¼ æ’­ï¼š

```python
class Variable:
    def backward(self):
        f = self.creator
        if f is not None:
            x = f.input
            x.grad = f.backward(self.grad)
            x.backward()
```

## æ­¥éª¤8ï¼šä»é€’å½’åˆ°å¾ªç¯

### é€’å½’å®ç°çš„é—®é¢˜

é€’å½’å®ç°çš„åå‘ä¼ æ’­åœ¨è®¡ç®—å›¾è¾ƒæ·±æ—¶å¯èƒ½å¯¼è‡´æ ˆæº¢å‡ºï¼Œä¸”æ•ˆç‡è¾ƒä½ã€‚

### å¾ªç¯å®ç°åå‘ä¼ æ’­

ä½¿ç”¨åˆ—è¡¨ä¿å­˜å¾…å¤„ç†çš„å‡½æ•°ï¼Œé€šè¿‡å¾ªç¯æ›¿ä»£é€’å½’ï¼š

```python
class Variable:
    def backward(self):
        funcs = [self.creator]
        while funcs:
            f = funcs.pop()
            x, y = f.input, f.output
            x.grad = f.backward(y.grad)
            if x.creator is not None:
                funcs.append(x.creator)
```

### å¾ªç¯å®ç°çš„ä¼˜åŠ¿

- é¿å…æ ˆæº¢å‡º

- æé«˜æ‰§è¡Œæ•ˆç‡

- æ›´å®¹æ˜“å¤„ç†å¤æ‚è®¡ç®—å›¾

## æ­¥éª¤9ï¼šè®©å‡½æ•°æ›´æ˜“ç”¨

### å‡½æ•°çš„PythonåŒ–

å°†å‡½æ•°ç±»å°è£…ä¸ºPythonå‡½æ•°ï¼Œä¾¿äºç›´æ¥è°ƒç”¨ï¼š

```python
def square(x):
    return Square()(x)

def exp(x):
    return Exp()(x)
```

### è‡ªåŠ¨è®¾ç½®æ¢¯åº¦

åœ¨`Variable`çš„`backward`æ–¹æ³•ä¸­è‡ªåŠ¨åˆå§‹åŒ–æ¢¯åº¦ï¼š

```python
class Variable:
    def backward(self):
        if self.grad is None:
            self.grad = np.ones_like(self.data)
        # å…¶ä»–ä»£ç ...
```

### æ•°æ®ç±»å‹æ£€æŸ¥

ç¡®ä¿`Variable`åªæ¥å—ndarrayå®ä¾‹ï¼Œæé«˜ä»£ç å¥å£®æ€§ï¼š

```python
class Variable:
    def __init__(self, data):
        if data is not None:
            if not isinstance(data, np.ndarray):
                raise TypeError(f'{type(data)} is not supported')
        self.data = data
        # å…¶ä»–ä»£ç ...
```

## æ­¥éª¤10ï¼šæµ‹è¯•

### å•å…ƒæµ‹è¯•

ä½¿ç”¨Pythonçš„`unittest`æ¨¡å—ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯å‡½æ•°çš„æ­£å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ï¼š

```python
import unittest

class SquareTest(unittest.TestCase):
    def test_forward(self):
        x = Variable(np.array(2.0))
        y = square(x)
        self.assertEqual(y.data, np.array(4.0))
    
    def test_backward(self):
        x = Variable(np.array(3.0))
        y = square(x)
        y.backward()
        self.assertEqual(x.grad, np.array(6.0))
```

### æ¢¯åº¦æ£€éªŒ

å°†æ•°å€¼å¾®åˆ†çš„ç»“æœä¸åå‘ä¼ æ’­çš„ç»“æœè¿›è¡Œæ¯”è¾ƒï¼ŒéªŒè¯åå‘ä¼ æ’­çš„æ­£ç¡®æ€§ï¼š

```python
def numerical_diff(f, x, eps=1e-4):
    # å®ç°å¦‚å‰æ‰€è¿°

class SquareTest(unittest.TestCase):
    def test_gradient_check(self):
        x = Variable(np.random.rand(1))
        y = square(x)
        y.backward()
        num_grad = numerical_diff(square, x)
        self.assertTrue(np.allclose(x.grad, num_grad))
```

### æµ‹è¯•çš„é‡è¦æ€§

- ç¡®ä¿ä»£ç åŠŸèƒ½æ­£ç¡®æ€§

- å‘ç°æ½œåœ¨bug

- æ”¯æŒä»£ç é‡æ„å’Œæ‰©å±•

## ç¬¬ä¸€é˜¶æ®µæ€»ç»“

é€šè¿‡ç¬¬ä¸€é˜¶æ®µçš„10ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬ä»é›¶å¼€å§‹æ„å»ºäº†TinyPytorchæ¡†æ¶çš„åŸºç¡€åŠŸèƒ½ï¼š

1. å®ç°äº†å˜é‡å’Œå‡½æ•°çš„åŸºæœ¬ç»“æ„

2. å®Œæˆäº†è‡ªåŠ¨å¾®åˆ†çš„æ ¸å¿ƒç®—æ³•â€”â€”åå‘ä¼ æ’­

3. å®ç°äº†æ•°å€¼å¾®åˆ†ä½œä¸ºæ¢¯åº¦æ£€éªŒå·¥å…·

4. ä¼˜åŒ–äº†åå‘ä¼ æ’­çš„å®ç°ï¼Œä»é€’å½’æ”¹ä¸ºå¾ªç¯

5. æé«˜äº†æ¡†æ¶çš„æ˜“ç”¨æ€§å’Œå¥å£®æ€§

6. å»ºç«‹äº†æµ‹è¯•æœºåˆ¶ï¼Œç¡®ä¿ä»£ç è´¨é‡

æ­¤æ—¶çš„TinyPytorchå·²ç»å…·å¤‡äº†è‡ªåŠ¨å¾®åˆ†çš„èƒ½åŠ›ï¼Œå¯ä»¥å¤„ç†ç®€å•çš„è®¡ç®—å›¾ï¼Œå¹¶ä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚æ¥ä¸‹æ¥çš„é˜¶æ®µå°†è¿›ä¸€æ­¥æ‰©å±•TinyPytorchï¼Œä½¿å…¶æ”¯æŒæ›´å¤æ‚çš„è®¡ç®—å’Œç¥ç»ç½‘ç»œçš„æ„å»ºã€‚

