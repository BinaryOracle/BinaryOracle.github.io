---
title: ğŸ§® ä»é›¶æ„å»ºæ·±åº¦å­¦ä¹ æ¡†æ¶ï¼ˆäºŒï¼‰ï¼šè‡ªåŠ¨åå‘ä¼ æ’­ä¸è®¡ç®—å›¾è¿›é˜¶
icon: file
category:
  - å¼€æºé¡¹ç›®
  - TinyPytorch
tag:
  - å¼€æºé¡¹ç›®
  - TinyPytorch
  - å·²å‘å¸ƒ
footer: æŠ€æœ¯å…±å»ºï¼ŒçŸ¥è¯†å…±äº«
date: 2025-06-29
order: 1
author:
  - BinaryOracle
---

`1.TinyPytorch ç¬¬äºŒé˜¶æ®µ: è‡ªåŠ¨åå‘ä¼ æ’­ä¸æ¡†æ¶åŸºç¡€èƒ½åŠ›æå‡`
 
<!-- more -->

> ä»“åº“é“¾æ¥: [https://github.com/BinaryOracle/TinyPytorch](https://github.com/BinaryOracle/TinyPytorch)
> æœ¬èŠ‚ä»£ç : 

## å¼•è¨€ï¼šä»è‡ªåŠ¨å¾®åˆ†è¿ˆå‘é€šç”¨æ¡†æ¶

æ·±åº¦å­¦ä¹ æ¡†æ¶ä¹‹æ‰€ä»¥å¼ºå¤§ï¼Œä¸ä»…å› ä¸ºå…¶å‰å‘è®¡ç®—åŠŸèƒ½ï¼Œæ›´å› ä¸ºå…¶èƒŒåå¤æ‚è€Œç²¾å¦™çš„è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿã€‚æœ¬ç³»åˆ—æ–‡ç« è¯•å›¾æ­å¼€è¿™äº›æœºåˆ¶èƒŒåçš„æœ¬è´¨ï¼Œå¸®åŠ©è¯»è€…ä»é›¶æ­å»ºå±äºè‡ªå·±çš„æ·±åº¦å­¦ä¹ å¼•æ“ã€‚

ç¬¬ä¸€é˜¶æ®µä¸­ï¼Œæˆ‘ä»¬æ„å»ºäº†å˜é‡ï¼ˆVariableï¼‰ä¸å‡½æ•°ï¼ˆFunctionï¼‰ç±»ï¼Œå®ç°äº†åŸºç¡€çš„è®¡ç®—å›¾ç»“æ„ä¸åå‘ä¼ æ’­æµç¨‹ï¼Œå¹¶é€šè¿‡é“¾å¼æ³•åˆ™è‡ªåŠ¨æ¨å¯¼äº†å¯¼æ•°ã€‚

ç¬¬äºŒé˜¶æ®µå°†ä»ç¬¬11æ­¥å»¶ç»­ï¼Œå…¨é¢æ‰©å±• TinyPytorch çš„æ ¸å¿ƒèƒ½åŠ›ã€‚åœ¨ç¬¬ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬å®Œæˆäº†è®¡ç®—å›¾ä¸æ‰‹åŠ¨åå‘ä¼ æ’­çš„é›å½¢ã€‚è€Œåœ¨æœ¬é˜¶æ®µï¼Œæˆ‘ä»¬å°†ç»§ç»­æ­å¼€æ·±åº¦å­¦ä¹ æ¡†æ¶çš„æ ¸å¿ƒæœºåˆ¶ï¼šå®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„è‡ªåŠ¨åå‘ä¼ æ’­ã€å¤šè¾“å…¥/è¾“å‡ºå¤„ç†ã€è®¡ç®—å›¾éå†ä¼˜åŒ–ã€æ¢¯åº¦ç´¯åŠ ã€é…ç½®æ§åˆ¶ä¸è®¡ç®—å›¾å¯è§†åŒ–ç­‰ã€‚é€šè¿‡è¿™ 14 ä¸ªæ­¥éª¤ï¼ŒTinyPytorch å°†èœ•å˜ä¸ºä¸€ä¸ªæ›´é€šç”¨ã€æ›´é«˜æ•ˆã€æ›´æ¥è¿‘çœŸå®æ¡†æ¶çš„è‡ªåŠ¨å¾®åˆ†ç³»ç»Ÿã€‚

## æ­¥éª¤11: å¤šè¾“å…¥ä¸å¤šè¾“å‡º

ç°å®ä¸­çš„ç¥ç»ç½‘ç»œæ“ä½œå¾€å¾€ä¸ä»…ä»…æ¥å—ä¸€ä¸ªè¾“å…¥ï¼Œä¹Ÿå¯èƒ½äº§ç”Ÿå¤šä¸ªè¾“å‡ºï¼Œä¾‹å¦‚åŠ æ³•ã€ä¹˜æ³•ã€åˆ‡ç‰‡ã€æ‹¼æ¥ç­‰æ“ä½œã€‚å› æ­¤æˆ‘ä»¬æ‰©å±• `Function` ç±»ä»¥æ”¯æŒ **å¯å˜å‚æ•°è¾“å…¥ä¸è¾“å‡ºåˆ—è¡¨**ã€‚

```python
class Function:
    def __call__(self, *inputs):
        xs = [x.data for x in inputs]
        ys = self.forward(*xs)
        if not isinstance(ys, tuple):
            ys = (ys,)
        outputs = [Variable(as_array(y)) for y in ys]

        for output in outputs:
            output.set_creator(self)
        self.inputs = inputs
        self.outputs = outputs
        return outputs if len(outputs) > 1 else outputs[0]
    
    def forward(self, xs):
        raise NotImplementedError()

    def backward(self, gys):
        raise NotImplementedError()
```

è¿™ä¸€æ‰©å±•ä½¿æˆ‘ä»¬çš„å‡½æ•°å®šä¹‰æ›´æ¥è¿‘ NumPy é£æ ¼ï¼Œæ”¯æŒå¤šä¸ªè¾“å…¥ä¸è¾“å‡ºï¼Œæé«˜äº†çµæ´»æ€§ã€‚

![](2/1.png)


> ä¸ºäº†æ›´å¥½åœ°æ”¯æŒå¤šè¾“å…¥å‡½æ•°ï¼Œæˆ‘ä»¬å­¦ä¹ å’Œåˆ©ç”¨äº† Python ä¸­çš„å‡ ä¸ªè¯­æ³•æŠ€å·§ï¼š
> 
> * `*args`ï¼šæ¥æ”¶ä»»æ„ä¸ªæ•°çš„ä½ç½®å‚æ•°ï¼Œç”¨äºå‡½æ•°çš„è¾“å…¥æ¥å£ï¼›
>
> * `*xs` è§£åŒ…è¯­æ³•ï¼šåœ¨è°ƒç”¨å¦‚ `forward(*xs)` æ—¶å±•å¼€å˜é‡åˆ—è¡¨ï¼›
>
> * `tuple` åˆ¤æ–­ï¼šè®©è¿”å›å€¼å§‹ç»ˆå°è£…ä¸ºå…ƒç»„ï¼Œç»Ÿä¸€å¤„ç†é€»è¾‘ã€‚

## æ­¥éª¤12: backward çš„å¤šè¾“å…¥å®ç°

åœ¨ `Variable.backward()` ä¸­æ”¯æŒå¤šè¾“å‡ºèŠ‚ç‚¹ï¼š

```python
    def backward(self):
        if self.grad is None:
            self.grad = np.ones_like(self.data)

        funcs = [self.creator]
        while funcs:
            f = funcs.pop()
            gys = [output.grad for output in f.outputs]
            gxs = f.backward(*gys)

            if not isinstance(gxs,tuple):
                gxs = (gxs,)

            for x, gx in zip(f.inputs, gxs):
                x.grad = gx

                if x.creator is not None:
                    funcs.append(x.creator)
```

è¿™é‡Œ gxs å’Œ f.inputs çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚å‡†ç¡®æ¥è¯´, å¦‚æœæœ‰ç¬¬iä¸ªå…ƒç´ , é‚£ä¹ˆf.input[i]çš„å¯¼æ•°å€¼å¯¹åº”äºgxs[i]ã€‚äºæ˜¯ä»£ç ä¸­ä½¿ç”¨zip å‡½æ•°å’Œ for å¾ªç¯æ¥è®¾ç½®æ¯ä¸€å¯¹çš„å¯¼æ•°ã€‚ä»¥ä¸Šå°±æ˜¯Variableç±»çš„æ–° backward æ–¹æ³•ã€‚

![](2/2.png)

## æ­¥éª¤13: é‡ç½®å¯¼æ•°

å½“æˆ‘ä»¬ä½¿ç”¨åŒä¸€ä¸ªå˜é‡åˆ†åˆ«è¿›è¡Œå¤šæ¬¡è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æ¯æ¬¡è®¡ç®—éƒ½èƒ½å¾—åˆ°æ­£ç¡®çš„å¯¼æ•°ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡è®¡ç®—ä¹‹å‰å°†å¯¼æ•°é‡ç½®ä¸º0ã€‚

ä¸‹é¢ä¸º `Variable` ç±»æä¾›ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œå®ç°å˜é‡å¯¼æ•°çš„é‡ç½®ã€‚

```python
class Variable:
    ...
    def cleargrad(self):
        self.grad = None
```

## æ­¥éª¤14: å…±äº«å˜é‡ä¸æ¢¯åº¦ç´¯åŠ 

å½“æŸä¸ªå˜é‡è¢«å¤šæ¬¡ç”¨ä½œè¾“å…¥æ—¶ï¼ˆä¾‹å¦‚ `z = x + x`ï¼‰ï¼Œåå‘ä¼ æ’­è¿‡ç¨‹ä¸­å®ƒçš„æ¢¯åº¦åº”**ç´¯åŠ **ã€‚

è¿™æ˜¯å› ä¸ºåŒä¸€ä¸ªå˜é‡å¯¹è¾“å‡ºçš„å½±å“è·¯å¾„æœ‰å¤šæ¡ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿›è¡Œç´¯åŠ ï¼Œè€Œæ˜¯ç›´æ¥è¦†ç›–æ¢¯åº¦å€¼ï¼Œå°±ä¼šå¯¼è‡´åªæœ‰æœ€åä¸€æ¡è·¯å¾„ä¸Šçš„æ¢¯åº¦è¢«ä¿ç•™ï¼Œå…¶ä»–è·¯å¾„ä¸Šçš„æ¢¯åº¦ä¿¡æ¯å°†ä¸¢å¤±ã€‚

ä¾‹å¦‚ï¼š

```python
x = Variable(np.array(3.0))
y = add(x, x)  # x è¢«ç”¨ä½œä¸¤æ¬¡è¾“å…¥
```

åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œ`x` çš„æ¢¯åº¦æ¥è‡ªä¸¤ä¸ªè·¯å¾„ï¼šä¸€æ¡æ˜¯ç¬¬ä¸€ä¸ª `x` åˆ° `y`ï¼Œå¦ä¸€æ¡æ˜¯ç¬¬äºŒä¸ª `x` åˆ° `y`ã€‚å¦‚æœæˆ‘ä»¬ä¸å¯¹è¿™ä¸¤ä¸ªæ¢¯åº¦æ±‚å’Œï¼Œåªä¿ç•™ä¸€ä¸ªï¼Œé‚£ä¹ˆ `x` çš„çœŸå®å¯¼æ•°å°±ä¼šè¢«ä½ä¼°ä¸€åŠï¼Œæœ€ç»ˆå½±å“è®­ç»ƒç»“æœã€‚

![](2/3.png)

å› æ­¤ï¼Œåœ¨å®ç°ä¸­åº”å½“å¦‚ä¸‹å¤„ç†ï¼š

```python
    def backward(self):
        if self.grad is None:
            self.grad = np.ones_like(self.data)

        funcs = [self.creator]
        while funcs:
            f = funcs.pop()
            gys = [output.grad for output in f.outputs]
            gxs = f.backward(*gys)

            if not isinstance(gxs,tuple):
                gxs = (gxs,)

            for x, gx in zip(f.inputs, gxs):
                if x.grad is None:
                    x.grad = gx
                else:
                    x.grad = x.grad + gx  # æ­£ç¡®çš„ç´¯åŠ æ–¹å¼

                if x.creator is not None:
                    funcs.append(x.creator)
```

è¿™æ ·æ‰èƒ½ç¡®ä¿æ‰€æœ‰è·¯å¾„çš„è´¡çŒ®éƒ½è¢«çº³å…¥æœ€ç»ˆçš„æ¢¯åº¦å€¼ã€‚

## æ­¥éª¤15: æ¢¯åº¦é‡å¤ç´¯åŠ çš„é—®é¢˜

åœ¨æ­¥éª¤14ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å˜é‡æ¢¯åº¦éç©ºåˆ™è¿›è¡Œç´¯åŠ çš„æ”¹åŠ¨ï¼Œè§£å†³äº†å…±äº«å˜é‡æ¢¯åº¦é‡ç½®çš„é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸€æ”¹åŠ¨ä¹Ÿå¼•å‘äº†å¦ä¸€ä¸ªé—®é¢˜ï¼š**æ¢¯åº¦é‡å¤ç´¯åŠ **ã€‚ è§‚å¯Ÿä¸‹å›¾ï¼Œç”±äºç›®å‰`Variable.backward()`çš„å®ç°é€»è¾‘æ€»æ˜¯å°†å‡½æ•°è¿½åŠ åˆ°å¾…å¤„ç†åˆ—è¡¨çš„æœ«å°¾ï¼ŒåŒæ—¶åˆä¼˜å…ˆå¤„ç†åˆ—è¡¨æœ«å°¾çš„å‡½æ•°ï¼Œä¸º"å…ˆè¿›å…ˆå‡º"çš„å®ç°é€»è¾‘ï¼Œå› æ­¤å¯¹äºå­˜åœ¨å¤šåˆ†æ”¯çš„å¤æ‚è®¡ç®—å›¾è€Œè¨€ï¼Œå®ƒä¹Ÿæ€»æ˜¯ä¼šæ²¿ç€æŸä¸ªåˆ†æ”¯è¿›è¡ŒDFSç›´åˆ°"å¶èŠ‚ç‚¹"ï¼Œè¿™ä¼šå¯¼è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å…±äº«å˜é‡açš„æ¢¯åº¦è¢«é‡å¤ç´¯åŠ ï¼Œå¯¼è‡´xå˜é‡æ¢¯åº¦è®¡ç®—é”™è¯¯ã€‚

ä¾‹å­å¦‚ä¸‹:

```python
x = Variable(np.array(2.0))
a = square(x)
b = square(a)
c = square(a)
y = add(b, c)
y.backward()
```

![](2/5.png)

ä¸Šé¢çš„é—®é¢˜æœ¬è´¨æ˜¯å› ä¸ºå‡½æ•°è°ƒç”¨é¡ºåºé”™è¯¯å¯¼è‡´çš„ï¼Œå¯¹äºå…±äº«å˜é‡ï¼Œæˆ‘ä»¬è¦å…ˆè®¡ç®—å‡ºå…¶æ¢¯åº¦åï¼Œæ‰èƒ½ç»§ç»­è®¡ç®—å…¶å‰å‘çš„æ¢¯åº¦ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æŒ‰ç…§æ‹“æ‰‘æ’åºçš„æ–¹å¼å»éå†è®¡ç®—å›¾ã€‚

![](2/4.png)

## æ­¥éª¤16: "è¾ˆåˆ†"æœºåˆ¶

ä¸ºäº†è§£å†³ä¸Šè¿°çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨æ‹“æ‰‘æ’åºï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬é‡‡ç”¨æ›´åŠ æš´åŠ›çš„â€œè¾ˆåˆ†æ’åºâ€æœºåˆ¶ç¡®ä¿å‡½æ•°è°ƒç”¨é¡ºåºçš„æ­£ç¡®æ‰§è¡Œã€‚

æˆ‘ä»¬å¯ä»¥è·å–åˆ°å“ªä¸ªå‡½æ•°ç”Ÿæˆäº†å“ªä¸ªå˜é‡ï¼Œè¿™å°±æ„æˆäº†å‡½æ•°ä¸å˜é‡çš„"è¾ˆåˆ†"å…³ç³»ï¼›æˆ‘ä»¬å¯ä»¥é€šè¿‡å˜é‡çš„è¾ˆåˆ†æ¥è®¾ç½®å…¶åˆ›å»ºè€…å‡½æ•°çš„è¾ˆåˆ†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

![](2/6.png)

æˆ‘ä»¬åœ¨Variableç±»å’ŒFunctionç±»ä¸­å¢åŠ å®ä¾‹å˜é‡generationï¼Œç”¨å…¶æ¥è¡¨ç¤ºå‡½æ•°(æˆ–å˜é‡)å±äºå“ªä¸€ä»£ã€‚

```python
class Variable: 
    def __init__ (self , data): 
        if data is not None: 
             if not isinstance(data , np.ndarray): 
                 raise TypeError( '{} is not supported' .format(type(data))) 
        self.data = data 
        self.grad = None 
        self.creator = None 
        self.generation = 0

    def set_creator(self, func): 
        self.creator = func 
        self.generation = func.generation + 1
    ...
```
Variable ç±»å°† generation åˆå§‹åŒ–ä¸º 0ã€‚ä¹‹å, å½“ set_creator æ–¹æ³•è¢«è°ƒç”¨æ—¶, å®ƒå°† generation çš„å€¼è®¾ç½®ä¸ºçˆ¶å‡½æ•°çš„ generation å€¼åŠ 1ã€‚

Function ç±»çš„ generation è¢«è®¾ç½®ä¸ºå¤šä¸ªè¾“å…¥å˜é‡ä¸­æœ€å¤§çš„generationçš„å€¼ã€‚

```python
class Function:
    def __call__(self, *inputs):
        xs = [x.data for x in inputs]
        ys = self.forward(*xs)
        if not isinstance(ys, tuple):
            ys = (ys,)
        outputs = [Variable(as_array(y)) for y in ys]

        self.generation = max([x.generation for x in inputs])

        for output in outputs:
            output.set_creator(self)
        self.inputs = inputs
        self.outputs = outputs
        return outputs if len(outputs) > 1 else outputs[0]
```
é€šè¿‡ä»¥ä¸Šä¿®æ”¹, åœ¨è¿›è¡Œæ™®é€šè®¡ç®—(å³æ­£å‘ä¼ æ’­)æ—¶, å˜é‡å’Œå‡½æ•°ä¸­ä¼šè®¾ç½®å¥½ generation çš„å€¼ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡"è¾ˆåˆ†"æŒ‰åºå–å‡ºå…ƒç´ ã€‚

![](2/7.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è¾ˆåˆ†æ¥ç¡®ä¿å‡½æ•°Bå’ŒCå…ˆäºå‡½æ•°Aå–å‡ºï¼›æˆ‘ä»¬åªéœ€è¦å¦‚ä¸‹ä¿®æ”¹`Variable`å˜é‡çš„`backward`æ–¹æ³•å³å¯å®ŒæˆæŒ‰ç…§è¾ˆåˆ†è·å–å‡½æ•°çš„é€»è¾‘:

```python
class Variable:
    ...
    def backward(self):
        if self.grad is None:
            self.grad = np.ones_like(self.data)
        
        funcs = []
        seen_set = set() # é˜²æ­¢åŒä¸€ä¸ªå‡½æ•°è¢«å¤šæ¬¡æ·»åŠ åˆ°funcåˆ—è¡¨ä¸­ï¼Œä»è€Œé¿å…ä¸€ä¸ªå‡½æ•°çš„backwardæ–¹æ³•è¢«é”™è¯¯åœ°å¤šæ¬¡è°ƒç”¨

        def add_func(f):
             if f not in seen_set:
                 funcs.append(f)
                 seen_set.add(f)
                 funcs.sort(key=lambda x : x.generation)

        add_func(self.creator)

        while funcs:
            f = funcs.pop() # æ¯æ¬¡å–å‡ºè¾ˆåˆ†æœ€å¤§çš„å‡½æ•°
            gys = [output.grad for output in f.outputs]
            gxs = f.backward(*gys)

            if not isinstance(gxs,tuple):
                gxs = (gxs,)

            for x, gx in zip(f.inputs, gxs):
                if x.grad is None:
                    x.grad = gx
                else:
                    x.grad = x.grad + gx  # æ­£ç¡®çš„ç´¯åŠ æ–¹å¼

                if x.creator is not None:
                    add_func(x.creator)
```

## æ­¥éª¤17: å¾ªç¯å¼•ç”¨ä¸å†…å­˜é‡Šæ”¾

Pythonçš„å†…å­˜ç®¡ç†ä¸»è¦ä¾é ä¸¤ç§æœºåˆ¶ï¼šå¼•ç”¨è®¡æ•°å’Œåˆ†ä»£åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ã€‚åœ¨æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­ï¼Œåˆç†çš„å†…å­˜ç®¡ç†è‡³å…³é‡è¦ï¼Œå°¤å…¶å½“å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶ï¼Œä¸å½“çš„å†…å­˜ç®¡ç†å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼æˆ–ç¨‹åºå´©æºƒã€‚

- **å¼•ç”¨è®¡æ•°**ï¼šPythoné€šè¿‡è·Ÿè¸ªå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°æ¥ç®¡ç†å†…å­˜ã€‚å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œä¼šè¢«ç«‹å³å›æ”¶ã€‚ä»¥ä¸‹æƒ…å†µä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼š
 
  - ä½¿ç”¨èµ‹å€¼è¿ç®—ç¬¦ï¼ˆå¦‚`a = obj()`ï¼‰
 
  - å‘å‡½æ•°ä¼ é€’å‚æ•°ï¼ˆå¦‚`f(a)`ï¼‰
 
  - å‘å®¹å™¨å¯¹è±¡ï¼ˆåˆ—è¡¨ã€å…ƒç»„ç­‰ï¼‰æ·»åŠ å…ƒç´ ã€‚

å¾ªç¯å¼•ç”¨æŒ‡å¯¹è±¡ä¹‹é—´ç›¸äº’å¼•ç”¨ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ— æ³•å½’é›¶ï¼Œä»è€Œæ— æ³•è¢«è‡ªåŠ¨å›æ”¶ã€‚ä¾‹å¦‚ï¼š

```python
a = Obj()
b = Obj()
c = Obj()

a.b = b
b.c = c
c.a = a

a = b = c = None  # æ­¤æ—¶aã€bã€cçš„å¼•ç”¨è®¡æ•°ä»ä¸º1ï¼Œæ— æ³•å›æ”¶
```

è¿™ç§æƒ…å†µä¸‹ï¼Œå°½ç®¡ç”¨æˆ·ä¸å†è®¿é—®è¿™äº›å¯¹è±¡ï¼Œä½†å› å¾ªç¯å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°æ— æ³•é™è‡³0ï¼Œéœ€ä¾èµ–åƒåœ¾å›æ”¶æœºåˆ¶å¤„ç†ã€‚

è™½ç„¶Pythonçš„åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœºåˆ¶å¯ä»¥å¤„ç†å¾ªç¯å¼•ç”¨å¯¹è±¡ï¼Œä½†åœ¨å¯¹å†…å­˜æ•æ„Ÿçš„åœºæ™¯ä¸‹ä¾ç„¶å­˜åœ¨é—®é¢˜ï¼Œä¸»è¦åŸå› å¦‚ä¸‹ï¼š

1. **å›æ”¶æ—¶æœºéå³æ—¶æ€§**: GCæ˜¯ä¸€ç§åå°æœºåˆ¶ï¼Œé€šå¸¸åœ¨å†…å­˜ä¸è¶³æˆ–æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶æ‰ä¼šè§¦å‘ï¼Œè€Œéå®æ—¶å›æ”¶å¾ªç¯å¼•ç”¨å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå½“TinyPytorchå¤„ç†å¤§é‡ç¥ç»ç½‘ç»œè®¡ç®—æ—¶ï¼Œè‹¥å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼ŒGCå¯èƒ½æ— æ³•åŠæ—¶é‡Šæ”¾å†…å­˜ï¼Œå¯¼è‡´å†…å­˜å ç”¨æŒç»­å‡é«˜ï¼Œç”šè‡³å¼•å‘å†…å­˜ä¸è¶³é”™è¯¯ã€‚

2. **æ€§èƒ½å¼€é”€è¾ƒé«˜**: GCéœ€è¦æ‰«ææ•´ä¸ªå¯¹è±¡å›¾æ¥æ£€æµ‹å¾ªç¯å¼•ç”¨ï¼Œè¿™ä¸€è¿‡ç¨‹å¯¹å¤§è§„æ¨¡è®¡ç®—æ¡†æ¶ï¼ˆå¦‚TinyPytorchï¼‰è€Œè¨€å¯èƒ½äº§ç”Ÿæ˜¾è‘—çš„æ€§èƒ½æŸè€—ã€‚å°¤å…¶åœ¨ç¥ç»ç½‘ç»œè®­ç»ƒä¸­ï¼Œé¢‘ç¹çš„GCæ“ä½œä¼šå½±å“è®¡ç®—æ•ˆç‡ï¼Œè€Œå¼±å¼•ç”¨å¯é€šè¿‡é¿å…å¾ªç¯å¼•ç”¨ç›´æ¥è§£å†³é—®é¢˜ï¼Œå‡å°‘GCè§¦å‘é¢‘ç‡ã€‚

---

**TinyPytorchä¸­çš„å¾ªç¯å¼•ç”¨:**

å½“å‰TinyPytorchæ¡†æ¶ä¸­ï¼Œ`Function`å’Œ`Variable`å®ä¾‹å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼š

- `Function`å®ä¾‹å¼•ç”¨è¾“å…¥å’Œè¾“å‡ºçš„`Variable`å®ä¾‹ï¼ˆ`self.inputs`å’Œ`self.outputs`ï¼‰ã€‚

- `Variable`å®ä¾‹é€šè¿‡`creator`å±æ€§å¼•ç”¨åˆ›å»ºå®ƒçš„`Function`å®ä¾‹ã€‚

![](2/8.png)

**è§£å†³æ–¹æ¡ˆï¼šå¼±å¼•ç”¨**

**å¼±å¼•ç”¨çš„ä¼˜åŠ¿:**

1. **é¿å…å¼ºå¼•ç”¨å¯¼è‡´çš„å†…å­˜æ»ç•™**: `Function`å’Œ`Variable`ä¹‹é—´åŸæœ¬å­˜åœ¨å¼ºå¼•ç”¨å¾ªç¯ï¼ˆ`Function`å¼•ç”¨`Variable`ï¼Œ`Variable`é€šè¿‡`creator`å¼•ç”¨`Function`ï¼‰ã€‚è‹¥ä½¿ç”¨å¼ºå¼•ç”¨ï¼Œå³ä½¿è®¡ç®—å›¾ä¸å†è¢«ç”¨æˆ·è®¿é—®ï¼Œå¾ªç¯å¼•ç”¨ä»ä¼šå¯¼è‡´å¯¹è±¡æ— æ³•é‡Šæ”¾ã€‚è€Œå¼±å¼•ç”¨ä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå½“ç”¨æˆ·ä¸å†å¼•ç”¨`Variable`æ—¶ï¼Œå¯¹è±¡å¯è¢«ç«‹å³å›æ”¶ï¼Œæ— éœ€ç­‰å¾…GCã€‚

2. **ç¬¦åˆæ¡†æ¶è®¾è®¡éœ€æ±‚**: DeZeroçš„è®¡ç®—å›¾éœ€è¦åŠ¨æ€æ„å»ºå’Œé”€æ¯ï¼Œå¼±å¼•ç”¨èƒ½ç¡®ä¿è®¡ç®—å›¾åœ¨ä½¿ç”¨å®Œæ¯•åè‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·æ‰§è¡Œå®Œä¸€æ¬¡å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­åï¼Œè®¡ç®—å›¾ä¸­çš„ä¸­é—´å˜é‡ï¼ˆå¦‚`Function`å’Œä¸´æ—¶`Variable`ï¼‰åº”è¢«åŠæ—¶å›æ”¶ï¼Œä»¥é‡Šæ”¾å†…å­˜ä¾›åç»­è®¡ç®—ä½¿ç”¨ã€‚

> GCä¸å¼±å¼•ç”¨çš„äº’è¡¥å…³ç³»
> - **GCä½œä¸ºå…œåº•æœºåˆ¶**ï¼šGCå¯å¤„ç†å¼€å‘è€…æœªæ˜¾å¼è§£å†³çš„å¾ªç¯å¼•ç”¨ï¼Œä½†æ— æ³•æ›¿ä»£å¼±å¼•ç”¨åœ¨æ¡†æ¶è®¾è®¡ä¸­çš„é’ˆå¯¹æ€§ä¼˜åŒ–ã€‚  
> 
> - **å¼±å¼•ç”¨ä½œä¸ºä¸»åŠ¨ä¼˜åŒ–**ï¼šåœ¨TinyPytorchä¸­ï¼Œé€šè¿‡å¼±å¼•ç”¨ä¸»åŠ¨æ‰“ç ´`Function`ä¸`Variable`ä¹‹é—´çš„å¾ªç¯å¼•ç”¨ï¼Œèƒ½æ›´ç²¾å‡†åœ°æ§åˆ¶å†…å­˜é‡Šæ”¾æ—¶æœºï¼Œé¿å…å› GCå»¶è¿Ÿå¯¼è‡´çš„å†…å­˜é—®é¢˜ã€‚

---

ä½¿ç”¨Pythonçš„`weakref`æ¨¡å—åˆ›å»ºå¼±å¼•ç”¨ï¼Œé¿å…å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼š

- **ä¿®æ”¹`Function`ç±»**ï¼š

```python
import weakref

class Function:
    def __call__(self, *inputs):
        # åŸæœ‰ä»£ç ...
        self.outputs = [weakref.ref(output) for output in outputs]  # å°†å¼ºå¼•ç”¨æ”¹ä¸ºå¼±å¼•ç”¨
```

å¼±å¼•ç”¨ä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå½“`Variable`å®ä¾‹ä¸å†è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨æ—¶ï¼Œä¼šè¢«æ­£å¸¸å›æ”¶ã€‚

- **ä¿®æ”¹`Variable`ç±»çš„`backward`æ–¹æ³•**ï¼š

```python
class Variable:
    def backward(self):
        # åŸæœ‰ä»£ç ...
        gys = [output().grad for output in f.outputs]  # é€šè¿‡output()è·å–å®é™…å¯¹è±¡
```

ä½¿ç”¨`output()`ä»å¼±å¼•ç”¨ä¸­è·å–`Variable`å®ä¾‹ï¼Œé¿å…ç›´æ¥å¼•ç”¨å¯¼è‡´å¾ªç¯ã€‚

**æ€»ç»“:**

- å¾ªç¯å¼•ç”¨ä¼šå¯¼è‡´Pythonå¯¹è±¡æ— æ³•è¢«æ­£å¸¸å›æ”¶ï¼Œéœ€é€šè¿‡å¼±å¼•ç”¨è§£å†³ã€‚

- åœ¨TinyPytorchä¸­ï¼Œå°†`Function`å¯¹`Variable`çš„å¼•ç”¨æ”¹ä¸ºå¼±å¼•ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

- ä¼˜åŒ–åçš„å†…å­˜ç®¡ç†ç¡®ä¿æ¡†æ¶åœ¨å¤„ç†å¤§è§„æ¨¡è®¡ç®—æ—¶çš„ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚

## æ­¥éª¤18: ä¼˜åŒ–å†…å­˜æ¶ˆè€—

**ä¼˜åŒ–åå‘ä¼ æ’­çš„å†…å­˜æ¶ˆè€—:** DeZeroå½“å‰çš„åå‘ä¼ æ’­ä¼šä¿ç•™æ‰€æœ‰å˜é‡çš„å¯¼æ•°ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä»…ç»ˆç«¯å˜é‡çš„å¯¼æ•°éœ€è¦è¢«ä¿ç•™ï¼Œä¸­é—´å˜é‡çš„å¯¼æ•°å¾€å¾€æ— ç”¨ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¼•å…¥**é‡Šæ”¾ä¸­é—´å˜é‡å¯¼æ•°**çš„æœºåˆ¶ã€‚

**ä¿®æ”¹`Variable.backward`æ–¹æ³•**: æ·»åŠ `retain_grad`å‚æ•°ï¼Œè‹¥ä¸º`False`ï¼ˆé»˜è®¤ï¼‰ï¼Œåˆ™åå‘ä¼ æ’­åæ¸…é™¤ä¸­é—´å˜é‡çš„å¯¼æ•°ã€‚

```python
  class Variable:
    def backward(self, retain_grad=False):
        if self.grad is None:
            self.grad = np.ones_like(self.data)

        funcs = []
        seen_set = set()

        def add_func(f):
            if f not in seen_set:
                funcs.append(f)
                seen_set.add(f)
            funcs.sort(key=lambda x: x.generation)

        add_func(self.creator)

        while funcs:
            f = funcs.pop()
            gys = [output().grad for output in f.outputs]
            gxs = f.backward(*gys)

            if not isinstance(gxs, tuple):
                gxs = (gxs,)

            for x, gx in zip(f.inputs, gxs):
                if x.grad is None:
                    x.grad = gx
                else:
                    x.grad = x.grad + gx

                if x.creator is not None:
                    add_func(x.creator)

            if not retain_grad:
                for y in f.outputs:
                    y().grad = None  # æ¸…é™¤ä¸­é—´å˜é‡çš„å¯¼æ•°
```  
- **éªŒè¯æ¡ˆä¾‹**ï¼š  

```python
  x0 = Variable(np.array(1.0))
  x1 = Variable(np.array(1.0))
  t = add(x0, x1)
  y = add(x0, t)
  y.backward()  # retain_gradé»˜è®¤False
  
  print(y.grad, t.grad)  # è¾“å‡ºï¼šNone Noneï¼ˆä¸­é—´å˜é‡å¯¼æ•°è¢«æ¸…é™¤ï¼‰
  print(x0.grad, x1.grad)  # è¾“å‡ºï¼š2.0 1.0ï¼ˆç»ˆç«¯å˜é‡å¯¼æ•°ä¿ç•™ï¼‰
```  
ä¸­é—´å˜é‡`y`å’Œ`t`çš„å¯¼æ•°è¢«ç«‹å³é‡Šæ”¾ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚  

---

**ç¦ç”¨åå‘ä¼ æ’­çš„æ¨¡å¼ä¼˜åŒ–:** åœ¨æ¨ç†é˜¶æ®µï¼ˆå¦‚æ¨¡å‹é¢„æµ‹ï¼‰ï¼Œæ— éœ€è®¡ç®—å¯¼æ•°ï¼Œå¯é€šè¿‡**ç¦ç”¨åå‘ä¼ æ’­æ¨¡å¼**è¿›ä¸€æ­¥èŠ‚çœå†…å­˜ã€‚

- **åˆ›å»ºé…ç½®ç±»`Config`**ï¼š  

```python
class Config:
    enable_backprop = True  # æ§åˆ¶åå‘ä¼ æ’­æ˜¯å¦å¯ç”¨
```  

- **ä¿®æ”¹`Function.__call__`æ–¹æ³•**ï¼š  ä»…å½“`Config.enable_backprop`ä¸º`True`æ—¶ï¼Œä¿ç•™åå‘ä¼ æ’­æ‰€éœ€çš„è®¡ç®—å›¾è¿æ¥ï¼š  
  
```python
class Function:
    def __call__(self, *inputs):
        xs = [x.data for x in inputs]
        ys = self.forward(*xs)
        if not isinstance(ys, tuple):
            ys = (ys,)
        outputs = [Variable(as_array(y)) for y in ys]

        if Config.enable_backprop:
            self.generation = max([x.generation for x in inputs])

            for output in outputs:
                output.set_creator(self)

            self.inputs = inputs
            self.outputs = [weakref.ref(output) for output in outputs]

        return outputs if len(outputs) > 1 else outputs[0]
```  

- **æ¨¡å¼åˆ‡æ¢ç¤ºä¾‹**ï¼š  

```python
# å¯ç”¨åå‘ä¼ æ’­ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
x = Variable(np.ones((100, 100, 100)))
y = square(square(square(x)))  # ä¿ç•™ä¸­é—´ç»“æœï¼Œå†…å­˜å ç”¨é«˜
  
# ç¦ç”¨åå‘ä¼ æ’­ï¼ˆæ¨ç†æ¨¡å¼ï¼‰
Config.enable_backprop = False
x = Variable(np.ones((100, 100, 100)))
y = square(square(square(x)))  # ä¸ä¿ç•™ä¸­é—´ç»“æœï¼Œå†…å­˜å ç”¨ä½
```  

ç¦ç”¨æ¨¡å¼ä¸‹ï¼Œè®¡ç®—å®Œæˆåä¸­é—´å˜é‡ç«‹å³é‡Šæ”¾ï¼Œå†…å­˜ä½¿ç”¨é‡å¤§å¹…é™ä½ã€‚  

---

**ä½¿ç”¨`with`è¯­å¥ä¾¿æ·åˆ‡æ¢æ¨¡å¼:**  ä¸ºé¿å…æ‰‹åŠ¨ä¿®æ”¹`Config`å±æ€§ï¼Œå¯é€šè¿‡`contextlib`æ¨¡å—å®ç°`with`è¯­å¥ä¸Šä¸‹æ–‡ç®¡ç†ã€‚

- **å®ç°`using_config`å‡½æ•°**ï¼š  

```python
import contextlib
  
@contextlib.contextmanager
def using_config(name, value):
    old_value = getattr(Config, name)
    setattr(Config, name, value)
    try:
        yield
    finally:
        setattr(Config, name, old_value)
```  
- **å°è£…`no_grad`å‡½æ•°**ï¼š  
  
```python
def no_grad():
    return using_config('enable_backprop', False)
  
# ä½¿ç”¨ç¤ºä¾‹
with no_grad():
    x = Variable(np.array(2.0))
    y = square(x)  # ç¦ç”¨åå‘ä¼ æ’­ï¼Œä¸æ„å»ºè®¡ç®—å›¾
```  

é€€å‡º`with`å—åï¼Œæ¨¡å¼è‡ªåŠ¨æ¢å¤ï¼Œé¿å…å› å¿˜è®°é‡ç½®é…ç½®å¯¼è‡´çš„é”™è¯¯ã€‚  

--- 

**ä¼˜åŒ–æ•ˆæœæ€»ç»“**: 

- **å†…å­˜é‡Šæ”¾æœºåˆ¶**ï¼šé€šè¿‡`retain_grad`å‚æ•°åŠæ—¶æ¸…é™¤ä¸­é—´å˜é‡å¯¼æ•°ï¼Œé¿å…å†…å­˜é•¿æœŸå ç”¨ã€‚  

- **æ¨ç†æ¨¡å¼ä¼˜åŒ–**ï¼šç¦ç”¨åå‘ä¼ æ’­åï¼Œè®¡ç®—è¿‡ç¨‹ä¸ä¿ç•™è®¡ç®—å›¾è¿æ¥ï¼Œé€‚åˆæ— éœ€æ¢¯åº¦çš„åœºæ™¯ï¼ˆå¦‚æ¨¡å‹é¢„æµ‹ï¼‰ã€‚  

- **å·¥ç¨‹å®è·µ**ï¼š`with no_grad()`è¯­æ³•ç®€æ´ï¼Œä¾¿äºåœ¨è®­ç»ƒå’Œæ¨ç†é˜¶æ®µçµæ´»åˆ‡æ¢ï¼Œæå‡ä»£ç å¯è¯»æ€§å’Œé²æ£’æ€§ã€‚

## æ­¥éª¤19: Variable åŠŸèƒ½å¢å¼º

ä¸ºäº†ä¾¿äºåŒºåˆ†å’Œè°ƒè¯•ï¼Œåœ¨`Variable`ç±»ä¸­æ·»åŠ `name`å±æ€§ï¼Œæ”¯æŒä¸ºå˜é‡è®¾ç½®è‡ªå®šä¹‰åç§°ï¼š  

```python
class Variable:
    def __init__(self, data, name=None):
        if data is not None:
            if not isinstance(data, np.ndarray):
                raise TypeError(f'{type(data)} is not supported')
        
        self.data = data
        self.name = name  # æ–°å¢åç§°å±æ€§
        self.creator = None
        self.grad = None
        self.generation = 0
```  

- **ä½¿ç”¨ç¤ºä¾‹**ï¼š 

```python
x = Variable(np.array(1.0), name='input_x')
y = Variable(np.array(2.0), name='input_y')
```  

å˜é‡åç§°å¯åœ¨è®¡ç®—å›¾å¯è§†åŒ–ç­‰åœºæ™¯ä¸­æ˜¾ç¤ºï¼Œæå‡è°ƒè¯•æ•ˆç‡ã€‚  

---

ä½¿`Variable`å®ä¾‹å…·å¤‡`ndarray`çš„è¡Œä¸ºç‰¹å¾ï¼Œéšè—æ•°æ®å°è£…ç»†èŠ‚ï¼š  

- **æ·»åŠ `shape`ã€`ndim`ã€`size`ã€`dtype`å±æ€§**:

```python
class Variable:
    @property
    def shape(self):
        return self.data.shape  # è·å–æ•°æ®å½¢çŠ¶
      
    @property
    def ndim(self):
        return self.data.ndim  # è·å–ç»´åº¦æ•°
      
    @property
    def size(self):
        return self.data.size  # è·å–å…ƒç´ æ€»æ•°
      
    @property
    def dtype(self):
        return self.data.dtype  # è·å–æ•°æ®ç±»å‹
```  

- **ç¤ºä¾‹éªŒè¯**ï¼š 

```python
x = Variable(np.array([[1, 2, 3], [4, 5, 6]]))
print(x.shape)  # è¾“å‡ºï¼š(2, 3)
print(x.ndim)   # è¾“å‡ºï¼š2
print(x.size)   # è¾“å‡ºï¼š6
print(x.dtype)  # è¾“å‡ºï¼šint64
```  

å˜é‡å®ä¾‹å¯ç›´æ¥è®¿é—®`ndarray`çš„æ ¸å¿ƒå±æ€§ï¼Œä½¿ç”¨æˆ·æ— éœ€å…³å¿ƒ`data`å±æ€§ã€‚  

- **å®ç°`__len__`æ–¹æ³•**ï¼š  

```python
class Variable:
    def __len__(self):
        return len(self.data)  # è¿”å›ç¬¬1ç»´åº¦çš„å…ƒç´ æ•°
```  
  
- **ç¤ºä¾‹**ï¼š  

```python
x = Variable(np.array([1, 2, 3, 4]))
print(len(x))  # è¾“å‡ºï¼š4
    
y = Variable(np.array([[1, 2], [3, 4]]))
print(len(y))  # è¾“å‡ºï¼š2
```  

- **è‡ªå®šä¹‰æ‰“å°æ ¼å¼**ï¼š  
  
```python
  class Variable:
    def __repr__(self):
        if self.data is None:
            return 'variable(None)'
        data_str = str(self.data).replace('\n', '\n' + ' ' * 9)
        return f'variable({data_str})'
```  

- **è¾“å‡ºæ•ˆæœ**ï¼š  
    
```python
x = Variable(np.array([1, 2, 3]))
print(x)  # è¾“å‡ºï¼švariable([1 2 3])
    
y = Variable(np.array([[1, 2], [3, 4]]))
print(y)  # è¾“å‡ºï¼š
          # variable([[1 2]
          #           [3 4]])
```  

æ‰“å°æ—¶è‡ªåŠ¨å¯¹é½å¤šè¡Œæ•°æ®ï¼Œå¹¶æ ‡æ³¨â€œvariableâ€å‰ç¼€ï¼Œä¾¿äºè¯†åˆ«å˜é‡ç±»å‹ã€‚  

 > å¯ç»§ç»­æ·»åŠ `ndarray`çš„å…¶ä»–å±æ€§ï¼ˆå¦‚`T`è½¬ç½®ã€`flat`è¿­ä»£å™¨ç­‰ï¼‰ï¼Œæˆ–å®ç°`__getitem__`ã€`__setitem__`æ–¹æ³•ä»¥æ”¯æŒæ•°ç»„ç´¢å¼•ï¼Œè¿›ä¸€æ­¥å¼ºåŒ–å˜é‡çš„â€œé€æ˜ç®±å­â€ç‰¹æ€§ã€‚


## æ­¥éª¤20â€“22: è¿ç®—ç¬¦é‡è½½

**ä¹˜æ³•è¿ç®—çš„å®ç°ä¸è¿ç®—ç¬¦é‡è½½**ï¼š

åœ¨æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­ï¼Œä¹˜æ³•è¿ç®—æ˜¯æœ€åŸºç¡€çš„æ“ä½œä¹‹ä¸€ã€‚ä¸ºäº†è®©`Variable`å®ä¾‹æ”¯æŒè‡ªç„¶çš„ä¹˜æ³•è¡¨è¾¾å¼ï¼ˆå¦‚`a * b`ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å®ç°`Mul`ç±»æ¥å¤„ç†æ­£å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°`*`è¿ç®—ç¬¦ä¸Šã€‚  

- **æ­£å‘ä¼ æ’­**ï¼šè®¡ç®—ä¸¤ä¸ªè¾“å…¥å˜é‡çš„ä¹˜ç§¯ï¼Œå³`y = x0 * x1`ã€‚  

- **åå‘ä¼ æ’­**ï¼šæ ¹æ®å¯¼æ•°å…¬å¼ï¼Œè‹¥`y = x0 * x1`ï¼Œåˆ™$\frac{\partial y}{\partial x0} = x1$ï¼Œ$\frac{\partial y}{\partial x1} = x0$ã€‚å› æ­¤ï¼Œåå‘ä¼ æ’­æ—¶éœ€è¦å°†ä¸Šæ¸¸ä¼ æ¥çš„æ¢¯åº¦`gy`åˆ†åˆ«ä¹˜ä»¥`x1`å’Œ`x0`ï¼Œä¼ é€’ç»™ä¸‹æ¸¸å˜é‡ã€‚  

```python
class Mul(Function):
    def forward(self, x0, x1):
        y = x0 * x1
        return y

    def backward(self, gy):
        x0, x1 = self.inputs[0].data, self.inputs[1].data
        return gy * x1, gy * x0  # å°†æ¢¯åº¦åˆ†åˆ«ä¹˜ä»¥x1å’Œx0
```  

ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†`Mul`ç±»å°è£…ä¸ºPythonå‡½æ•°`mul`ï¼Œå¹¶é€šè¿‡`Variable.__mul__`å’Œ`Variable.__rmul__`ç»‘å®šä¹˜æ³•è¿ç®—ç¬¦ï¼Œä½¿å…¶æ”¯æŒå·¦å³æ“ä½œæ•°ä¸º`Variable`çš„æƒ…å†µã€‚ç”±äºä¹˜æ³•æ»¡è¶³äº¤æ¢å¾‹ï¼Œ`__mul__`å’Œ`__rmul__`å¯å…±ç”¨åŒä¸€å®ç°ã€‚  

```python
def mul(x0, x1):
    x1 = as_array(x1)
    return Mul()(x0, x1)

Variable.__mul__ = mul    # å¤„ç†a * b
Variable.__rmul__ = mul   # å¤„ç†b * a
```  

---

**åŠ æ³•è¿ç®—çš„è¿ç®—ç¬¦é‡è½½**:  

åŠ æ³•è¿ç®—çš„`Add`ç±»å·²åœ¨ä¸Šæ–‡ä¸­å®ç°ï¼Œå…¶åå‘ä¼ æ’­é€»è¾‘ä¸ºå°†ä¸Šæ¸¸æ¢¯åº¦åŸå°ä¸åŠ¨åœ°ä¼ é€’ç»™ä¸¤ä¸ªè¾“å…¥å˜é‡ï¼ˆå› ä¸º$\frac{\partial y}{\partial x0} = 1$ï¼Œ$\frac{\partial y}{\partial x1} = 1$ï¼‰ã€‚ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å°†`Add`ç±»ç»‘å®šåˆ°`+`è¿ç®—ç¬¦ï¼š  

```python
def add(x0, x1):
    x1 = as_array(x1)
    return Add()(x0, x1)
    
Variable.__add__ = add     # å¤„ç†a + b
Variable.__radd__ = add    # å¤„ç†b + a
```  
---

**å¤åˆè¿ç®—çš„éªŒè¯**:

é€šè¿‡ç»„åˆåŠ æ³•å’Œä¹˜æ³•è¿ç®—ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯æ¡†æ¶æ˜¯å¦æ”¯æŒå¤æ‚è¡¨è¾¾å¼çš„è‡ªåŠ¨å¾®åˆ†ã€‚ä¾‹å¦‚ï¼Œè®¡ç®—`y = a * b + c`å¹¶æ±‚å¯¼ï¼š  

```python
a = Variable(np.array(3.0))
b = Variable(np.array(2.0))
c = Variable(np.array(1.0))
y = a * b + c  # ç­‰ä»·äº add(mul(a, b), c)
y.backward()

print(y.data)   # è¾“å‡ºï¼š7.0ï¼ˆ3*2+1ï¼‰
print(a.grad)  # è¾“å‡ºï¼š2.0ï¼ˆâˆ‚y/âˆ‚a = bï¼‰
print(b.grad)  # è¾“å‡ºï¼š3.0ï¼ˆâˆ‚y/âˆ‚b = aï¼‰
print(c.grad)  # è¾“å‡ºï¼š1.0ï¼ˆâˆ‚y/âˆ‚c = 1ï¼‰
```  

æ­¤ä¾‹ä¸­ï¼Œåå‘ä¼ æ’­æ­£ç¡®è®¡ç®—äº†æ¯ä¸ªå˜é‡çš„æ¢¯åº¦ï¼Œè¯æ˜è¿ç®—ç¬¦é‡è½½ä¸è‡ªåŠ¨å¾®åˆ†æœºåˆ¶çš„ä¸€è‡´æ€§ã€‚  

---

**(å¯é€‰éƒ¨åˆ†)** åœ¨Pythonä¸­ï¼Œè¿ç®—ç¬¦é‡è½½éœ€è¦åŒæ—¶è€ƒè™‘å·¦å³è¿ç®—ç¬¦ï¼ˆå¦‚`__add__`å’Œ`__radd__`ï¼‰ï¼Œè¿™æ˜¯ç”±Pythonçš„è¿ç®—ç¬¦è°ƒåº¦æœºåˆ¶å†³å®šçš„ã€‚å½“è¡¨è¾¾å¼ä¸­çš„å·¦å³æ“ä½œæ•°ç±»å‹ä¸åŒæ—¶ï¼ŒPythonä¼šæ ¹æ®æ“ä½œæ•°çš„ç±»å‹é€‰æ‹©ä¸åŒçš„æ–¹æ³•è°ƒç”¨è·¯å¾„ã€‚Pythonä¸­ï¼Œè¿ç®—ç¬¦çš„è°ƒç”¨é¡ºåºéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

1. **å·¦æ“ä½œæ•°ä¼˜å…ˆ**ï¼šå½“æ‰§è¡Œè¡¨è¾¾å¼`a OP b`æ—¶ï¼ŒPythoné¦–å…ˆå°è¯•è°ƒç”¨å·¦æ“ä½œæ•°`a`çš„`__OP__`æ–¹æ³•ã€‚

2. **å³æ“ä½œæ•° fallback**ï¼šå¦‚æœå·¦æ“ä½œæ•°æœªå®ç°`__OP__`æ–¹æ³•ï¼Œæˆ–è¿”å›`NotImplemented`ï¼Œåˆ™å°è¯•è°ƒç”¨å³æ“ä½œæ•°`b`çš„`__rOP__`æ–¹æ³•ã€‚

ä»¥åŠ æ³•`a + b`ä¸ºä¾‹ï¼š

- é¦–å…ˆè°ƒç”¨`a.__add__(b)`ï¼›

- è‹¥`a`æœªå®ç°`__add__`æˆ–è¿”å›`NotImplemented`ï¼Œåˆ™è°ƒç”¨`b.__radd__(a)`ã€‚

å½“æ“ä½œæ•°ç±»å‹ä¸åŒæ—¶ï¼ˆå¦‚`Variable`ä¸æ•°å€¼ã€`ndarray`æ··åˆè¿ç®—ï¼‰ï¼Œå¿…é¡»é€šè¿‡`__rOP__`å¤„ç†å³æ“ä½œæ•°ä¸ºè‡ªå®šä¹‰ç±»å‹çš„æƒ…å†µã€‚ä¾‹å¦‚ï¼š

- `x + 3`ï¼šå·¦æ“ä½œæ•°`x`æ˜¯`Variable`ï¼Œè°ƒç”¨`x.__add__(3)`ï¼Œå¯æ­£å¸¸è½¬æ¢`3`ä¸º`Variable`ï¼›

- `3 + x`ï¼šå·¦æ“ä½œæ•°`3`æ˜¯`int`ï¼Œä¸å…·å¤‡`__add__`æ–¹æ³•å¤„ç†`Variable`ï¼Œå› æ­¤éœ€è°ƒç”¨`x.__radd__(3)`ã€‚

**åœ¨Pythonçš„è¿ç®—ç¬¦é‡è½½ä¸­ï¼Œä»¥`def __add__(self, other)`ä¸ºä¾‹ï¼Œ`self`å’Œ`other`æ˜¯ä¸¤ä¸ªå…³é”®å…¥å‚**:

1. `self`ï¼šåœ¨è¡¨è¾¾å¼`a + b`ä¸­ï¼Œ`self`æŒ‡ä»£å·¦æ“ä½œæ•°`a`ï¼Œå³è°ƒç”¨`__add__`æ–¹æ³•çš„å®ä¾‹ã€‚

2. `other`ï¼šåœ¨è¡¨è¾¾å¼`a + b`ä¸­ï¼Œ`other`æŒ‡ä»£å³æ“ä½œæ•°`b`ï¼Œå³è°ƒç”¨`__radd__`æ–¹æ³•çš„å®ä¾‹ã€‚

**åœ¨ Python çš„è¿ç®—ç¬¦é‡è½½ä¸­ï¼Œä»¥def __radd__(self, other)ä¸ºä¾‹ï¼Œselfå’Œotheræ˜¯ä¸¤ä¸ªå…³é”®å…¥å‚**ï¼š

1. åœ¨è¡¨è¾¾å¼`a + b`ä¸­ï¼Œè‹¥å·¦æ“ä½œæ•°aä¸æ”¯æŒ`__add__`æ–¹æ³•ï¼ˆæˆ–è¿”å›NotImplementedï¼‰ï¼Œåˆ™ä¼šè°ƒç”¨å³æ“ä½œæ•°bçš„`__radd__`æ–¹æ³•ã€‚æ­¤æ—¶ï¼ŒselfæŒ‡ä»£å³æ“ä½œæ•°bï¼Œå³è°ƒç”¨`__radd__`æ–¹æ³•çš„å®ä¾‹

2. åœ¨`__radd__`æ–¹æ³•ä¸­ï¼ŒotheræŒ‡ä»£å·¦æ“ä½œæ•°aï¼Œå…¶ç±»å‹å¯èƒ½æ˜¯åŸç”Ÿæ•°å€¼ã€ndarrayæˆ–Variableã€‚

---

**æ”¯æŒä¸ndarrayåŠæ•°å€¼ç±»å‹çš„æ··åˆè¿ç®—**: 

ä¸ºäº†æå‡æ¡†æ¶çš„æ˜“ç”¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦è®©`Variable`å®ä¾‹èƒ½ä¸NumPyæ•°ç»„ï¼ˆ`ndarray`ï¼‰ã€Pythonæ•°å€¼ç±»å‹ï¼ˆå¦‚`int`ã€`float`ï¼‰ç›´æ¥è¿›è¡Œè¿ç®—ã€‚å…³é”®åœ¨äºå®ç°ç±»å‹è½¬æ¢å·¥å…·å‡½æ•°`as_variable`ï¼Œå°†é`Variable`å¯¹è±¡è½¬æ¢ä¸º`Variable`å®ä¾‹ï¼š  

```python
def as_variable(obj):
    if isinstance(obj, Variable):
        return obj
    return Variable(obj)  # å°†ndarrayæˆ–æ•°å€¼è½¬æ¢ä¸ºVariable
```  

åŒæ—¶ï¼Œä¿®æ”¹`Function`ç±»çš„`__call__`æ–¹æ³•ï¼Œåœ¨æ¥æ”¶è¾“å…¥æ—¶è‡ªåŠ¨å°†å‚æ•°è½¬æ¢ä¸º`Variable`ï¼š  

```python
class Function:
    def __call__(self, *inputs):
        inputs = [as_variable(x) for x in inputs]  # ç»Ÿä¸€è½¬æ¢ä¸ºVariable
        xs = [x.data for x in inputs]
        # åç»­è®¡ç®—é€»è¾‘...
```  

è¿™æ ·ï¼Œå½“æ‰§è¡Œ`x + np.array(3.0)`æˆ–`x + 3.0`æ—¶ï¼Œå³ä¾§çš„`ndarray`æˆ–æ•°å€¼ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸º`Variable`ï¼Œç¡®ä¿è¿ç®—æ­£å¸¸è¿›è¡Œã€‚  

---

**å¤„ç†è¿ç®—ç¬¦çš„å·¦å³æ“ä½œæ•°å·®å¼‚**:  

ä»¥ä¹˜æ³•ä¸ºä¾‹ï¼Œå½“è¡¨è¾¾å¼ä¸º`3.0 * x`æ—¶ï¼ŒPythonä¼šè°ƒç”¨`x`çš„`__rmul__`æ–¹æ³•ï¼ˆå³ä¹˜ï¼‰ã€‚ç”±äºä¹˜æ³•æ»¡è¶³äº¤æ¢å¾‹ï¼Œ`__rmul__`å¯å¤ç”¨`__mul__`çš„å®ç°ï¼š  

```python
Variable.__rmul__ = mul  # ä¸__mul__å…±ç”¨é€»è¾‘ï¼Œæ”¯æŒ3.0 * x
```  

ç±»ä¼¼åœ°ï¼Œå¯¹äºä¸æ»¡è¶³äº¤æ¢å¾‹çš„è¿ç®—ç¬¦ï¼ˆå¦‚å‡æ³•ï¼‰ï¼Œéœ€è¦åˆ†åˆ«å¤„ç†å·¦å³æ“ä½œæ•°ã€‚ä¾‹å¦‚ï¼Œ`2.0 - x`éœ€è¦è°ƒç”¨`x`çš„`__rsub__`æ–¹æ³•ï¼Œæ­¤æ—¶éœ€äº¤æ¢æ“ä½œæ•°é¡ºåºå¹¶è°ƒç”¨`Sub`ç±»ï¼š  

```python
def rsub(x0, x1):
    return Sub()(x1, x0)  # å®ç°a - b = Sub(b, a)
Variable.__rsub__ = rsub
```  

---

**è¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸ç±»å‹è½¬æ¢**:  

ä¸ºäº†ç¡®ä¿`Variable`å®ä¾‹åœ¨æ··åˆè¿ç®—ä¸­ä¼˜å…ˆè¢«å¤„ç†ï¼Œæˆ‘ä»¬ä¸º`Variable`ç±»æ·»åŠ `__array_priority__`å±æ€§ï¼Œè®¾ç½®å…¶ä¼˜å…ˆçº§é«˜äº`ndarray`ï¼ˆé»˜è®¤ä¼˜å…ˆçº§ä¸º100ï¼‰ï¼š  

```python
class Variable:
    __array_priority__ = 200  # é«˜äºndarrayçš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿ç±»å‹è½¬æ¢ä¼˜å…ˆ
```  

è¿™ä½¿å¾—å½“è¡¨è¾¾å¼ä¸º`np.array([2.0]) + x`æ—¶ï¼Œ`x`çš„`__radd__`æ–¹æ³•ä¼šè¢«ä¼˜å…ˆè°ƒç”¨ï¼Œä¿è¯è¿ç®—æŒ‰é¢„æœŸæ‰§è¡Œã€‚  

---

**è´Ÿæ•°è¿ç®—ï¼ˆ`-`ï¼‰çš„å®ç°**:

è´Ÿæ•°è¿ç®—`y = -x`çš„æ­£å‘ä¼ æ’­ç®€å•åœ°å¯¹è¾“å…¥å–åï¼Œåå‘ä¼ æ’­æ—¶å°†ä¸Šæ¸¸æ¢¯åº¦å–åï¼ˆå› ä¸º$\frac{\partial y}{\partial x} = -1$ï¼‰ï¼š  

```python
class Neg(Function):
    def forward(self, x):
        return -x

    def backward(self, gy):
        return -gy  # æ¢¯åº¦å–å
```  

ç»‘å®š`-`è¿ç®—ç¬¦åˆ°`neg`å‡½æ•°ï¼š  

```python
def neg(x):
    return Neg()(x)
Variable.__neg__ = neg  # æ”¯æŒy = -x
```  
---

**å‡æ³•è¿ç®—ï¼ˆ`-`ï¼‰çš„å®Œæ•´å®ç°**:
 
å‡æ³•è¿ç®—`y = x0 - x1`çš„åå‘ä¼ æ’­ä¸­ï¼Œ$\frac{\partial y}{\partial x0} = 1$ï¼Œ$\frac{\partial y}{\partial x1} = -1$ï¼Œå› æ­¤åå‘ä¼ æ’­æ—¶éœ€å°†ä¸Šæ¸¸æ¢¯åº¦`gy`åˆ†åˆ«ä¹˜ä»¥1å’Œ-1ï¼š  

```python
class Sub(Function):
    def forward(self, x0, x1):
        return x0 - x1

    def backward(self, gy):
        return gy, -gy  # æ¢¯åº¦åˆ†åˆ«ä¹˜ä»¥1å’Œ-1
```  

ç”±äºå‡æ³•ä¸æ»¡è¶³äº¤æ¢å¾‹ï¼Œéœ€åˆ†åˆ«å®ç°`__sub__`ï¼ˆå¤„ç†`x0 - x1`ï¼‰å’Œ`__rsub__`ï¼ˆå¤„ç†`x1 - x0`ï¼‰ï¼š  

```python
def sub(x0, x1):
    return Sub()(x0, x1)
def rsub(x0, x1):
    return Sub()(x1, x0)  # äº¤æ¢æ“ä½œæ•°å®ç°a - b

Variable.__sub__ = sub     # æ”¯æŒx0 - x1
Variable.__rsub__ = rsub   # æ”¯æŒx1 - x0
```  

---

**é™¤æ³•è¿ç®—ï¼ˆ`/`ï¼‰çš„å®ç°**: 

é™¤æ³•è¿ç®—`y = x0 / x1`çš„å¯¼æ•°å…¬å¼ä¸º$\frac{\partial y}{\partial x0} = \frac{1}{x1}$ï¼Œ$\frac{\partial y}{\partial x1} = -\frac{x0}{x1^2}$ï¼Œåå‘ä¼ æ’­æ—¶éœ€æŒ‰æ­¤è®¡ç®—æ¢¯åº¦ï¼š  

```python
class Div(Function):
    def forward(self, x0, x1):
        return x0 / x1

    def backward(self, gy):
        x0, x1 = self.inputs[0].data, self.inputs[1].data
        gx0 = gy / x1
        gx1 = -gy * x0 / (x1 ** 2)
        return gx0, gx1  # æŒ‰å¯¼æ•°å…¬å¼è®¡ç®—æ¢¯åº¦
```  

åŒæ ·ï¼Œéœ€å¤„ç†å·¦å³æ“ä½œæ•°çš„é™¤æ³•è¿ç®—ï¼š  

```python
def div(x0, x1):
    return Div()(x0, x1)
def rdiv(x0, x1):
    return Div()(x1, x0)  # äº¤æ¢æ“ä½œæ•°å®ç°a / b

Variable.__truediv__ = div    # æ”¯æŒx0 / x1
Variable.__rtruediv__ = rdiv  # æ”¯æŒx1 / x0
```  
---

**å¹‚è¿ç®—ï¼ˆ`**`ï¼‰çš„å®ç°**:

å¹‚è¿ç®—`y = x ** c`ä¸­ï¼Œ`c`ä¸ºå¸¸æ•°æŒ‡æ•°ï¼Œå…¶å¯¼æ•°å…¬å¼ä¸º$\frac{\partial y}{\partial x} = c \cdot x^{c-1}$ã€‚åå‘ä¼ æ’­æ—¶éœ€æŒ‰æ­¤è®¡ç®—æ¢¯åº¦ï¼š  

```python
class Pow(Function):
    def __init__(self, c):
        self.c = c  # ä¿å­˜æŒ‡æ•°

    def forward(self, x):
        return x ** self.c

    def backward(self, gy):
        x = self.inputs[0].data
        c = self.c
        gx = c * (x ** (c - 1)) * gy  # å¯¼æ•°å…¬å¼ï¼šcÂ·x^(c-1)Â·gy
        return gx
```  

ç»‘å®š`**`è¿ç®—ç¬¦åˆ°`pow`å‡½æ•°ï¼š  

```python
def pow(x, c):
    return Pow(c)(x)
Variable.__pow__ = pow  # æ”¯æŒx ** c
```  

é€šè¿‡æ­¥éª¤20-22çš„å®ç°ï¼ŒTinyPytorchæ¡†æ¶å®ç°äº†å®Œæ•´çš„è¿ç®—ç¬¦é‡è½½ä½“ç³»ï¼Œä½¿å¼€å‘è€…èƒ½ä»¥è‡ªç„¶çš„æ•°å­¦è¡¨è¾¾å¼ç¼–å†™ä»£ç ï¼ˆå¦‚`y = (x + 3) ** 2 / 2`ï¼‰ï¼Œè€Œæ— éœ€è°ƒç”¨ç‰¹å®šå‡½æ•°ã€‚è¿™ç§â€œå¯å¾®åˆ†ç¼–ç¨‹â€çš„æ–¹å¼ä¸ä»…é™ä½äº†å­¦ä¹ æˆæœ¬ï¼Œè¿˜ç¡®ä¿äº†å¤æ‚è¡¨è¾¾å¼çš„è‡ªåŠ¨å¾®åˆ†æ­£ç¡®æ€§ï¼Œä¸ºåç»­å®ç°ç¥ç»ç½‘ç»œå±‚å’Œä¼˜åŒ–ç®—æ³•å¥ å®šäº†åŸºç¡€ã€‚


## æ­¥éª¤23: é¡¹ç›®æ¨¡å—åŒ–ç»“æ„



## æ­¥éª¤24: å¯è§†åŒ–å‡½æ•°å®ç°



## âœ… ç¬¬äºŒé˜¶æ®µæ€»ç»“

è¿™ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬æ„å»ºäº†å¦‚ä¸‹å…³é”®åŠŸèƒ½ï¼š

* å¤šè¾“å…¥/å¤šè¾“å‡ºæ”¯æŒ
* è‡ªåŠ¨åå‘ä¼ æ’­æ‹“æ‰‘æ’åº
* å˜é‡æ¢¯åº¦ç´¯åŠ 
* å¼±å¼•ç”¨å®ç°å›¾çš„è‡ªåŠ¨é‡Šæ”¾
* é…ç½®ç®¡ç†ä¸ä¸Šä¸‹æ–‡æ§åˆ¶
* è¿ç®—ç¬¦é‡è½½è¯­æ³•
* é¡¹ç›®æ¨¡å—ç»“æ„æ•´ç†
* å¯è§†åŒ–è®¡ç®—å›¾

ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬å°†è¿›å…¥è®­ç»ƒæ¨¡å‹æ‰€éœ€çš„ä¼˜åŒ–å™¨ã€ç¥ç»ç½‘ç»œå±‚ã€æ•°æ®é›†å¤„ç†ç­‰æ¨¡å—çš„æ„å»ºï¼Œé€æ­¥å‘å®Œæ•´æ¡†æ¶è¿ˆè¿›ã€‚
