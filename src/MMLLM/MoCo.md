---
title: MoCo è®ºæ–‡
icon: file
category:
  - å¤šæ¨¡æ€
tag:
  - å¤šæ¨¡æ€
  - å·²å‘å¸ƒ
footer: æŠ€æœ¯å…±å»ºï¼ŒçŸ¥è¯†å…±äº«
date: 2025-07-15
author:
  - BinaryOracle
---

`Momentum Contrast for Unsupervised Visual Representation Learning è®ºæ–‡ç®€æ` 

<!-- more -->

> è®ºæ–‡é“¾æ¥: [Momentum Contrast for Unsupervised Visual Representation Learning](https://arxiv.org/abs/1911.05722)
> ä»£ç é“¾æ¥: [https://github.com/facebookresearch/moco](https://github.com/facebookresearch/moco)

## Introduction

å¯¹æ¯”å­¦ä¹ ä»2019å¹´å¼€å§‹åˆ°ç°åœ¨ä¸€ç›´éƒ½æ¯”è¾ƒç«ï¼Œ**Mocoæ˜¯è§†è§‰é¢†åŸŸä½¿ç”¨å¯¹æ¯”å­¦ä¹ ä¸€ä¸ªé‡Œç¨‹ç¢‘çš„å·¥ä½œ**ã€‚

**Mocoä½œä¸ºä¸€ä¸ªæ— ç›‘ç£çš„è¡¨å¾å­¦ä¹ å·¥ä½œï¼Œä¸ä»…åœ¨åˆ†ç±»ä»»åŠ¡ä¸Šé€¼è¿‘äº†æœ‰ç›‘ç£çš„åŸºçº¿æ¨¡å‹ï¼Œåœ¨å…¶ä»–ä»»åŠ¡ï¼Œå¦‚æ£€æµ‹ã€åˆ†å‰²ã€äººä½“å…³é”®ç‚¹æ£€æµ‹ä¸Šéƒ½è¶…è¶Šäº†æœ‰ç›‘ç£çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ImageNetä¸Šçš„é¢„è®­ç»ƒæ¨¡å‹**ï¼›

**Mocoè¯æ˜äº†ä¸€ç‚¹ï¼Œæ— ç›‘ç£å­¦ä¹ çœŸçš„å¯è¡Œï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å¤§é‡æ ‡æ³¨å¥½çš„æ•°æ®**ï¼›

## What is contrast learning?

é¦–å…ˆè¯´å¯¹æ¯”å­¦ä¹ æƒ³è¦åšåˆ°ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ç°åœ¨æœ‰ä¸‰å¼ å›¾ï¼Œç¬¬ä¸€å¼ å›¾æ˜¯äººé«˜å…´ï¼Œç¬¬äºŒå¼ å›¾ç‰‡æ˜¯äººæ‚²ä¼¤ï¼Œç¬¬ä¸‰å¼ å›¾ç‰‡æ˜¯ç‹—ã€‚

æˆ‘ä»¬æƒ³å¾—åˆ°ä¸€ä¸ªç»“æœï¼Œå°±æ˜¯æˆ‘ä»¬ä¸éœ€è¦çŸ¥é“å‰ä¸¤å¼ å›¾ç‰‡æ˜¯äººè¿™ä¸ªç±»åˆ«ï¼Œä¸éœ€è¦çŸ¥é“ç¬¬ä¸‰å¼ å›¾ç‰‡æ˜¯ç‹—è¿™ä¸ªç±»åˆ«ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“å‰ä¸¤å¼ å›¾ç‰‡æ˜¯ä¸€ä¸ªç±»åˆ«ï¼Œç¬¬ä¸‰å¼ å›¾ç‰‡ä¸æ˜¯ä¸€ä¸ªç±»åˆ«ã€‚

![](MoCo/1.png)

æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬ç°åœ¨æŠŠè¿™ä¸‰å¼ å›¾ç‰‡è¾“å…¥ä¸€ä¸ªæ¨¡å‹ï¼Œå¾—åˆ°ä¸‰ä¸ªè¡¨å¾ï¼Œæˆ‘ä»¬éœ€è¦è®©è¿™ä¸‰ä¸ªè¡¨å¾åœ¨ç‰¹å¾ç©ºé—´ä¸­ï¼Œå‰ä¸¤å¼ å›¾ç‰‡çš„è¡¨å¾è·ç¦»æ¯”è¾ƒè¿‘ï¼Œç¬¬ä¸‰å¼ å›¾ç‰‡å’Œå®ƒä»¬çš„è·ç¦»æ¯”è¾ƒè¿œã€‚

![](MoCo/2.png)

ä¸€å¥è¯è¯´ï¼Œ**æˆ‘ä»¬å¸Œæœ›åœ¨ç‰¹å¾ç©ºé—´é‡Œï¼ŒåŒä¸€ä¸ªç±»åˆ«çš„ç‰©ä½“å¤„äºç›¸é‚»çš„åŒºåŸŸï¼Œä¸åŒç±»åˆ«çš„ç‰©ä½“å¤„äºä¸ç›¸é‚»çš„åŒºåŸŸ**ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç”¨åˆ°æ ‡ç­¾ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦çŸ¥é“ç¬¬ä¸€å¼ å’Œç¬¬äºŒå¼ å›¾ç‰‡æ˜¯äººï¼Œç¬¬ä¸‰å¼ æ˜¯ç‹—ã€‚

ä½†æ˜¯æˆ‘ä»¬ç”¨åˆ°äº†å¦å¤–ä¸€ç§ä¿¡æ¯ï¼Œå°±æ˜¯ç¬¬ä¸€å¼ å›¾ç‰‡å’Œç¬¬äºŒå¼ å›¾ç‰‡æ˜¯åŒä¸€ä¸ªç±»åˆ«ï¼Œç¬¬ä¸‰å¼ å›¾ç‰‡ä¸æ˜¯åŒä¸€ä¸ªç±»åˆ«çš„ä¿¡æ¯ã€‚è¿™å…¶å®ä¹Ÿæ˜¯ä¸€ç§æ ‡ç­¾ä¿¡æ¯ã€‚

ä¸è¿‡è¿™ç§æ ‡ç­¾ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›ä»£ç†ä»»åŠ¡ï¼Œå·§å¦™æ„é€ å‡ºæ¥ï¼Œè€Œä¸éœ€è¦äººä¸ºåœ°å»æ ‡æ³¨è¿™ç§æ ‡ç­¾ä¿¡æ¯ã€‚è¿™äº›ä»£ç†ä»»åŠ¡ï¼Œä¼šå»å®šä¹‰ä¸€äº›è§„åˆ™ï¼Œè¿™äº›è§„åˆ™å¯ä»¥å»å®šä¹‰å“ªäº›å›¾ç‰‡æ˜¯ç›¸ä¼¼çš„ï¼Œå“ªäº›å›¾ç‰‡æ˜¯ä¸ç›¸ä¼¼çš„ï¼Œä»è€Œå¯ä»¥æä¾›ä¸€äº›ç›‘ç£ä¿¡å·ç»™åˆ°æ¨¡å‹å»è®­ç»ƒã€‚**è¿™ä¸ªè¿‡ç¨‹å…¶å®ä¹Ÿæ˜¯è‡ªç›‘ç£è®­ç»ƒçš„ä¸€ä¸ªè¿‡ç¨‹**ã€‚

## instance discrimination task

**ä¸€ä¸ªæœ€ç»å…¸çš„ä»£ç†ä»»åŠ¡å°±æ˜¯ï¼šinstance discriminationï¼Œå«åšä¸ªä½“åˆ¤åˆ«**ã€‚

è¿™ä¸ªä»£ç†ä»»åŠ¡æ˜¯æŒ‡ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæ²¡æœ‰æ ‡æ³¨çš„æ•°æ®é›†ï¼Œé‡Œé¢æœ‰nä¸ªå›¾ç‰‡ã€‚

ä»è¿™ä¸ªæ•°æ®é›†ä¸­ï¼Œæˆ‘ä»¬éšæœºé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡ $x_{i}$ï¼Œå¯¹è¿™ä¸ªå›¾ç‰‡åšéšæœºè£å‰ªï¼ˆæˆ–è€…å…¶ä»–çš„æ•°æ®å¢å¹¿æ“ä½œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºtransformationï¼‰ï¼Œä»è€Œå¾—åˆ°å¦å¤–ä¸¤å¼ å›¾ï¼›

ä¸€ä¸ªæ˜¯ $x_{i1}$ ä¸€ä¸ªæ˜¯ $x_{i2}$ï¼Œè¿™æ ·æˆ‘ä»¬ä¼šå¾—åˆ°ä¸¤ä¸ªä¸å¤ªä¸€æ ·çš„ç…§ç‰‡ã€‚ä½†æ˜¯ç”±äºè¿™ä¸¤å¼ å›¾ç‰‡æ˜¯ä»åŒä¸€ä¸ªå›¾ç‰‡ç»è¿‡æŸç§å˜åŒ–å¾—åˆ°çš„ï¼Œè¯­ä¹‰ä¿¡æ¯ä¸åº”è¯¥å‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥è¿™ä¸¤å¼ å›¾ç‰‡å°±å¯ä»¥ç§°ä¹‹ä¸ºæ­£æ ·æœ¬ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ä¸ªç±»åˆ«çš„å›¾ç‰‡ã€‚

è¿™ä¸ªä»£ç†ä»»åŠ¡ï¼ŒåŒæ—¶è®¤ä¸ºï¼Œè¿™ä¸ªæ•°æ®é›†ä¸­å‰©ä½™çš„æ‰€æœ‰å›¾ç‰‡éƒ½æ˜¯è´Ÿæ ·æœ¬ã€‚

![](MoCo/3.png)

ä¸ºä»€ä¹ˆå«åšä¸ªä½“åˆ¤åˆ«å‘¢ï¼Ÿå› ä¸ºå®ƒè®¤ä¸ºæ¯ä¸ªå›¾ç‰‡è‡ªæˆä¸€ä¸ªç±»åˆ«ï¼Œå‰©ä½™çš„å›¾ç‰‡éƒ½ä¸æ˜¯åŒä¸€ä¸ªç±»åˆ«ã€‚

> è¿™ä¸ªç²’åº¦å…¶å®æ˜¯å¾ˆç»†ï¼Œä½ åœ¨å›¾ç‰‡åˆ†ç±»çš„æ—¶å€™å¾ˆå¤šç…§ç‰‡æ˜¯åŒä¸€ä¸ªç±»åˆ«ï¼Œå…¶ä½™çš„ç…§ç‰‡åˆåˆ†ä¸ºäº†å¾ˆå¤šç±»åˆ«ï¼Œæ‰€ä»¥ä¸ªä½“åˆ¤åˆ«è¿™ä¸ªä»£ç†ä»»åŠ¡ç»è¿‡æ¨¡å‹è®­ç»ƒï¼Œ**è¡¨å¾ä¼šå¾ˆç»†**ã€‚

å¯¹äºImageNetè¿™ä¸ªæ•°æ®é›†æ¥è¯´ï¼Œå¦‚æœæ˜¯ä¸ªä½“åˆ¤åˆ«ä»»åŠ¡ï¼Œä¸æ˜¯ä¸€åƒä¸ªç±»åˆ«ï¼Œè€Œæ˜¯100å¤šä¸‡ä¸ªç±»åˆ«ã€‚

æ‰€ä»¥ä¸ªä½“åˆ¤åˆ«è¿™ä¸ªä»£ç†ä»»åŠ¡å®šä¹‰äº†ä»€ä¹ˆæ˜¯æ­£æ ·æœ¬ï¼Œä»€ä¹ˆæ˜¯è´Ÿæ ·æœ¬ï¼Œæ¥ä¸‹æ¥å°±å¾ˆç®€å•äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ç»è¿‡æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªå¯¹æ¯”å­¦ä¹ çš„å‡½æ•°å»è®­ç»ƒæ¨¡å‹å°±å¯ä»¥äº†ï¼Œæ¯”å¦‚è¯´NCElossã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå…¶å®æœ‰ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹ï¼Œå°±æ˜¯ä»£ç†ä»»åŠ¡æ˜¯å¤šæ ·æ€§çš„ï¼Œæ˜¯å¾ˆçµæ´»çš„ã€‚**åªè¦ä½ èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªåˆ¤æ–­æ­£æ ·æœ¬å’Œè´Ÿæ ·æœ¬çš„è§„å¾‹ï¼Œåç»­çš„æŸå¤±å‡½æ•°ä¹‹ç±»çš„è®­ç»ƒå°±å¾ˆå¸¸è§„äº†**ã€‚

æ¯”å¦‚è¯´åœ¨è§†é¢‘é¢†åŸŸï¼ŒåŒä¸€ä¸ªè§†é¢‘é‡Œçš„ä»»æ„ä¸¤å¸§æ˜¯æ­£æ ·æœ¬ï¼Œå…¶ä»–è§†é¢‘é‡Œçš„å¸§æ˜¯è´Ÿæ ·æœ¬ï¼›

## Momentum Contrast

**Moco è¿™ä¸ªåå­—å°±æ˜¯æ¥æºäºå‰ä¸¤ä¸ªå•è¯çš„å‰ä¸¤ä¸ªå­—æ¯ï¼Œå³åŸºäºåŠ¨é‡çš„å¯¹æ¯”å­¦ä¹ **ã€‚

åŠ¨é‡æ˜¯ä¸€ç§åŠ æƒç§»åŠ¨å¹³å‡:

$$
Y_{t} =  m * Y_{t-1} + (1 - m) * X_{t}
$$

$y_{t-1}$ æ˜¯ä¸Šä¸€ä¸ªæ—¶åˆ»çš„è¾“å‡ºï¼Œ$m$ æ˜¯åŠ¨é‡è¶…å‚æ•°ï¼Œ$x_{t}$ æ˜¯å½“å‰æ—¶åˆ»çš„è¾“å…¥ã€‚

è¯´ç™½äº†ï¼Œå°±æ˜¯ä¸æƒ³è®©å½“å‰æ—¶åˆ»çš„è¾“å‡ºåªæ˜¯ä¾èµ–äºå½“å‰æ—¶åˆ»çš„è¾“å…¥ï¼Œè¿˜å¸Œæœ›å’Œä¹‹å‰æ—¶åˆ»çš„è¾“å‡ºæœ‰å…³ç³»ã€‚**åŠ¨é‡è¿™ä¸ªè¶…å‚æ•°æ˜¯ $0-1$ çš„ä¸€ä¸ªå‚æ•°ï¼›å¦‚æœ $m$ è¶‹è¿‘äº $1$ï¼Œé‚£ä¹ˆ $y_{t}$ çš„æ”¹å˜ä¼šéå¸¸ç¼“æ…¢ï¼Œå› ä¸º $1-m$ è¶‹è¿‘äºé›¶**ã€‚

**Moco å°±æ˜¯åˆ©ç”¨è¿™ä¸ªåŠ¨é‡çš„ç‰¹æ€§ï¼Œå»ç¼“æ…¢åœ°æ›´æ–°ç¼–ç å™¨ï¼Œä»è€Œè®©ä¸­é—´å­¦ä¹ åˆ°çš„å­—å…¸ç‰¹å¾å°½å¯èƒ½ä¿æŒä¸€è‡´**ï¼ˆè¿™å¥è¯æ²¡çœ‹æ‡‚æ²¡å…³ç³»ï¼Œä¸€ä¼šè¯¦ç»†è®²ï¼‰ã€‚

## Abstract

**Moco** æŠŠå¯¹æ¯”å­¦ä¹ çœ‹æˆäº†æ˜¯ä¸€ä¸ªå­—å…¸æŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œæ„å»ºäº†ä¸€ä¸ªåŠ¨æ€çš„å­—å…¸ã€‚è¿™ä¸ªåŠ¨æ€çš„å­—å…¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ä¸€ä¸ªç§»åŠ¨å¹³å‡çš„ç¼–ç å™¨ã€‚

![](MoCo/4.png)

é˜Ÿåˆ—é‡Œçš„æ ·æœ¬ä¸éœ€è¦è¿›è¡Œæ¢¯åº¦å›ä¼ ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¾€é˜Ÿåˆ—é‡Œæ”¾å…¥å¾ˆå¤šè´Ÿæ ·æœ¬ï¼Œä»è€Œè®©å­—å…¸çš„è§„æ¨¡å˜å¾—å¾ˆå¤§ã€‚

ä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨ä¸€ä¸ªç§»åŠ¨å¹³å‡çš„ç¼–ç å™¨å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†è®©å­—å…¸é‡Œçš„ç‰¹å¾å°½å¯èƒ½ä¿æŒä¸€è‡´ã€‚

**åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç°ï¼Œæ‹¥æœ‰ä¸€ä¸ªè§„æ¨¡å¤§ä¸”ç‰¹å¾è¾ƒä¸ºä¸€è‡´çš„å­—å…¸ï¼Œèƒ½è®©æ— ç›‘ç£çš„å¯¹æ¯”å­¦ä¹ å–å¾—å¾ˆå¥½çš„æ•ˆæœ**ã€‚

ä»å®éªŒç»“æœæ¥çœ‹ï¼Œåœ¨ **ImageNet** æ•°æ®é›†ä¸Šï¼Œå¦‚æœé‡‡ç”¨ **çº¿æ€§è¯„ä¼°ï¼ˆLinear Probingï¼‰** è¿›è¡Œæµ‹è¯•ï¼Œ**Moco** å¯ä»¥å–å¾—å’Œä¹‹å‰æœ€ä¼˜çš„æ— ç›‘ç£æ–¹æ³•ç›¸è¿‘ç”šè‡³æ›´å¥½çš„ç»“æœã€‚

> çº¿æ€§è¯„ä¼°æŒ‡çš„æ˜¯ï¼Œå…ˆé¢„è®­ç»ƒå¥½ä¸€ä¸ªéª¨å¹²æ¨¡å‹ï¼Œç„¶åå°†è¿™ä¸ªéª¨å¹²ç½‘ç»œå‚æ•°å†»ç»“ï¼Œåªè®­ç»ƒæœ€åçš„å…¨è¿æ¥å±‚ï¼Œå†æŸ¥çœ‹åœ¨ä¸åŒæ•°æ®é›†ä¸Šçš„è¡¨ç°ç»“æœã€‚è¿™æ ·åšå…¶å®ç±»ä¼¼äºæŠŠéª¨å¹²ç½‘ç»œå½“æˆä¸€ä¸ªç‰¹å¾æå–å™¨ï¼Œä»…ä»å…¶ä¸­æå–ç‰¹å¾ï¼Œè¿™å’Œä½¿ç”¨ **ResNet** ä½œä¸ºç‰¹å¾æå–å™¨çš„æ–¹å¼å·®ä¸å¤šã€‚

**Moco ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿åœ¨äºï¼Œå­¦ä¹ åˆ°çš„ç‰¹å¾åœ¨ä¸‹æ¸¸ä»»åŠ¡ä¸Šå…·æœ‰å¾ˆå¥½çš„è¿ç§»æ€§**ã€‚æˆ‘ä»¬çœ‹é‡æ— ç›‘ç£å­¦ä¹ çš„ä¼˜ç‚¹ï¼Œå°±æ˜¯å®ƒå¯ä»¥ä»å¤§é‡æœªæ ‡æ³¨çš„æ•°æ®ä¸Šå­¦ä¹ åˆ°ç‰¹å¾ï¼Œå¹¶è¿ç§»åˆ°æ ‡æ³¨æ•°æ®è¾ƒå°‘çš„ä»»åŠ¡ä¸Šã€‚

**Moco åœ¨ 7 ä¸ªä¸‹æ¸¸ä»»åŠ¡ï¼ˆå¦‚åˆ†å‰²ã€æ£€æµ‹ç­‰ï¼‰ä¸Šè¶…è¶Šäº†ä¹‹å‰çš„æœ‰ç›‘ç£é¢„è®­ç»ƒæ¨¡å‹**ã€‚

## Introduction

**GPTå’ŒBERTï¼Œå·²ç»è¯æ˜æ— ç›‘ç£å­¦ä¹ åœ¨NLPä»»åŠ¡ä¸Šæ˜¯è¡Œå¾—é€šçš„**ã€‚ä½†æ˜¯åœ¨CVé¢†åŸŸï¼Œæœ‰ç›‘ç£é¢„è®­ç»ƒè¿˜æ˜¯å æ®ä¸»å¯¼åœ°ä½ï¼›

ä¹‹å‰ä¹Ÿæœ‰å¾ˆå¤šä¼˜ç§€çš„æ— ç›‘ç£å·¥ä½œï¼Œä½†æ˜¯è¡¨ç°éƒ½ä¼šæ¯”**æœ‰**ç›‘ç£è¦å·®ï¼Œä½œè€…è®¤ä¸ºè¿™æ˜¯å› ä¸ºCVé¢†åŸŸå’ŒNLPé¢†åŸŸçš„åŸå§‹ä¿¡å·ç©ºé—´ä¸åŒã€‚

å¯¹äº**NLPé¢†åŸŸ**æ¥è¯´ï¼Œå®ƒä»¬æ˜¯ç¦»æ•£çš„ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯åŸå§‹çš„ä¿¡å·ç©ºé—´æ˜¯ç”±å•è¯ç»„æˆï¼Œæˆ–è€…æ›´ç»†ä¸€ç‚¹ï¼Œæ˜¯ç”±å•è¯è¯ç¼€ç»„æˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾ˆ**å®¹æ˜“**åœ°å»å»ºç«‹ä¸€ä¸ªå­—å…¸ï¼Œç„¶åè®©æ¨¡å‹å»å­¦ä¹ ç‰¹å¾ã€‚é‚£ä¹ˆå­—å…¸ä¸­çš„æ¯ä¸ªkeyå°±æ˜¯ä¸€ä¸ªç±»åˆ«ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªç±»åˆ«å»å­¦ä¹ æ¨¡å‹ï¼ˆæ¯”å¦‚BERTæœ€åè¿›è¡Œçš„softmaxæ“ä½œï¼Œä¸å°±æ˜¯åˆ†ç±»æ“ä½œå—ï¼‰

ä½†æ˜¯å¯¹äºCVé¢†åŸŸæ¥è®²ï¼Œæƒ…å†µå®Œå…¨ä¸ä¸€æ ·ã€‚**CVé¢†åŸŸçš„ä¿¡å·æ˜¯åœ¨ä¸€ä¸ªè¿ç»­è€Œä¸”é«˜ç»´çš„ç©ºé—´ï¼Œå®ƒå¹¶ä¸åƒå•è¯é‚£æ ·æœ‰å¾ˆå¼ºçš„è¯­ä¹‰ä¿¡æ¯ï¼Œä¹Ÿæ²¡æœ‰æµ“ç¼©å¾—é‚£ä¹ˆç®€æ´**ï¼›æ‰€ä»¥CVé¢†åŸŸå¹¶ä¸é€‚åˆå»å»ºç«‹ä¸€ä¸ªå­—å…¸æ¥å­¦ä¹ æ¨¡å‹ï¼›å¦‚æœæ²¡æœ‰è¿™ä¸ªå­—å…¸ï¼Œæ— ç›‘ç£å°±å¾ˆéš¾å»å»ºæ¨¡ã€‚å› æ­¤ï¼Œåœ¨CVé¢†åŸŸï¼Œæ— ç›‘ç£å­¦ä¹ çš„è¡¨ç°å¾€å¾€ä¸å¦‚æœ‰ç›‘ç£å­¦ä¹ ã€‚

**åœ¨ä¹‹å‰æœ‰å¾ˆå¤šä¼˜ç§€çš„å¯¹æ¯”å­¦ä¹ å·¥ä½œï¼Œéƒ½å¯ä»¥å½’çº³ä¸ºä¸€ç§å­—å…¸æŸ¥è¯¢çš„å·¥ä½œ**ã€‚

æˆ‘ä»¬æ¥ç€æ¥çœ‹å›¾ï¼š

![](MoCo/5.png)

ä¸¤ä¸ªç¼–ç å™¨ï¼Œä¸€ä¸ªæ˜¯E11ï¼Œä¸€ä¸ªæ˜¯E12ï¼›ç„¶åæˆ‘ä»¬å°†å›¾ç‰‡x1ç»è¿‡æ•°æ®å¢å¼ºT1å¾—åˆ°å›¾ç‰‡X11ï¼Œå†ç»è¿‡E11è¿™ä¸ªç¼–ç å™¨ï¼Œå¾—åˆ°å›¾ç‰‡è¡¨å¾f11ï¼›åŒç†ï¼Œå›¾ç‰‡x1ç»è¿‡æ•°æ®å¢å¼ºT2å¾—åˆ°å›¾ç‰‡x12ï¼Œç„¶åç»è¿‡E12è¿™ä¸ªç¼–ç å™¨ï¼Œå¾—åˆ°è¡¨å¾f12ã€‚

æˆ‘ä»¬æŠŠX11è¿™ä¸ªå›¾ç‰‡å«åš **anchorï¼ˆé”šç‚¹ï¼‰**ï¼Œx12å«åšx11çš„æ­£æ ·æœ¬ã€‚

ä»€ä¹ˆæ˜¯è´Ÿæ ·æœ¬å‘¢ï¼Ÿå°±æ˜¯æ•°æ®é›†ä¸­å‰©ä½™çš„æ‰€æœ‰å›¾ç‰‡éƒ½æ˜¯è´Ÿæ ·æœ¬ã€‚é‚£ä¹ˆè´Ÿæ ·æœ¬èµ°å“ªä¸ªç¼–ç å™¨å‘¢ï¼Ÿèµ°çš„æ˜¯E12è¿™ä¸ªç¼–ç å™¨ï¼Œå› ä¸ºæ­£æ ·æœ¬å’Œè´Ÿæ ·æœ¬éƒ½æ˜¯ç›¸å¯¹äºé”šç‚¹æ¥è¯´çš„ï¼Œæ‰€ä»¥æ­£æ ·æœ¬å’Œè´Ÿæ ·æœ¬è¦èµ°åŒä¸€ä¸ªç¼–ç å™¨ï¼Œä»è€Œè®©ç‰¹å¾çš„è·å–è¿‡ç¨‹ä¿æŒä¸€è‡´æ€§ã€‚äºæ˜¯ï¼Œè´Ÿæ ·æœ¬x2ã€x3ã€x4ç­‰ç­‰ä¹Ÿç»è¿‡E12å¾—åˆ°äº†çœŸæ­£çš„è´Ÿæ ·æœ¬è¡¨å¾f2ã€f3ã€fnã€‚

æˆ‘ä»¬æŠŠf11å«åš **query**ï¼ŒæŠŠf12ã€f2ã€f3ã€fnå«åš **key**ã€‚

**å¯¹æ¯”å­¦ä¹ çš„è¿‡ç¨‹å°±æ˜¯æƒ³è¦åœ¨ç‰¹å¾ç©ºé—´é‡Œï¼Œè®©æ­£æ ·æœ¬çš„keyå’Œqueryè·ç¦»è¿‘ï¼Œå…¶ä½™çš„keyç¦»queryè¿œ**ã€‚

æˆ‘ä»¬å…¶å®å¯ä»¥æŠŠkeyé›†åˆçœ‹æˆå­—å…¸ã€‚é‚£ä¹ˆå¯¹æ¯”å­¦ä¹ çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æƒ³å¾—åˆ°ä¸€ä¸ªæ¨¡å‹ï¼Œè®©queryåœ¨å­—å…¸ä¸­ä¸è‡ªå·±åŒ¹é…çš„æ­£æ ·æœ¬æ›´è¿‘ã€‚

å¦‚æœæŠŠå¯¹æ¯”å­¦ä¹ çš„è¿‡ç¨‹çœ‹æˆä¸€ä¸ªåŠ¨æ€å­—å…¸çš„è¿‡ç¨‹ï¼Œè‹¥æƒ³è¦å¾—åˆ°æ¯”è¾ƒå¥½çš„æ•ˆæœï¼Œé‚£ä¹ˆå­—å…¸æœ€å¥½éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š**ç¬¬ä¸€ä¸ªæ˜¯å­—å…¸è¶³å¤Ÿå¤§ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨è®­ç»ƒçš„æ—¶å€™å°½é‡ä¿æŒä¸€è‡´æ€§**ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨åšå¯¹æ¯”å­¦ä¹ çš„æ—¶å€™ï¼Œæ˜¯ä¸€ä¸ªbatchä¸€ä¸ªbatchåœ°å»åšï¼Œæ‰€ä»¥å¦‚æœkeyè¿™ä¸ªå­—å…¸è¶³å¤Ÿå¤§ï¼Œé‚£ä¹ˆä»ä¸­æŠ½æ ·çš„å¯èƒ½æ€§ç»„åˆå°±å¾ˆå¤šï¼Œæ¨¡å‹çš„æ³›åŒ–æ€§å°±å¾ˆå¼ºã€‚å¦‚æœå­—å…¸å¾ˆå°ï¼Œæ³›åŒ–æ€§å°±ä¸è¶³ï¼Œç›¸å½“äºæ•°æ®é‡ä¸å¤Ÿã€‚

å…¶æ¬¡ï¼Œä¿æŒä¸€è‡´æ€§æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å­—å…¸ä¸­çš„ç‰¹å¾å°½å¯èƒ½ä½¿ç”¨åŒä¸€ä¸ªæˆ–è€…ç›¸è¿‘çš„ç¼–ç å™¨è¿›è¡Œè¡¨å¾ã€‚å› ä¸ºå¦‚æœä¸è¿™æ ·åšï¼Œæ¨¡å‹å¯èƒ½å°±åªä¼šå­¦ä¹ åˆ°å’Œqueryä½¿ç”¨åŒæ ·ç¼–ç å™¨çš„é‚£ä¸ªkeyï¼Œå¯¼è‡´æ¨¡å‹æ³›åŒ–æ€§ä¸è¶³ï¼Œèµ°äº†æ·å¾„ã€‚

**æ‰€ä»¥Mocoè¦åšçš„å°±æ˜¯ï¼šåœ¨å¯¹æ¯”å­¦ä¹ æ¡†æ¶ä¸­ï¼Œæä¾›ä¸€ä¸ªåˆå¤§åˆä¸€è‡´çš„å­—å…¸**ï¼›æ¡†æ¶å›¾å¦‚ä¸‹ï¼š

![](MoCo/4.png)

**å¤§å­—å…¸æ˜¯æ€ä¹ˆåšåˆ°çš„**ï¼šç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒæŠŠæ¯æ¬¡è®­ç»ƒçš„ `batch-size` å’Œé˜Ÿåˆ—å¤§å°åˆ†ç¦»å¼€ï¼›å…·ä½“æ¥è¯´å°±æ˜¯è¿™ä¸ªé˜Ÿåˆ—å¯ä»¥å¾ˆå¤§ï¼Œä½†æ˜¯æˆ‘ä»¬æ¯æ¬¡æ›´æ–°è¿™ä¸ªé˜Ÿåˆ—ï¼Œæ˜¯ä¸€ç‚¹ç‚¹åœ°æ›´æ–°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬ç”¨ä¸€ä¸ªå¾ˆå°çš„ `batchsize` æ—¶ï¼ŒæŠŠå½“å‰ `batch` ä¸­çš„ç‰¹å¾åŠ å…¥é˜Ÿåˆ—ï¼Œå°†æœ€è€çš„ `batch-size` çš„ç‰¹å¾ä»é˜Ÿåˆ—ä¸­æŠ½ç¦»ï¼›è¿™æ ·æˆ‘ä»¬çš„é˜Ÿåˆ—å°±å¯ä»¥è®¾ç½®å¾—å¾ˆå¤§ï¼Œæ¯”å¦‚å‡ ä¸‡ã€‚**é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½¿ç”¨ä¸€ä¸ª GPU ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°è®­ç»ƒæ¨¡å‹**ã€‚

**é‚£ä¹ˆä¸€è‡´æ€§æ˜¯å¦‚ä½•åšåˆ°çš„**ï¼Ÿåˆšæ‰è¯´äº†ï¼Œæ¯æ¬¡éƒ½æ˜¯ä½¿ç”¨æ–°çš„ç¼–ç å™¨æ›´æ–° `batch` å¤§å°çš„é˜Ÿåˆ—ç‰¹å¾ï¼Œé™¤æ­¤ä¹‹å¤–çš„ç‰¹å¾éƒ½æ˜¯ä½¿ç”¨ä¹‹å‰çš„ç¼–ç å™¨å¾—åˆ°çš„ï¼Œè¿™æ ·ä¸å°±ä¸ä¸€è‡´äº†å—ï¼Ÿè¿™æ—¶ä½¿ç”¨åŠ¨é‡æ›´æ–°å³å¯ã€‚æˆ‘ä»¬æœ€å¼€å§‹å³è¾¹åˆ†æ”¯çš„ç¼–ç å™¨æ˜¯ç”±å·¦è¾¹åˆå§‹åŒ–è€Œæ¥ï¼Œåç»­æ›´æ–°æ—¶å¯¹å³è¾¹è¿™ä¸ªç¼–ç å™¨çš„å‚æ•°è¿›è¡ŒåŠ¨é‡æ›´æ–°ï¼Œ**è®© `m` è¶³å¤Ÿå¤§ï¼Œç¡®ä¿å³è¾¹ç¼–ç å™¨æ›´æ–°å¾—éå¸¸ç¼“æ…¢**ï¼Œä»å…¬å¼æ¥è¯´ï¼Œå°±æ˜¯è¿™ä¸ªå›¾ï¼š

![](MoCo/6.png)

å¯ä»¥çœ‹åˆ°ï¼Œå³è¾¹ç¼–ç å™¨ä¼šè¢«ä¹‹å‰çš„ $k$ ç¼–ç ï¼Œå’Œå½“å‰æ—¶åˆ»çš„ $q$ ç¼–ç å½±å“ã€‚**å½“ $m$ è¶³å¤Ÿå¤§ï¼Œæ— é™æ¥è¿‘äº $1$ æ—¶ï¼Œå°±å¯ä»¥è®¤ä¸ºå…¶æ— é™è¢« $k$ æ§åˆ¶ï¼Œæ›´æ–°ä¼šéå¸¸ç¼“æ…¢**ã€‚

**Moco åªæ˜¯å»ºç«‹ä¸­é—´æ¨¡å‹çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒéå¸¸çµæ´»ï¼Œå¯ä»¥å’Œå¾ˆå¤šä»£ç†ä»»åŠ¡ç»“åˆ**ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ä¹‹å‰è®²è¿‡çš„ä¸ªä½“åˆ¤åˆ«ä»»åŠ¡ã€‚

**æ— ç›‘ç£å­¦ä¹ æœ€å¤§çš„ä¸€ä¸ªå–ç‚¹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„æ¨¡å‹åœ¨å¤§é‡æ— æ ‡æ³¨çš„æ•°æ®é›†ä¸Šè¿›è¡Œè®­ç»ƒä¹‹åï¼Œå¾—åˆ°çš„ç‰¹å¾å¯ä»¥å¾ˆå¥½åœ°è¿ç§»åˆ°ä¸‹æ¸¸ä»»åŠ¡ä¸­ï¼ˆæ¯”å¦‚æ ‡æ³¨æ•°æ®å¾ˆå°‘çš„ä»»åŠ¡ï¼‰**ã€‚

## Conclusion

**Moco** è®ºæ–‡åœ¨ **ImageNet** æ•°æ®é›†ä¸Šå–å¾—äº†å¾ˆå¥½çš„ç»“æœï¼Œåœ¨ Facebook è‡ªå®¶çš„æ•°æ®é›†ä¸ŠåŒæ ·æ•ˆæœè‰¯å¥½ï¼Œä½†æå‡å¹…åº¦ä¸å¤§ã€‚å½“æ•°æ®é›†è§„æ¨¡ä» 100 ä¸‡å¢é•¿åˆ° 10 äº¿æ—¶ï¼Œæå‡ä¾ç„¶ä¸æ˜æ˜¾ã€‚ä½œè€…è®¤ä¸ºå¤§è§„æ¨¡æ•°æ®æ²¡æœ‰è¢«å……åˆ†åˆ©ç”¨ï¼Œå¯èƒ½é‡‡ç”¨ä¸€ä¸ªæ›´å¥½çš„ä»£ç†ä»»åŠ¡ä¼šå–å¾—æ›´å¥½çš„æ•ˆæœã€‚æ‰€ä»¥ä½œè€…æå‡ºï¼Œé™¤äº†ä¸ªä½“åˆ¤åˆ«è¿™ä¸ªä»»åŠ¡å¤–ï¼Œæœ‰æ²¡æœ‰å¯èƒ½å°† **MoCo** å’Œ **mask encoded** ä»»åŠ¡ç»“åˆèµ·æ¥ï¼Œä¹Ÿå°±æ˜¯ç±»ä¼¼ **BERT** çš„æ“ä½œï¼Œä½¿ç”¨ **MLMï¼ˆMasked Language Modelingï¼‰** è‡ªç›‘ç£çš„æ–¹å¼è¿›è¡Œå­¦ä¹ ã€‚ï¼ˆè¿™ä¸å°±æ˜¯ **MAE** æ¨¡å‹å—ï¼‰

å¼€å¤´æåˆ°è¿‡ CV å’Œ NLP çš„ä¿¡å·ç©ºé—´ä¸ä¸€è‡´ï¼Œç›´æ¥ç…§æ¬ BERT çš„æ–¹æ³•å¯èƒ½è¡Œä¸é€šï¼Œå…·ä½“å¯å‚è€ƒ **MAE** æ¨¡å‹ã€‚

## Related Work

ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªç›‘ç£å­¦ä¹ çš„æ–¹æ³•å¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢æ¥è¿›è¡Œä¼˜åŒ–æˆ–åˆ›æ–°ï¼š

1. **åœ¨æŸå¤±å‡½æ•°ä¸Šåšæ–‡ç« **ï¼šè®¾è®¡æˆ–æ”¹è¿›å¯¹æ¯”æŸå¤±å‡½æ•°ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°å­¦ä¹ åˆ°æœ‰åˆ¤åˆ«æ€§çš„è¡¨ç¤ºã€‚

2. **åœ¨ä»£ç†ä»»åŠ¡ä¸Šåšæ–‡ç« **ï¼šé€šè¿‡è®¾è®¡åˆç†çš„é¢„è®­ç»ƒä»»åŠ¡ï¼ˆå¦‚å›¾åƒé‡å»ºã€ä¸Šä¸‹æ–‡é¢„æµ‹ç­‰ï¼‰å¼•å¯¼æ¨¡å‹å­¦ä¹ æœ‰ç”¨çš„ç‰¹å¾ã€‚

> ğŸ’¡ æ³¨è§£ï¼šè‡ªç›‘ç£å­¦ä¹ å…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šå½¢å¼çš„æ— ç›‘ç£å­¦ä¹ ï¼Œé€šè¿‡äººä¸ºæ„é€ â€œæ ‡ç­¾â€æ¥è®­ç»ƒæ¨¡å‹ã€‚

æŸå¤±å‡½æ•°:

* **NCEï¼ˆNoise Contrastive Estimationï¼‰æŸå¤±å‡½æ•°**ï¼š

  * æœ€åˆç”¨äºè¯­è¨€æ¨¡å‹ï¼ˆå¦‚word2vecï¼‰ä¸­ï¼Œå®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯æŠŠä¸€ä¸ªâ€œè¶…çº§å¤§çš„å¤šåˆ†ç±»é—®é¢˜â€ï¼ˆå³ä»å¤§é‡å€™é€‰ä¸­é€‰å‡ºæ­£ç¡®æ ·æœ¬ï¼‰è½¬åŒ–ä¸ºä¸€ç³»åˆ—â€œäºŒåˆ†ç±»é—®é¢˜â€ï¼ˆå³åˆ¤æ–­æŸä¸ªæ ·æœ¬æ˜¯å¦æ˜¯æ­£æ ·æœ¬ï¼‰ã€‚
  
  * å› ä¸ºç›´æ¥åœ¨è¶…å¤§ç±»åˆ«ç©ºé—´ä¸Šåš softmax è®¡ç®—ä»£ä»·å¤ªé«˜ï¼Œæ‰€ä»¥ NCE æä¾›äº†ä¸€ç§æ›´å¯è¡Œçš„æ›¿ä»£æ–¹æ³•ã€‚
  
  * ç±»ä¼¼äº word2vec ä¸­çš„ negative sampling æŠ€æœ¯ã€‚

* **InfoNCE**ï¼š

  * æ˜¯ NCE çš„ä¸€ç§æ”¹è¿›æˆ–å˜ä½“ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå¯¹æ¯”å­¦ä¹ ä¸­ï¼ˆå¦‚MoCoã€SimCLRï¼‰ã€‚
  
  * å®ƒçš„ç›®æ ‡æ˜¯åœ¨ä¸€ä¸ªç”±ä¸€ä¸ªæ­£æ ·æœ¬å’Œå¤šä¸ªè´Ÿæ ·æœ¬æ„æˆçš„é›†åˆä¸­ï¼Œæœ€å¤§åŒ–æ­£æ ·æœ¬çš„å¾—åˆ†ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤ŸåŒºåˆ†æ­£è´Ÿæ ·æœ¬å¯¹ã€‚

---

æ¸©åº¦ç³»æ•°ï¼ˆtemperature hyperparameterï¼‰ï¼š

åœ¨ InfoNCE çš„ softmax å‡½æ•°ä¸­ï¼Œé€šå¸¸ä¼šåŠ å…¥ä¸€ä¸ª **æ¸©åº¦è¶…å‚æ•° $\tau$**ï¼Œç”¨äºè°ƒèŠ‚ logitsï¼ˆç›¸ä¼¼åº¦ï¼‰çš„â€œå°–é”ç¨‹åº¦â€ï¼š

* $\tau$ è¶Šå°ï¼Œsoftmax è¶Šå°–é”ï¼Œæ¨¡å‹å¯¹æ­£è´Ÿæ ·æœ¬å·®å¼‚æ›´åŠ æ•æ„Ÿï¼›

* $\tau$ è¶Šå¤§ï¼Œsoftmax è¶‹äºå¹³æ»‘ï¼Œè®­ç»ƒæ›´ç¨³å®šä½†åŒºåˆ†åº¦ä¸‹é™ã€‚

åœ¨çœ‹ **InfoNCE** çš„æŸå¤±å‡½æ•°çš„æ—¶å€™ï¼Œé¦–å…ˆä» **softmax** çœ‹èµ·ï¼Œè¿™ä¸ªæ˜¯softmaxçš„å…¬å¼:

![](MoCo/7.png)


ç„¶åæˆ‘ä»¬åŠ ä¸€ä¸ª $-log$ å°±æ˜¯ **äº¤å‰ç†µæŸå¤±å‡½æ•°**ï¼š

![](MoCo/8.png)

è¿™ä¸ªå…¬å¼å…¶å®å¯ä»¥ç›´æ¥ç”¨åœ¨å¯¹æ¯”å­¦ä¹ ä¸­ã€‚

ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ äº¤å‰ç†µæ˜¯ä¸€ä¸ªå¤šåˆ†ç±»é—®é¢˜çš„æŸå¤±å‡½æ•°ï¼Œä¸€ä¸ªone-hotå‘é‡ï¼Œå’Œæˆ‘çœŸå®è¾“å‡ºåšä¸€ä¸ªæŸå¤±ï¼Œç›®æ ‡æ˜¯ä¸ºäº†è®©çœŸæ­£æ ‡ç­¾çš„è¾“å‡ºå°½å¯èƒ½çš„å¤§ã€‚

é‚£ä¹ˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæŠŠè¿™ä¸ªæŸå¤±å‡½æ•°ï¼Œç›´æ¥å¥—åˆ°å¯¹æ¯”å­¦ä¹ ä¸­å»ï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ

æ¯”å¦‚ **ImageNet** 100ä¸‡ä¸ªå›¾ç‰‡ï¼Œé‚£ä¹ˆæˆ‘å½“å‰å›¾ç‰‡ç»è¿‡æ•°æ®å¢å¼ºä¹‹åï¼Œç»è¿‡ç¼–ç å™¨1å¾—åˆ°äº† **é”šç‚¹ç‰¹å¾**ï¼Œç»è¿‡ç¼–ç å™¨2å¾—åˆ°äº†æ­£æ ·æœ¬ï¼Œä¹Ÿå°±æ˜¯æˆ‘çš„ **ground-truth**ï¼›

é‚£ä¹ˆé™¤äº†æˆ‘å½“å‰è¿™ä¸ªå›¾ç‰‡å¤–ï¼Œå…¶ä½™100ä¸‡ - 1ä¸ªå›¾ç‰‡ç»è¿‡ç¼–ç å™¨2å¾—åˆ°çš„è¡¨å¾éƒ½æ˜¯è´Ÿæ ·æœ¬ï¼Œä¹Ÿå°±æ˜¯ä¼šå¾—åˆ°è¿™æ ·ä¸€ä¸ªå‘é‡ï¼š

```bash
1 0 0 0 ï¼ˆ1ä¸ª1 ,  100ä¸‡ - 1ä¸ª0ï¼‰
```

åœ¨è¿™ä¸ªå‘é‡ä¸Šåšäº¤å‰ç†µï¼Œå…¶å®å°±å¯ä»¥ç”¨åœ¨å¯¹æ¯”å­¦ä¹ ä¸Šã€‚

ä½†æ˜¯è¿™æ ·åš **softmax** è®¡ç®—é‡å¤ªå¤§äº†ï¼Œåƒ **BERT** è¿™ç§æ¨¡å‹ï¼Œä¹Ÿå°±å‡ ä¸‡ä¸ªç±»åˆ«ï¼Œå¤„ç†èµ·æ¥æ²¡å•¥é—®é¢˜ï¼Œå‡ ç™¾ä¸‡ä¸ªç±»åˆ«å°±å¤ªéš¾äº†ã€‚

è¿™ä¸ªæ—¶å€™ **NCEï¼ˆNoise Contrastive Estimationï¼‰** å°±æ˜¯ä¸€ç§å¾ˆå¥½çš„è§£å†³æ–¹å¼ï¼Œå°†é—®é¢˜è½¬åŒ–ä¸ºä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨åªæœ‰ä¸¤ä¸ªç±»åˆ«ï¼Œä¸€ä¸ªæ˜¯æ­£å¸¸æ ·æœ¬ï¼Œé™¤æ­¤ä¹‹å¤–çš„éƒ½æ˜¯å™ªå£°æ ·æœ¬ã€‚

ä½†æ˜¯è¿™æ ·åšçš„é€»è¾‘ä¸å¤ªæ¸…æ™°ï¼Œæ‰€ä»¥ **InfoNCE** å°±åº”è¿è€Œç”Ÿäº†ã€‚

ä¸å…¶åœ¨æ•´ä¸ªæ•°æ®é›†ä¸Šè®¡ç®—æŸå¤±ï¼Œä¸å¦‚æŠ½æ ·ä¸€éƒ¨åˆ†æ•°æ®æ¥è®¡ç®—æŸå¤±ã€‚å¦‚æœé€‰å–çš„æŠ½æ ·éƒ¨åˆ†è¿‡å°‘ï¼Œå°±æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæ— æ³•æ¨¡æ‹Ÿæ•´ä¸ªæ•°æ®é›†ï¼Œæ‰€ä»¥æŠ½æ ·çš„éƒ¨åˆ†è¿˜æ˜¯è¦å¤§ä¸€ç‚¹ã€‚æ­¤æ—¶ï¼Œ**å­—å…¸çš„å¤§å°å°±å¾ˆé‡è¦**ï¼Œä¹Ÿå°±æ˜¯å­—å…¸çš„å¤§å°å°±æ˜¯åˆ†æ¯ä¸‹æ–¹çš„ç±»åˆ«æ•°é‡ï¼›åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ**InfoNCE** æŠŠ **NCE** çš„ä¸€ç³»åˆ—äºŒåˆ†ç±»é—®é¢˜åˆè½¬ä¸ºäº†å¤šåˆ†ç±»é—®é¢˜ã€‚

![](MoCo/9.png)

**$q$** å°±æ˜¯æˆ‘ä»¬çš„ **query** è¡¨å¾ï¼Œä¹Ÿå°±æ˜¯ **é”šç‚¹** é‚£ä¸ªå›¾ç‰‡çš„ç‰¹å¾ï¼Œ**$k^+$** å°±æ˜¯æ­£æ ·æœ¬ï¼Œåˆ†æ¯ç´¯åŠ é‚£é‡Œçš„ **$K$**ï¼Œå°±æ˜¯æˆ‘ä»¬çš„è´Ÿæ ·æœ¬æ•°é‡ï¼Œåˆ†ç±»ç´¯åŠ äº† **$K + 1$** é¡¹ï¼Œå› ä¸ºæœ‰ $K$ ä¸ªè´Ÿæ ·æœ¬å’Œä¸€ä¸ªæ­£æ ·æœ¬ã€‚

æ¸©åº¦å‚æ•° **$\tau$**ï¼ˆå¸Œè…Šå­—æ¯è¯»éŸ³ä¸º "tao"ï¼‰ï¼Œåœ¨è’¸é¦ç›¸å…³å†…å®¹é‡Œå…¶å®æåˆ°è¿‡ï¼Œå¦‚æœ **$\tau$** å¾ˆå¤§ï¼Œé‚£ä¹ˆ softmax åˆ†å¸ƒä¼šå¾ˆå¹³æ»‘ï¼Œçœ‹ä¸å‡ºåŒºåˆ«ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰çš„è´Ÿæ ·æœ¬ä¸€è§†åŒä»ï¼Œå¯¼è‡´æ¨¡å‹å­¦ä¹ æ²¡æœ‰è½»é‡ï¼›å¦‚æœ **$\tau$** å¾ˆå°ï¼Œåˆ†å¸ƒä¼šæ›´å°–é”ï¼Œä¼šè®©æ¨¡å‹åªå…³æ³¨é‚£ä¸ªå›°éš¾çš„è´Ÿæ ·æœ¬ï¼Œå…¶å®é‚£äº›è´Ÿæ ·æœ¬å¾ˆæœ‰å¯èƒ½æ˜¯æ½œåœ¨çš„æ­£æ ·æœ¬ï¼Œå¦‚æœæ¨¡å‹è¿‡åº¦å…³æ³¨è¿™ä¸ªå›°éš¾çš„è´Ÿæ ·æœ¬ï¼Œä¼šå¯¼è‡´æ¨¡å‹å¾ˆéš¾æ”¶æ•›ï¼Œæˆ–è€… **å­¦ä¹ ** åˆ°çš„ç‰¹å¾ä¸å¤ªå¥½æ³›åŒ–ã€‚

å»é™¤è¿™ä¸ªæ¸©åº¦è¶…å‚æ•°ï¼Œ**InfoNCE** æœ¬è´¨å°±æ˜¯ä¸€ä¸ªäº¤å‰ç†µæŸå¤±å‡½æ•°ï¼Œåªä¸è¿‡ç±»åˆ«å’Œæ‰€æœ‰æ ·æœ¬ç›¸æ¯”ï¼Œåšäº†ä¸ªè¿‘ä¼¼ï¼Œè¿›è¡Œäº†ä¸€æ¬¡éšæœºæŠ½æ ·ï¼ŒæŠ½æ ·æ•°é‡å°±æ˜¯å­—å…¸å¤§å°ã€‚**Moco** ä¼ªä»£ç é‡Œçš„ **InfoNCE** ç›´æ¥ä½¿ç”¨çš„å°±æ˜¯äº¤å‰ç†µæŸå¤±å‡½æ•°ä»£ç ã€‚

### Detail

æœ‰ä¸ªç»†èŠ‚ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨é˜Ÿåˆ—è¿™ç§æ•°æ®ç»“æ„å­˜å‚¨å­—å…¸å‘¢ï¼Ÿ

å› ä¸ºå…ˆè¿›å…ˆå‡ºï¼Œæ¯æ¬¡ä¸€ä¸ª `batch` è¿›æ¥ï¼Œæœ€è€çš„é‚£ä¸ªéƒ¨åˆ† `batch` æ•°æ®ä¼šå‡ºå»ï¼Œè¿™éƒ¨åˆ†æ•°æ®æ˜¯è¿‡æ—¶çš„ï¼Œä»è€Œèƒ½å¤Ÿä¿æŒé˜Ÿåˆ—ä¸­çš„ç‰¹å¾å°½å¯èƒ½çš„ **ä¸€è‡´æ€§**ã€‚

å¦ä¸€ä¸ªç»†èŠ‚ï¼š

ç¬¬äºŒä¸ªåˆ†æ”¯ä¸èƒ½éšç€èµ°è¿™ä¸€æ”¯çš„æ ·æœ¬ä½¿ç”¨æ¢¯åº¦å›ä¼ è¿›è¡Œæ›´æ–°ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå¦‚æœè¿™æ ·åšäº†ï¼Œç¬¬äºŒä¸ªåˆ†æ”¯çš„ç¼–ç å™¨å°±æ›´æ–°å¾—å¤ªå¿«äº†ï¼Œè¿™äº›ç‰¹å¾ï¼Œæˆ‘ä»¬æ˜¯æ”¾åˆ°å­—å…¸ä¸­å»çš„ï¼Œå°±ä¼šå¯¼è‡´ç‰¹å¾ **ä¸ä¸€è‡´**ã€‚

ä¸ºä»€ä¹ˆç¬¬äºŒä¸ªåˆ†æ”¯ä¸ç›´æ¥ä¸æ›´æ–°ï¼Œè€Œæ˜¯é‡‡ç”¨ç¼“æ…¢æ›´æ–°å‘¢ï¼Ÿï¼ˆæˆ‘è‡ªå·±ç†è§£ï¼Œå¦‚æœç¬¬äºŒä¸ªåˆ†æ”¯ä¸€ç›´ä¸å˜ï¼Œç”±äºæ­£æ ·æœ¬çš„å®šä¹‰è§„åˆ™æ˜¯ç»è¿‡ç¼–ç å™¨ä¹‹åæ‰€åœ¨çš„è¯­ä¹‰ç©ºé—´æ‰ä¸ºæ­£æ ·æœ¬ã€‚åœ¨æ¨¡å‹è®­ç»ƒæ—¶å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸ºåˆ°åæ¥ç¬¬ä¸€ä¸ªåˆ†æ”¯å’Œç¬¬äºŒä¸ªåˆ†æ”¯ç¼–ç å™¨å·®è·è¶Šæ¥è¶Šå¤§ï¼ŒåŸæœ¬æ˜¯æ­£æ ·æœ¬çš„ï¼ŒæŸå¤±ä¹Ÿä¼šå¾ˆå¤§ï¼Œå¯¼è‡´æ¨¡å‹å¾ˆéš¾è®­ç»ƒã€‚ï¼‰

**ä¸¤ä¸ªè´¡çŒ®**ï¼š

- **ä¸€ä¸ªæ˜¯æ„å»ºå¾ˆå¤§çš„å­—å…¸**ï¼šè®¡ç®—æŸå¤±çš„æ—¶å€™ä½¿ç”¨å¤šåˆ†ç±»ï¼Œèƒ½å¤Ÿå¾ˆè¿‘ä¼¼åœ¨æ•´ä¸ªæ•°æ®é›†ä¸Šåšçš„å¤šåˆ†ç±»æŸå¤±ã€‚

- **ä¸€ä¸ªæ˜¯ä¿è¯å­—å…¸å†…ç‰¹å¾ä¸€è‡´æ€§**ï¼Œä½¿ç”¨åŠ¨é‡æ›´æ–°ã€‚

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹ï¼šå°±æ˜¯ **InfoNCE** æŸå¤±è®¡ç®—çš„æ˜¯æ•´ä¸ªå­—å…¸åšå¤šåˆ†ç±»ã€‚`minibatch` å¤§å°å’Œå­—å…¸å¤§å°å‰¥ç¦»å¼€ï¼Œ`batch` å¯ä»¥è®¾ç½®ä¸º 256ï¼Œç„¶åè¿›æ¥ 256 ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬éƒ½éœ€è¦åšä¸€ä¸ª **é”šç‚¹**ï¼Œèµ°ä¸€éå¯¹æ¯”å­¦ä¹ çš„æµç¨‹ã€‚

åŠ¨é‡è®¾ç½®ä¸ºäº† 0.99ï¼Œè¿™ä¸ªå€¼ **å¾ˆå¤§** äº†ã€‚å­—å…¸å¤§å°æ˜¯ 65536ã€‚

åœ¨ Moco ä¹‹å‰çš„å·¥ä½œä¸­ï¼Œ å­—å…¸å¤§å°å’Œå­—å…¸ç‰¹å¾ä¸€è‡´æ€§ç»å¸¸ä¸èƒ½åŒæ—¶æ»¡è¶³ã€‚

### Preview Work

**ç«¯åˆ°ç«¯çš„æ¡†æ¶**ï¼š

![](MoCo/10.png)

**ç«¯åˆ°ç«¯çš„æ¡†æ¶** å°±æ˜¯ä¸¤ä¸ªç¼–ç å™¨éƒ½å¯ä»¥é€šè¿‡æ¢¯åº¦å›ä¼ è¿›è¡Œæ›´æ–°ï¼Œå› ä¸º $x_{q}$ å’Œ $x_{k}$ éƒ½æ˜¯ä»åŒä¸€ä¸ª batch ä¸­æ¥çš„ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€æ¬¡ forward å°±å¯ä»¥æ‹¿åˆ°æ‰€æœ‰æ ·æœ¬çš„ç‰¹å¾ï¼Œæˆ‘ä»¬ç›´æ¥æ¢¯åº¦å›ä¼ å°±å¯ä»¥äº†ã€‚è¿™è¦æ±‚ **batch å¤§å°è¦è¶³å¤Ÿçš„å¤§**ï¼Œé‚£ä¹ˆ **InfoNCE** æ‰èƒ½èµ·ä½œç”¨ï¼Œåšåˆ°ä¸€ä¸ªè¿‘ä¼¼çš„å…¨éƒ¨æ•°æ®é›†çš„å¤šåˆ†ç±»ã€‚**SIMCLR** å°±æ˜¯è¿™ä¸ªç«¯åˆ°ç«¯çš„æ¡†æ¶ã€‚è¿™æ ·å­—å…¸æ˜¯é«˜åº¦ä¸€è‡´çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œbatch å¤§å°å’Œå­—å…¸å¤§å°æ˜¯ç­‰ä»·çš„ã€‚**SIMCLR** å°±æ˜¯ç”¨äº† 8192 ä½œä¸º batch å¤§å°ã€‚

å¦ä¸€æµæ´¾ï¼Œæ›´å…³æ³¨ **å­—å…¸çš„å¤§**ï¼Œç„¶åç‰ºç‰²ä¸€äº›ä¸€è‡´æ€§ï¼Œå°±æ˜¯ **memory bank**ï¼›åœ¨è¿™ä¸ªæµæ´¾åªæœ‰ä¸€ä¸ªç¼–ç å™¨ï¼Œå°±æ˜¯ query çš„ç¼–ç å™¨ï¼Œå¯ä»¥è¿›è¡Œæ¢¯åº¦å›ä¼ è¿›è¡Œæ›´æ–°ã€‚å¯¹äº key è¿™è¾¹ï¼Œæ˜¯æ²¡æœ‰ä¸€ä¸ªå•ç‹¬çš„ç¼–ç å™¨ã€‚

**memory bank** å°±æ˜¯æŠŠæ•´ä¸ªæ•°æ®é›†çš„ç‰¹å¾ï¼Œéƒ½å­˜åˆ°äº†ä¸€èµ·ã€‚å¯¹äº **ImageNet** æ¥è¯´ï¼Œè¿™é‡Œå°±æ˜¯ 128 ä¸‡ä¸ªç‰¹å¾ï¼ˆä½œè€…è¯´åˆ°ï¼Œæ¯ä¸ªç‰¹å¾ 128 ç»´åº¦ï¼Œåªéœ€è¦ 600M çš„ç©ºé—´ï¼Œè¿˜å¥½ã€‚ï¼‰

ç„¶åæ¯æ¬¡è®­ç»ƒçš„æ—¶å€™ï¼Œä» **memory bank** ä¸­éšæœºæŠ½æ ·å­—å…¸å¤§å°å°±å¯ä»¥äº†ã€‚å³è¾¹çš„ç¼–ç æ˜¯åœ¨çº¿ä¸‹æ‰§è¡Œã€‚

åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæ¯”å¦‚å­—å…¸å¤§å°æ˜¯ 3ï¼Œé‚£ä¹ˆæŠ½å‡ºä¸‰ä¸ªæ¥ï¼Œå·¦è¾¹åšä¸€æ¬¡æ¢¯åº¦å›ä¼ ä¹‹åï¼Œæˆ‘ä»¬æŠŠå­—å…¸ä¸­çš„ 3 ä¸ªç”¨æ–°çš„ç¼–ç å™¨åšä¸€ä¸ªç¼–ç ï¼Œæ”¾å›åˆ° **memory bank** ä¸­å»ã€‚

ï¼ˆé¦–å…ˆï¼Œæˆ‘è®¤ä¸ºä¸ºäº†ä¿æŒæ­£æ ·æœ¬çš„å®šä¹‰ï¼Œè‚¯å®šå¾—æ›´æ–°æ ·æœ¬ç‰¹å¾ï¼‰

å› ä¸ºä½ è¿™ä¸ªæ›´æ–°æ“ä½œï¼Œå¯¼è‡´å­—å…¸å†…ç¼–ç ç‰¹å¾ä¸ä¸€è‡´ã€‚

![](MoCo/11.png)

## Code Implementation

### Train Code

MoCo è®­ç»ƒä»£ç å¦‚ä¸‹æ‰€ç¤º:

```python
def main_worker(args):
    # 1. init MoCo Model
    model = deeplearning.cross_image_ssl.moco.builder.MoCo(
        models.__dict__[args.arch],
        args.moco_dim, 
        args.moco_k,
        args.moco_m,
        args.moco_t,
        args.mlp,
    )

    # 2. define loss function (criterion) and optimizer
    criterion = nn.CrossEntropyLoss().cuda(args.gpu)

    optimizer = torch.optim.SGD(
        model.parameters(),
        args.lr,
        momentum=args.momentum,
        weight_decay=args.weight_decay,
    )

    # 3. Data loading code
    normalize = transforms.Normalize(
        mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]
    )

    augmentation = [
            transforms.RandomResizedCrop(224, scale=(0.2, 1.0)),
            transforms.RandomGrayscale(p=0.2),
            transforms.ColorJitter(0.4, 0.4, 0.4, 0.4),
            transforms.RandomHorizontalFlip(),
            transforms.ToTensor(),
            normalize,
    ]

    train_dataset = datasets.ImageFolder(
        traindir,
        deeplearning.cross_image_ssl.moco.loader.TwoCropsTransform(
            transforms.Compose(augmentation)
        ),
    )

    train_loader = torch.utils.data.DataLoader(
        train_dataset,
        batch_size=args.batch_size,
        shuffle=(train_sampler is None),
        num_workers=args.workers,
        pin_memory=True,
        sampler=train_sampler,
        drop_last=True,
    )

    for epoch in range(args.start_epoch, args.epochs):
        # 4. train for one epoch
        train(train_loader, model, criterion, optimizer, epoch, args)
```
è¿™é‡Œçš„é‡ç‚¹æ˜¯ `TwoCropsTransform` è¿™ä¸ªå¢å¼ºæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯¹ä¸€ä¸ªæ ·æœ¬è¿›è¡Œä¸¤æ¬¡å¢å¼ºï¼Œå¾—åˆ°ä¸¤ä¸ªæ ·æœ¬ã€‚

```python
class TwoCropsTransform:
    """Take two random crops of one image as the query and key."""

    def __init__(self, base_transform) -> None:
        self.base_transform = base_transform

    def __call__(self, x):
        q = self.base_transform(x)
        k = self.base_transform(x)
        return [q, k]
```
æ­¤æ—¶ `train_loader` è¿”å›çš„æ¯ä¸ª `batch` ç»´åº¦ä¸º: `[2, batch_size, C, H, W]` , å…¶ä¸­ `batch[0]` ä»£è¡¨ `query` , `batch[1]` ä»£è¡¨ `positive key`ã€‚

```python
def train(train_loader, model, criterion, optimizer, epoch, args) -> None:
    for i, (images, _) in enumerate(train_loader):
        # 1. compute output
        output, target = model(im_q=images[0], im_k=images[1])
        loss = criterion(output, target)

        # 2. compute gradient and do SGD step
        optimizer.zero_grad()
        loss.backward()
        optimizer.step()
```
### Model Implementation

#### Model Init

æ¨¡å‹åˆå§‹åŒ–ä»£ç å¦‚ä¸‹æ‰€ç¤º:

```python
class MoCo(nn.Module):

    def __init__(
        self,
        base_encoder, # ResNet æ¨¡å‹
        dim: int = 128,
        K: int = 65536, # é˜Ÿåˆ—å¤§å°/å­—å…¸å¤§å°/è´Ÿæ ·æœ¬æ•°é‡
        m: float = 0.999, # åŠ¨é‡æ›´æ–°å‚æ•°
        T: float = 0.07, # æ¸©åº¦å‚æ•°
        mlp: bool = False,
    ) -> None:
        """
        dim: feature dimension (default: 128)
        K: queue size; number of negative keys (default: 65536)
        m: moco momentum of updating key encoder (default: 0.999)
        T: softmax temperature (default: 0.07)
        """
        super(MoCo, self).__init__()

        self.K = K
        self.m = m
        self.T = T

        # 1. create the encoders: num_classes is the output fc dimension
        self.encoder_q = base_encoder(num_classes=dim)
        self.encoder_k = base_encoder(num_classes=dim)
        
        # 2. key encoderå‚æ•°ä½¿ç”¨query encoderè¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒæ—¶key encoderä¸å‚ä¸æ¢¯åº¦è¿ç®—
        for param_q, param_k in zip(
            self.encoder_q.parameters(), self.encoder_k.parameters()
        ):
            param_k.data.copy_(param_q.data)  # initialize
            param_k.requires_grad = False  # not update by gradient

        # 3. create the queue/dictionary and pointer
        self.register_buffer("queue", torch.randn(dim, K))
        self.queue = nn.functional.normalize(self.queue, dim=0)
         
        self.register_buffer("queue_ptr", torch.zeros(1, dtype=torch.long)) # é˜Ÿåˆ—æŒ‡é’ˆï¼Œè´Ÿè´£å®Œæˆå‡ºé˜Ÿå…¥é˜Ÿçš„ä¿¡æ¯è®°å½•
```
####  Model Forward

æ¨¡å‹å‰å‘ä¼ æ’­ä»£ç å¦‚ä¸‹æ‰€ç¤º:
```python
    def forward(self, im_q, im_k):
        """
        Input:
            im_q: a batch of query images
            im_k: a batch of key images
        Output:
            logits, targets
        """

        # 1. compute query features
        q = self.encoder_q(im_q)  # queries: NxC
        q = nn.functional.normalize(q, dim=1)

        # 2. compute key features
        with torch.no_grad():  # no gradient to keys
            self._momentum_update_key_encoder()  # update the key encoder

            # shuffle for making use of BN
            im_k, idx_unshuffle = self._batch_shuffle_ddp(im_k)

            k = self.encoder_k(im_k)  # keys: NxC
            k = nn.functional.normalize(k, dim=1)

            # undo shuffle
            k = self._batch_unshuffle_ddp(k, idx_unshuffle)

        # 3. compute logits
        # Einstein sum is more intuitive
        # positive logits: Nx1
        l_pos = torch.einsum("nc,nc->n", [q, k]).unsqueeze(-1)
        # negative logits: NxK
        l_neg = torch.einsum("nc,ck->nk", [q, self.queue.clone().detach()])

        # 4. logits: Nx(1+K)
        logits = torch.cat([l_pos, l_neg], dim=1)

        # 5. apply temperature
        logits /= self.T

        # 6. labels: positive key indicators
        labels = torch.zeros(logits.shape[0], dtype=torch.long).cuda()

        # 7. dequeue and enqueue
        self._dequeue_and_enqueue(k)

        return logits, labels
```
è®ºæ–‡é‡‡ç”¨ `ResNet` ä½œä¸ºç¼–ç å™¨ï¼Œå…¶æœ€åçš„å…¨è¿æ¥å±‚ï¼ˆåœ¨å…¨å±€å¹³å‡æ± åŒ–ä¹‹åï¼‰è¾“å‡ºä¸€ä¸ªå›ºå®šç»´åº¦çš„å‘é‡ï¼ˆ128 ç»´ï¼‰ã€‚è¿™ä¸ªè¾“å‡ºå‘é‡ä¼šé€šè¿‡å…¶ L2 èŒƒæ•°è¿›è¡Œå½’ä¸€åŒ–ã€‚è¯¥å‘é‡å³è¡¨ç¤ºä¸€ä¸ª `query`ï¼ˆæŸ¥è¯¢å‘é‡ï¼‰ æˆ– `key`ï¼ˆé”®å‘é‡ï¼‰ çš„ç‰¹å¾è¡¨ç¤ºã€‚

#### Momentum Update

é‡‡ç”¨åŠ¨é‡æ›´æ–°æ–¹å¼å¯¹ `key encoder` è¿›è¡Œç¼“æ…¢æ›´æ–°çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤º:

```python
    @torch.no_grad()
    def _momentum_update_key_encoder(self) -> None:
        """
        Momentum update of the key encoder
        """
        for param_q, param_k in zip(
            self.encoder_q.parameters(), self.encoder_k.parameters()
        ):
            param_k.data = param_k.data * self.m + param_q.data * (1.0 - self.m)
```
#### Dequeue and Enqueue

ç»´æŠ¤é˜Ÿåˆ—çŠ¶æ€çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```python
    @torch.no_grad()
    def _dequeue_and_enqueue(self, keys) -> None:
        # 1. gather keys before updating queue
        keys = concat_all_gather(keys) # å¦‚æœä½ åœ¨å¤š GPU ä¸Šè®­ç»ƒï¼Œæ¯ä¸ª GPU éƒ½ä¼šå¤„ç†ä¸€éƒ¨åˆ† batchï¼Œè¯¥æ–¹æ³•ä¼šå°†æ‰€æœ‰ GPU ä¸Šçš„ key å‘é‡åˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„ batch

        batch_size = keys.shape[0]
         
        ptr = int(self.queue_ptr)
        assert self.K % batch_size == 0  # for simplicity

        # 2. replace the keys at ptr (dequeue and enqueue)
        self.queue[:, ptr : ptr + batch_size] = keys.T # queue çš„å½¢çŠ¶æ˜¯ (C, K)ï¼Œæ¯åˆ—æ˜¯ä¸€ä¸ª key å‘é‡ï¼ˆtranspose å­˜å‚¨æ˜¯ä¸ºäº†å¿«é€ŸçŸ©é˜µä¹˜ï¼‰
        ptr = (ptr + batch_size) % self.K  # move pointer

        self.queue_ptr[0] = ptr
```