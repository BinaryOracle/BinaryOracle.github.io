---
title: Attentionè¿ç®—è¿‡ç¨‹ä¸­ç»´åº¦å˜æ¢çš„ç†è§£
icon: file
category:
  - å¼€æºé¡¹ç›®
tag:
  - å·²å‘å¸ƒ
footer: æŠ€æœ¯å…±å»ºï¼ŒçŸ¥è¯†å…±äº«
date: 2025-06-10
author:
  - BinaryOracle
---

`Attentionè¿ç®—è¿‡ç¨‹ä¸­ç»´åº¦å˜æ¢çš„ç†è§£` 

<!-- more -->

# Attentionè¿ç®—è¿‡ç¨‹ä¸­ç»´åº¦å˜æ¢çš„ç†è§£

åœ¨æ³¨æ„åŠ›æœºåˆ¶ï¼ˆç‰¹åˆ«æ˜¯ **Transformer** ä¸­çš„ **è‡ªæ³¨æ„åŠ›æœºåˆ¶**ï¼‰ä¸­ï¼Œ**Qï¼ˆQueryï¼‰ã€Kï¼ˆKeyï¼‰ã€Vï¼ˆValueï¼‰** çš„ç»´åº¦å¯¹æœ€ç»ˆæ³¨æ„åŠ›è¾“å‡ºçš„ç»“æœç»´åº¦æœ‰ç›´æ¥å½±å“ã€‚æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥åˆ†æè¿™ä¸ªè¿‡ç¨‹ï¼š

## ä¸€ã€æ³¨æ„åŠ›æœºåˆ¶çš„åŸºæœ¬æµç¨‹

åœ¨æ ‡å‡†çš„ **ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›ï¼ˆScaled Dot-Product Attentionï¼‰** ä¸­ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

$$
\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V
$$

å…¶ä¸­ï¼š
- $Q \in \mathbb{R}^{n \times d_k}$
- $K \in \mathbb{R}^{m \times d_k}$
- $V \in \mathbb{R}^{m \times d_v}$

> - $n$ï¼šqueryçš„æ•°é‡ï¼ˆå¦‚å¥å­é•¿åº¦ï¼‰
> - $m$ï¼škey/valueçš„æ•°é‡ï¼ˆä¹Ÿé€šå¸¸æ˜¯å¥å­é•¿åº¦ï¼‰
> - $d_k$ï¼šæ¯ä¸ª query å’Œ key çš„ç»´åº¦
> - $d_v$ï¼šæ¯ä¸ª value çš„ç»´åº¦



## äºŒã€Qã€Kã€V çš„åˆå§‹ç»´åº¦å¯¹ç»“æœçš„å½±å“

### 1. **Q Ã— K^T çš„ç»´åº¦**

è¿™æ˜¯æ³¨æ„åŠ›æƒé‡çŸ©é˜µçš„æ¥æºã€‚

- $Q \in \mathbb{R}^{n \times d_k}$
- $K^T \in \mathbb{R}^{d_k \times m}$
- æ‰€ä»¥$QK^T \in \mathbb{R}^{n \times m}$

ğŸ‘‰ è¿™ä¸ªçŸ©é˜µè¡¨ç¤ºçš„æ˜¯æ¯ä¸ª query å¯¹åº”æ‰€æœ‰ key çš„ç›¸ä¼¼åº¦ï¼ˆå³æ³¨æ„åŠ›å¾—åˆ†ï¼‰ï¼Œå…±$n \times m$ä¸ªå€¼ã€‚



### 2. **Softmax æ“ä½œ**

å¯¹æ¯ä¸€è¡Œåš softmaxï¼Œå¾—åˆ°å½’ä¸€åŒ–çš„æ³¨æ„åŠ›æƒé‡ï¼š

- è¾“å…¥ï¼š$n \times m$
- è¾“å‡ºï¼šä»æ˜¯$n \times m$



### 3. **ä¸ V ç›¸ä¹˜**

- æ³¨æ„åŠ›æƒé‡ï¼š$A \in \mathbb{R}^{n \times m}$
- Value çŸ©é˜µï¼š$V \in \mathbb{R}^{m \times d_v}$
- ç»“æœï¼š$AV \in \mathbb{R}^{n \times d_v}$

ğŸ‘‰ æœ€ç»ˆè¾“å‡ºçš„ç»´åº¦æ˜¯$n \times d_v$ï¼Œä¹Ÿå°±æ˜¯å’Œè¾“å…¥çš„ query æ•°é‡ä¸€è‡´ï¼Œä½†æ¯ä¸ªè¾“å‡ºå‘é‡çš„ç»´åº¦ç”± value çš„ç»´åº¦å†³å®šã€‚



## ä¸‰ã€æ€»ç»“ï¼šè¾“å…¥ç»´åº¦ â†’ è¾“å‡ºç»´åº¦

| è¾“å…¥ | ç»´åº¦ | å«ä¹‰ |
| --- | --- | --- |
| Query (Q) | $n \times d_k$ | æŸ¥è¯¢å‘é‡ï¼Œn æ˜¯åºåˆ—é•¿åº¦ |
| Key (K) | $m \times d_k$ | é”®å‘é‡ï¼Œç”¨äºåŒ¹é…æŸ¥è¯¢ |
| Value (V) | $m \times d_v$ | å€¼å‘é‡ï¼Œå®é™…æºå¸¦ä¿¡æ¯ |

| è¾“å‡º | ç»´åº¦ | å«ä¹‰ |
| --- | --- | --- |
| Attention Output | $n \times d_v$ | æ¯ä¸ª query èšåˆäº†æ‰€æœ‰ value çš„åŠ æƒä¿¡æ¯ |



## å››ã€å¦‚ä½•ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹è§’åº¦ç†è§£ï¼š

### âœ… 1. **ä¿¡æ¯èåˆæœºåˆ¶**
- æ¯ä¸ª Query éƒ½æ˜¯åœ¨å¯»æ‰¾æœ€ç›¸å…³çš„ Keyã€‚
- æ ¹æ®ç›¸å…³æ€§ï¼ˆæ³¨æ„åŠ›æƒé‡ï¼‰ï¼Œä»å¯¹åº”çš„ Value ä¸­æå–ä¿¡æ¯ã€‚
- æœ€ç»ˆæ¯ä¸ª Query å¾—åˆ°ä¸€ä¸ªèåˆäº†ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å‘é‡ã€‚

### âœ… 2. **ç»´åº¦è®¾è®¡çš„çµæ´»æ€§**
- $d_k$æ§åˆ¶äº†ç›¸ä¼¼åº¦è®¡ç®—çš„ç»´åº¦ï¼Œå½±å“æ¨¡å‹å®¹é‡å’Œæ¢¯åº¦ç¨³å®šæ€§ã€‚
- $d_v$å†³å®šäº†è¾“å‡ºçš„ä¿¡æ¯ç»´åº¦ï¼Œå¯ä»¥ç‹¬ç«‹äº$d_k$è®¾è®¡ã€‚
- è¿™ç§åˆ†ç¦»çš„è®¾è®¡è®©æ¨¡å‹æ›´çµæ´»ï¼Œæ¯”å¦‚å¤šå¤´æ³¨æ„åŠ›ä¸­å¯ä»¥åˆ†åˆ«æ§åˆ¶æ¯ä¸ª head çš„è¡¨è¾¾èƒ½åŠ›ã€‚

### âœ… 3. **å¯ç±»æ¯”ä¸ºâ€œè½¯æ£€ç´¢â€ç³»ç»Ÿ**
- ç±»ä¼¼æ•°æ®åº“æŸ¥è¯¢ï¼š
  - Query æ˜¯ä½ è¾“å…¥çš„é—®é¢˜ï¼›
  - Key æ˜¯æ•°æ®åº“ä¸­çš„ç´¢å¼•ï¼›
  - Value æ˜¯æ•°æ®åº“ä¸­çš„å†…å®¹ï¼›
  - Attention å°±æ˜¯æ ¹æ®é—®é¢˜æ‰¾åˆ°ç›¸å…³å†…å®¹å¹¶è¿”å›ã€‚



## äº”ã€ä¾‹å­è¯´æ˜ï¼ˆä»¥ Transformer ä¸ºä¾‹ï¼‰

å‡è®¾æˆ‘ä»¬åœ¨ Transformer ä¸­ï¼š

- è¾“å…¥æ˜¯ä¸€ä¸ª batch of sequencesï¼Œshape ä¸º$B \times T \times D$
- æˆ‘ä»¬é€šè¿‡çº¿æ€§å˜æ¢å¾—åˆ°ï¼š
  - $Q = XW_Q \in \mathbb{R}^{B \times T \times d_k}$
  - $K = XW_K \in \mathbb{R}^{B \times T \times d_k}$
  - $V = XW_V \in \mathbb{R}^{B \times T \times d_v}$

é‚£ä¹ˆæœ€ç»ˆè¾“å‡ºä¸ºï¼š

$$
\text{Output} \in \mathbb{R}^{B \times T \times d_v}
$$

> å¦‚æœä½¿ç”¨å¤šå¤´æ³¨æ„åŠ›ï¼ˆMulti-head Attentionï¼‰ï¼Œæˆ‘ä»¬ä¼šæ‹¼æ¥å¤šä¸ªè¿™æ ·çš„å¤´ï¼Œæœ€åå†ç»è¿‡ä¸€ä¸ªçº¿æ€§å±‚æ˜ å°„å›åŸå§‹ç»´åº¦$D$ã€‚



## å…­ã€å¸¸è§ç–‘é—®è§£ç­”

### â“Q: ä¸ºä»€ä¹ˆ$d_k$å’Œ$d_v$å¯ä»¥ä¸åŒï¼Ÿ
> å› ä¸ºå®ƒä»¬çš„ä½œç”¨ä¸åŒï¼š  
> - $d_k$æ˜¯ç”¨äºè®¡ç®—ç›¸ä¼¼åº¦çš„ç»´åº¦ï¼›
> - $d_v$æ˜¯ç”¨äºä¿¡æ¯è¡¨è¾¾çš„ç»´åº¦ï¼›  
> 
> ä¸¤è€…è§£è€¦å¯ä»¥è®©æ¨¡å‹æ›´çµæ´»åœ°åˆ†é…èµ„æºã€‚

### â“Q: ä¸ºä»€ä¹ˆè¦é™¤ä»¥$\sqrt{d_k}$ï¼Ÿ
> é˜²æ­¢å†…ç§¯è¿‡å¤§å¯¼è‡´ softmax æ¢¯åº¦æ¶ˆå¤±ã€‚  
> å½“$d_k$è¾ƒå¤§æ—¶ï¼ŒQK^T çš„æ•°å€¼ä¼šå¾ˆå¤§ï¼Œé™¤ä»¥$\sqrt{d_k}$å¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚



## ä¸ƒã€å¯è§†åŒ–ç¤ºæ„

```
Q: [n x dk]     K: [m x dk]     V: [m x dv]
       â†“              â†“               â†“
   Q @ K.T â†’ [n x m]                â†“
       â†“                            â†“
   softmax â†’ [n x m]         V â†’ [m x dv]
       â†“__________________________â†“
                     â†“
                 Output â†’ [n x dv]
```

